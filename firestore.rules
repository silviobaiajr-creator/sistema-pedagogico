rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES DE SEGURANÇA --- //

    // 1. Verifica se está logado
    function isSignedIn() {
      return request.auth != null;
    }

    // 2. Verifica se é o Super Admin (Você)
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.email == 'silviobaiajr@gmail.com';
    }

    // 3. Verifica se é um Admin Secundário (Diretores/Coordenação)
    // Lê a lista de emails salva na configuração do banco
    function isSecondaryAdmin() {
      let config = get(/databases/$(database)/documents/artifacts/default-app-id/public/data/school-data/config).data;
      return isSignedIn() && (request.auth.token.email in config.adminEmails);
    }

    // 4. Combina os dois tipos de Admin
    function isAdmin() {
      return isSuperAdmin() || isSecondaryAdmin();
    }

    // --- REGRAS DE ACESSO --- //
    
    // Caminho base da sua aplicação (conforme firestore.js)
    match /artifacts/{appId}/public/data {

      // A. Configurações da Escola
      match /school-data/config {
        allow read: if isSignedIn(); // Todos podem ler (para ver o logo)
        allow write: if isAdmin();   // Apenas Admins podem mudar o nome da escola
      }

      // B. Coleção de Alunos
      match /students/{studentId} {
        allow read: if isSignedIn();  // Todos leem
        allow create, update: if isSignedIn(); // Todos editam
        allow delete: if isAdmin();   // APENAS ADMIN DELETA
      }

      // C. Ocorrências (Ouro da escola)
      match /occurrences/{document=**} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn();
        allow delete: if isAdmin();   // APENAS ADMIN DELETA
      }

      // D. Busca Ativa
      match /absences/{document=**} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn();
        allow delete: if isAdmin();   // APENAS ADMIN DELETA
      }

      // E. Contadores (Técnico)
      match /counters/{document=**} {
        allow read, write: if isSignedIn(); // Necessário para gerar IDs
      }
      
      // F. (Legado) Caminho antigo de alunos
      match /school-data/students {
        allow read, write: if isSignedIn();
      }
    }

    // --- BLOQUEIO TOTAL --- //
    // Qualquer coisa fora do seu app é proibida
    match /{document=**} {
      allow read, write: if false;
    }
  }
}