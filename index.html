<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Acompanhamento Pedagógico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .dynamic-field-group {
            border-left: 2px solid #e5e7eb;
            padding-left: 1rem;
            margin-top: 1rem;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .autocomplete-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            width: 100%;
        }
        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #eef2ff;
        }
        .signature-block {
            display: none;
        }
        .process-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        @media print {
            body > div:not(.printable-area) {
                display: none;
            }
            .printable-area, .printable-area .modal-content {
                display: block !important;
                position: static !important;
                width: 100%;
                height: auto;
                max-height: none;
                box-shadow: none;
                border: none;
                transform: none !important;
                background-color: white !important;
            }
            .printable-area .overflow-y-auto {
                overflow: visible !important;
            }
            .no-print {
                display: none !important;
            }
            .signature-block {
                display: block !important;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Ecrã de Login -->
    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="login-view">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Entrar</h1>
                    <p class="text-gray-500 mb-8 text-center">Aceda à sua conta para continuar.</p>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Entrar</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        Não tem uma conta? <button id="show-register-view" class="font-semibold text-indigo-600 hover:underline">Registe-se</button>
                    </p>
                </div>

                <div id="register-view" class="hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Criar Conta</h1>
                    <p class="text-gray-500 mb-8 text-center">Crie uma nova conta para usar o sistema.</p>
                    <form id="register-form" class="space-y-4">
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="register-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres)</label>
                            <input type="password" id="register-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Criar Conta</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        Já tem uma conta? <button id="show-login-view" class="font-semibold text-indigo-600 hover:underline">Entrar</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação -->
    <div id="main-content" class="hidden">
        <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Cabeçalho -->
            <header class="mb-8 p-6 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg flex flex-col sm:flex-row justify-between sm:items-center gap-4 text-center sm:text-left">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold">Sistema de Acompanhamento Pedagógico</h1>
                    <p class="opacity-90 mt-1 text-sm sm:text-base">Base de dados partilhada entre todos os utilizadores.</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="manage-students-btn" class="bg-white/20 text-white font-bold py-2 px-3 rounded-lg shadow-md hover:bg-white/30 text-sm">
                        <i class="fas fa-users-cog mr-2"></i>Gerir Alunos
                    </button>
                    <div id="user-profile" class="flex items-center space-x-4 hidden self-center sm:self-auto">
                        <div class="text-right">
                            <p id="user-email" class="font-semibold text-sm"></p>
                            <button id="logout-btn" class="text-xs sm:text-sm text-indigo-200 hover:text-white transition">Sair</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Abas de Navegação -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-2 sm:space-x-6" aria-label="Tabs">
                    <button id="tab-occurrences" class="text-center flex-1 sm:flex-none whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Ocorrências
                    </button>
                    <button id="tab-absences" class="text-center flex-1 sm:flex-none whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-user-clock mr-2"></i>Busca Ativa
                    </button>
                </nav>
            </div>

            <!-- Conteúdo da Aba Ocorrências -->
            <div id="tab-content-occurrences">
                <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-center sm:justify-between items-center">
                    <h2 id="occurrences-title" class="text-xl sm:text-2xl font-semibold text-gray-700">Registros de Ocorrências</h2>
                </div>
                <div id="occurrence-filters" class="mb-6 bg-gray-50 p-4 rounded-lg border flex flex-wrap gap-4 items-center">
                    <h3 class="text-md font-semibold text-gray-700 w-full sm:w-auto">Filtrar por Período:</h3>
                    <div class="flex-1 min-w-[150px]">
                        <label for="occurrence-start-date" class="text-sm font-medium text-gray-600">De</label>
                        <input type="date" id="occurrence-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 text-sm">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="occurrence-end-date" class="text-sm font-medium text-gray-600">Até</label>
                        <input type="date" id="occurrence-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 text-sm">
                    </div>
                </div>
                <main class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-occurrences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar aluno para ver histórico ou registar nova ocorrência...">
                            <div id="occurrence-student-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                    </div>
                    <div id="loading-occurrences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">A carregar registos...</p>
                    </div>
                    <div id="empty-state-occurrences" class="text-center p-8 hidden">
                        <i class="fas fa-file-alt fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ocorrência registada</h3>
                        <p class="text-gray-500 mt-1">Use a busca acima para registar uma nova ocorrência.</p>
                    </div>
                    <div id="occurrences-list" class="space-y-4"></div>
                </main>
            </div>

            <!-- Conteúdo da Aba Busca Ativa -->
            <div id="tab-content-absences" class="hidden">
                <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-center sm:justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">Histórico de Ações da Busca Ativa</h2>
                </div>
                <div id="absence-filters" class="mb-6 bg-gray-50 p-4 rounded-lg border flex flex-wrap gap-4 items-center">
                    <h3 class="text-md font-semibold text-gray-700 w-full sm:w-auto">Filtros:</h3>
                    <div class="flex-1 min-w-[150px]">
                        <label for="filter-process-status" class="text-sm font-medium text-gray-600">Estado do Processo</label>
                        <select id="filter-process-status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <option value="all">Todos</option>
                            <option value="in_progress">Em Andamento</option>
                            <option value="concluded">Concluídos</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="filter-pending-action" class="text-sm font-medium text-gray-600">Ação Pendente</label>
                        <select id="filter-pending-action" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <option value="all">Todos</option>
                            <option value="pending_contact">Aguardando Contato</option>
                            <option value="pending_feedback">Aguardando Devolutiva CT</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="filter-return-status" class="text-sm font-medium text-gray-600">Retorno do Aluno</label>
                        <select id="filter-return-status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <option value="all">Todos</option>
                            <option value="returned">Retornou</option>
                            <option value="not_returned">Não Retornou</option>
                        </select>
                    </div>
                </div>
                <main class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-absences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar aluno para ver histórico ou registar nova ação...">
                            <div id="absence-student-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                    </div>
                    <div id="loading-absences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">A carregar registos...</p>
                    </div>
                    <div id="empty-state-absences" class="text-center p-8 hidden">
                        <i class="fas fa-folder-open fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ação de busca ativa registada</h3>
                        <p class="text-gray-500 mt-1">Use a busca acima para registar uma nova ação.</p>
                    </div>
                    <div id="absences-list" class="space-y-4"></div>
                </main>
            </div>
            
            <footer class="text-center text-sm text-gray-400 mt-8">
                <p>Desenvolvido para Gestão Pedagógica</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <!-- Modal de Ocorrência -->
    <div id="occurrence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold">Registar Nova Ocorrência</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="occurrence-form" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="occurrence-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" required readonly>
                    </div>
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700">Turma</label>
                        <input type="text" id="student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly required>
                    </div>
                </div>
                 <div>
                    <label for="occurrence-type" class="block text-sm font-medium text-gray-700">Tipo de Ocorrência</label>
                    <select id="occurrence-type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Selecione um tipo...</option>
                        <option value="Agressão (Física)">Agressão (Física)</option>
                        <option value="Agressão (Verbal)">Agressão (Verbal)</option>
                        <option value="Indisciplina / Comportamento Inadequado">Indisciplina / Comportamento Inadequado</option>
                        <option value="Bullying">Bullying</option>
                        <option value="Dano ao Patrimônio">Dano ao Patrimônio</option>
                        <option value="Uso inadequado de telemóvel/eletrónicos">Uso inadequado de telemóvel/eletrónicos</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div>
                    <label for="occurrence-date" class="block text-sm font-medium text-gray-700">Data da Ocorrência</label>
                    <input type="date" id="occurrence-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição da Ocorrência</label>
                    <textarea id="description" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                </div>
                <div>
                    <label for="involved" class="block text-sm font-medium text-gray-700">Pessoas Envolvidas</label>
                    <input type="text" id="involved" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Outros alunos, professores...">
                </div>
                <div>
                    <label for="actions-taken-school" class="block text-sm font-medium text-gray-700">Providências da Escola</label>
                    <textarea id="actions-taken-school" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Conversa com o aluno, contato com os pais..."></textarea>
                </div>
                <div>
                    <label for="actions-taken-family" class="block text-sm font-medium text-gray-700">Providências da Família</label>
                    <textarea id="actions-taken-family" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Acompanhamento, diálogo..."></textarea>
                </div>
                <div class="pt-4 border-t">
                    <h4 class="text-md font-semibold text-gray-600">Convocação para Reunião (Opcional)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="meeting-date-occurrence" class="block text-sm font-medium text-gray-700">Data do Comparecimento</label>
                            <input type="date" id="meeting-date-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="meeting-time-occurrence" class="block text-sm font-medium text-gray-700">Horário do Comparecimento</label>
                            <input type="time" id="meeting-time-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Busca Ativa -->
    <div id="absence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0 max-h-[95vh] flex flex-col">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="absence-modal-title" class="text-xl font-semibold">Registar Ação de Busca Ativa</h3>
                <button id="close-absence-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="absence-form" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="absence-id">
                <input type="hidden" id="absence-process-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="absence-student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="absence-student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" required readonly>
                    </div>
                    <div>
                        <label for="absence-student-class" class="block text-sm font-medium text-gray-700">Ano/Ciclo</label>
                        <input type="text" id="absence-student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="absence-student-endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
                        <input type="text" id="absence-student-endereco" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="absence-student-contato" class="block text-sm font-medium text-gray-700">Contato</label>
                        <input type="text" id="absence-student-contato" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                </div>
                <div class="border rounded-md p-3 space-y-2 bg-gray-50">
                    <h5 class="text-sm font-semibold text-gray-600 px-2">Faltas apuradas no período de:</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="absence-start-date" class="block text-sm">Início</label><input type="date" id="absence-start-date" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label for="absence-end-date" class="block text-sm">Fim</label><input type="date" id="absence-end-date" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                    </div>
                    <div class="pt-2"><label for="absence-count" class="block text-sm">Nº de faltas</label><input type="number" id="absence-count" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                </div>
                <div>
                    <label for="action-type-display" class="block text-sm font-medium text-gray-700">Tipo de Ação</label>
                    <input type="text" id="action-type-display" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    <input type="hidden" id="action-type">
                </div>
                <div id="dynamic-fields-container" class="space-y-4">
                    <div id="group-tentativas" class="dynamic-field-group hidden space-y-4">
                        <fieldset class="border rounded-md p-3 space-y-2 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Data e horário para notificação</legend>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="meeting-date" class="block text-sm">Data do Comparecimento</label><input type="date" id="meeting-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label for="meeting-time" class="block text-sm">Horário do Comparecimento</label><input type="time" id="meeting-time" class="mt-1 w-full border-gray-300 rounded-md"></div>
                            </div>
                        </fieldset>

                        <fieldset id="family-contact-section" class="border rounded-md p-3 space-y-4 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Família na escola</legend>
                            <div>
                                <span class="block text-sm">Conseguiu contato?</span>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="contact-succeeded" value="yes"> Sim</label> 
                                    <label><input type="radio" name="contact-succeeded" value="no"> Não</label>
                                </div>
                            </div>
                            <div id="family-contact-fields" class="space-y-4">
                                <div><label class="block text-sm">Dia do contato:</label><input type="date" id="contact-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Com quem falou?</label><input type="text" id="contact-person" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Justificativa:</label><textarea id="contact-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                            </div>
                            <div>
                                <span class="block text-sm">O aluno retornou?</span>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="contact-returned" value="yes"> Sim</label> 
                                    <label><input type="radio" name="contact-returned" value="no"> Não</label>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div id="group-visita" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Nome do agente da visita:</label><input type="text" id="visit-agent" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Dia da visita:</label><input type="date" id="visit-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <fieldset id="visit-contact-section" class="border rounded-md p-3 space-y-4 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Detalhes do Contato</legend>
                            <div>
                                <span class="block text-sm">Conseguiu contato?</span>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="visit-succeeded" value="yes"> Sim</label> 
                                    <label><input type="radio" name="visit-succeeded" value="no"> Não</label>
                                </div>
                            </div>
                            <div id="visit-contact-fields" class="space-y-4">
                                <div><label class="block text-sm">Com quem falou?</label><input type="text" id="visit-contact-person" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Justificativa do responsável:</label><textarea id="visit-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                                <div><label class="block text-sm">Observações:</label><textarea id="visit-obs" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                            </div>
                            <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="visit-returned" value="yes"> Sim</label> <label><input type="radio" name="visit-returned" value="no"> Não</label></div></div>
                        </fieldset>
                    </div>
                    <div id="group-encaminhamento_ct" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Data do envio ao C.T.:</label><input type="date" id="ct-sent-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Devolutiva do C.T.:</label><textarea id="ct-feedback" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                        <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="ct-returned" value="yes"> Sim</label> <label><input type="radio" name="ct-returned" value="no"> Não</label></div></div>
                    </div>
                    <div id="group-analise" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Parecer da Busca Ativa Escolar (BAE):</label><textarea id="ct-parecer" rows="3" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3 bg-white sticky bottom-0 pb-6 -mx-6 px-6 border-t">
                    <button type="button" id="cancel-absence-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition duration-300">Salvar Ação</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Gestão de Alunos -->
    <div id="students-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-semibold">Gerir Lista de Alunos</h3>
                <button id="close-students-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6">
                <!-- Formulário para Adicionar/Editar Aluno -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h4 id="student-form-title" class="text-lg font-semibold mb-2">Adicionar Novo Aluno</h4>
                    <form id="student-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
                        <input type="hidden" id="student-id-input">
                        <div>
                            <label for="student-matricula-input" class="block text-sm font-medium text-gray-700">Matrícula</label>
                            <input type="text" id="student-matricula-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-name-input" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="student-name-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-class-input" class="block text-sm font-medium text-gray-700">Turma</label>
                            <input type="text" id="student-class-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-contato-input" class="block text-sm font-medium text-gray-700">Contato</label>
                            <input type="text" id="student-contato-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="student-endereco-input" class="block text-sm font-medium text-gray-700">Endereço</label>
                            <input type="text" id="student-endereco-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-resp1-input" class="block text-sm font-medium text-gray-700">Responsável 1</label>
                            <input type="text" id="student-resp1-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-resp2-input" class="block text-sm font-medium text-gray-700">Responsável 2</label>
                            <input type="text" id="student-resp2-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div class="flex space-x-2 sm:col-span-2 self-end">
                            <button type="submit" id="save-student-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Salvar</button>
                            <button type="button" id="cancel-edit-student-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 hidden">Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <!-- Lista de Alunos -->
                <div>
                    <h4 class="text-lg font-semibold mb-2">Alunos Registados</h4>
                    <div id="students-list-container" class="border rounded-lg overflow-hidden">
                        <div class="overflow-y-auto max-h-64">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Turma</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="students-list-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Alunos serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Importação CSV -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-semibold mb-2">Importar em Massa</h4>
                    <p class="text-sm text-gray-600">Carregue um ficheiro CSV com as colunas: `matricula`, `nome`, `turma`, `endereco`, `contato`, `resp1`, `resp2`. Isto **substituirá** a lista de alunos atual.</p>
                    <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <button type="button" id="upload-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 whitespace-nowrap">Carregar CSV</button>
                    </div>
                    <div id="csv-feedback" class="text-sm mt-2"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Notificação / Relatório / Ficha -->
    <div id="notification-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="notification-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="notification-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="notification-title" class="text-xl font-semibold">Notificação de Ocorrência</h3><button id="close-notification-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="notification-content" class="p-8 overflow-y-auto bg-white"></div><div id="notification-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="report-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="report-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="report-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="report-view-title" class="text-xl font-semibold">Relatório</h3><button id="close-report-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="report-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="report-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="report-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="report-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="ficha-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="ficha-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="ficha-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="ficha-view-title" class="text-xl font-semibold">Visualizar Documento</h3><button id="close-ficha-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="ficha-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="ficha-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="ficha-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="ficha-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    
    <!-- Modal Gerador de Relatório -->
    <div id="report-generator-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center"><h3 id="report-generator-title" class="text-xl font-semibold">Gerar Relatório por Aluno</h3><button id="close-report-generator-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div class="p-6 space-y-4"><div><label for="student-select" class="block text-sm font-medium text-gray-700">Selecione o Aluno(a)</label><select id="student-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"><option value="">Carregando...</option></select></div></div><div class="bg-gray-50 p-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" id="cancel-report-generator-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button><button type="button" id="create-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300">Gerar</button></div></div></div>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="p-6"><div class="text-center"><i class="fas fa-exclamation-triangle fa-3x text-red-500 mb-4"></i><h3 class="text-lg font-semibold text-gray-800">Confirmar Exclusão</h3><p id="delete-confirm-message" class="mt-2 text-sm text-gray-500">Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.</p></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg"><button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Excluir</button><button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></div></div>
    
    <!-- Notificação Toast -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 z-50"><p id="toast-message"></p></div>

    <!-- Firebase e Script da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp, query, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================================
        // MÓDULO DE CONFIGURAÇÃO
        // Armazena configurações estáticas da aplicação, como dados do Firebase e da escola.
        // ====================================================================================
        const config = {
            firebase: {
                apiKey: "AIzaSyCDWtwnD_3V9En9qEEYtlP_dpOTvt-P9ks",
                authDomain: "acompanhamento-vida-escolar.firebaseapp.com",
                projectId: "acompanhamento-vida-escolar",
                storageBucket: "acompanhamento-vida-escolar.appspot.com",
                messagingSenderId: "315669308837",
                appId: "1:315669308837:web:053497df9ceea4df5c4c9c"
            },
            school: {
                name: "EMEF. DILMA DOS SANTOS CARVALHO",
                city: "Cidade (Exemplo)"
            },
            actionDisplayTitles: {
                tentativa_1: "1ª Tentativa de Contato",
                tentativa_2: "2ª Tentativa de Contato",
                tentativa_3: "3ª Tentativa de Contato",
                visita: "Visita In Loco",
                encaminhamento_ct: "Encaminhamento ao Conselho Tutelar",
                analise: "Análise"
            }
        };

        // ====================================================================================
        // MÓDULO DE ESTADO (State)
        // Centraliza todos os dados dinâmicos da aplicação.
        // ====================================================================================
        const state = {
            students: [],
            occurrences: [],
            absences: [],
            filters: {
                occurrences: { search: '', startDate: null, endDate: null },
                absences: { search: '', processStatus: 'all', pendingAction: 'all', returnStatus: 'all' }
            },
            activeTab: 'occurrences',
            recordToDelete: null,
            firebase: {
                db: null,
                auth: null,
                userId: null,
                listeners: {
                    occurrences: null,
                    absences: null
                }
            }
        };

        // ====================================================================================
        // MÓDULO DOM
        // Referências para os elementos HTML para evitar múltiplas chamadas a getElementById.
        // ====================================================================================
        const dom = {
            // Ecrãs principais
            loginScreen: document.getElementById('login-screen'),
            mainContent: document.getElementById('main-content'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
            
            // Formulários
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            occurrenceForm: document.getElementById('occurrence-form'),
            absenceForm: document.getElementById('absence-form'),
            studentForm: document.getElementById('student-form'),

            // Botões e Interações de Utilizador
            showRegisterViewBtn: document.getElementById('show-register-view'),
            showLoginViewBtn: document.getElementById('show-login-view'),
            logoutBtn: document.getElementById('logout-btn'),
            
            // Perfil
            userProfile: document.getElementById('user-profile'),
            userEmail: document.getElementById('user-email'),
            
            // Abas (Tabs)
            tabOccurrences: document.getElementById('tab-occurrences'),
            tabAbsences: document.getElementById('tab-absences'),
            tabContentOccurrences: document.getElementById('tab-content-occurrences'),
            tabContentAbsences: document.getElementById('tab-content-absences'),

            // Listas e Estados
            occurrencesListDiv: document.getElementById('occurrences-list'),
            absencesListDiv: document.getElementById('absences-list'),
            emptyStateOccurrences: document.getElementById('empty-state-occurrences'),
            emptyStateAbsences: document.getElementById('empty-state-absences'),
            loadingOccurrences: document.getElementById('loading-occurrences'),
            loadingAbsences: document.getElementById('loading-absences'),
            occurrencesTitle: document.getElementById('occurrences-title'),

            // Pesquisa e Filtros
            searchOccurrences: document.getElementById('search-occurrences'),
            searchAbsences: document.getElementById('search-absences'),
            occurrenceStartDate: document.getElementById('occurrence-start-date'),
            occurrenceEndDate: document.getElementById('occurrence-end-date'),
            filterProcessStatus: document.getElementById('filter-process-status'),
            filterPendingAction: document.getElementById('filter-pending-action'),
            filterReturnStatus: document.getElementById('filter-return-status'),

            // Modals
            occurrenceModal: document.getElementById('occurrence-modal'),
            absenceModal: document.getElementById('absence-modal'),
            studentsModal: document.getElementById('students-modal'),
            notificationModalBackdrop: document.getElementById('notification-modal-backdrop'),
            reportViewModalBackdrop: document.getElementById('report-view-modal-backdrop'),
            fichaViewModalBackdrop: document.getElementById('ficha-view-modal-backdrop'),
            reportGeneratorModal: document.getElementById('report-generator-modal'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),

            // Conteúdo dos Modals
            notificationContent: document.getElementById('notification-content'),
            notificationTitle: document.getElementById('notification-title'),
            reportViewContent: document.getElementById('report-view-content'),
            reportViewTitle: document.getElementById('report-view-title'),
            fichaViewContent: document.getElementById('ficha-view-content'),
            fichaViewTitle: document.getElementById('ficha-view-title'),
            deleteConfirmMessage: document.getElementById('delete-confirm-message'),

            // Toast
            toastNotification: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message')
        };
        
        // ====================================================================================
        // MÓDULO DE UTILITÁRIOS (Utils)
        // Funções genéricas e reutilizáveis.
        // ====================================================================================
        const utils = {
            formatDate: (dateString) => dateString ? new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '',
            formatTime: (timeString) => timeString || '',
            formatText: (text) => text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'Não informado',
            formatPeriodo: (start, end) => {
                if (start && end) return `de ${utils.formatDate(start)} a ${utils.formatDate(end)}`;
                if (start) return `a partir de ${utils.formatDate(start)}`;
                if (end) return `até ${utils.formatDate(end)}`;
                return 'Não informado';
            },

            showToast: (message) => {
                dom.toastMessage.textContent = message;
                dom.toastNotification.classList.add('show');
                setTimeout(() => dom.toastNotification.classList.remove('show'), 3000);
            },

            openModal: (modalElement) => {
                modalElement.classList.remove('hidden');
                setTimeout(() => {
                    modalElement.classList.remove('opacity-0');
                    modalElement.firstElementChild.classList.remove('scale-95', 'opacity-0');
                }, 10);
            },

            closeModal: (modalElement) => {
                if (!modalElement) return;
                modalElement.classList.add('opacity-0');
                modalElement.firstElementChild.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modalElement.classList.add('hidden'), 300);
            },
            
            shareContent: async (title, text) => {
                // Implementação da função shareContent... (código original omitido por brevidade)
            }
        };

        // ====================================================================================
        // MÓDULO DE LÓGICA DE NEGÓCIO (Business Logic)
        // Funções que contêm a lógica específica da aplicação.
        // ====================================================================================
        const logic = {
            getStudentProcessInfo: (studentId) => {
                // Implementação da função getStudentProcessInfo... (código original omitido por brevidade)
            },

            determineNextActionForStudent: (studentId) => {
                // Implementação da função determineNextActionForStudent... (código original omitido por brevidade)
            }
        };

        // ====================================================================================
        // MÓDULO DE SERVIÇOS (Services)
        // Lida com a comunicação externa, como o Firebase.
        // ====================================================================================
        const services = {
            firebase: {
                init() {
                    const finalConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') 
                        ? JSON.parse(__firebase_config) 
                        : config.firebase;

                    if (Object.keys(finalConfig).length < 2) {
                        document.body.innerHTML = `<div class="p-8 text-center text-red-700 bg-red-100"><h1>Configuração Incompleta do Firebase</h1><p class="mt-2">A configuração do Firebase não foi encontrada no ambiente. A aplicação não pode ser iniciada.</p></div>`;
                        return false;
                    }

                    const app = initializeApp(finalConfig);
                    state.firebase.auth = getAuth(app);
                    state.firebase.db = getFirestore(app);
                    return true;
                },
                
                getStudentsDocRef: () => {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    return doc(state.firebase.db, `/artifacts/${appId}/public/data/school-data`, 'students');
                },

                getCollectionRef: (type) => {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const collectionName = type === 'occurrence' ? 'occurrences' : 'absences';
                    return collection(state.firebase.db, `/artifacts/${appId}/public/data/${collectionName}`);
                },

                addRecord: (type, data) => addDoc(services.firebase.getCollectionRef(type), { ...data, createdAt: serverTimestamp() }),
                updateRecord: (type, id, data) => setDoc(doc(services.firebase.getCollectionRef(type), id), data, { merge: true }),
                deleteRecord: (type, id) => deleteDoc(doc(services.firebase.getCollectionRef(type), id)),

                async setupListeners() {
                    // Implementação da função setupFirestoreListeners... (código original omitido por brevidade)
                },

                detachListeners() {
                    // Implementação da função detachFirestoreListeners... (código original omitido por brevidade)
                }
            }
        };

        // ====================================================================================
        // MÓDULO DE RENDERIZAÇÃO E UI (UI & Rendering)
        // Funções responsáveis por desenhar e atualizar a interface do utilizador.
        // ====================================================================================
        const ui = {
            renderOccurrences: () => {
                // Implementação da função renderOccurrences... (código original omitido por brevidade)
            },

            renderAbsences: () => {
                // Implementação da função renderAbsences... (código original omitido por brevidade)
            },

            renderStudentsList: () => {
                // Implementação da função renderStudentsList... (código original omitido por brevidade)
            },
            
            openNotificationModal: (id) => {
                 // Implementação da função openNotificationModal... (código original omitido por brevidade)
            },
            
            generateAndShowReport: (studentId) => {
                 // Implementação da função generateAndShowReport... (código original omitido por brevidade)
            },

            //... e outras funções de UI como openFichaViewModal, generateAndShowOficio, etc.
        };

        // ====================================================================================
        // MÓDULO PRINCIPAL DA APLICAÇÃO (App)
        // Orquestra a inicialização e o fluxo principal da aplicação.
        // ====================================================================================
        const app = {
            init() {
                if (!services.firebase.init()) return;

                this.setupAuthListener();
                this.setupEventListeners();
                
                ui.setupAutocomplete('search-occurrences', 'occurrence-student-suggestions', (student) => {
                    ui.openOccurrenceModalForStudent(student);
                }); 
                ui.setupAutocomplete('search-absences', 'absence-student-suggestions', (student) => {
                    handlers.handleNewAbsenceAction(student);
                });
            },

            setupAuthListener() {
                onAuthStateChanged(state.firebase.auth, async user => {
                    services.firebase.detachListeners();
                    if (user) {
                        state.firebase.userId = user.uid;
                        dom.userEmail.textContent = user.email || `Utilizador: ${user.uid.substring(0, 8)}`;
                        dom.loginScreen.classList.add('hidden');
                        dom.mainContent.classList.remove('hidden');
                        dom.userProfile.classList.remove('hidden');
                        await services.firebase.setupListeners();
                    } else {
                        state.firebase.userId = null;
                        Object.assign(state, { students: [], occurrences: [], absences: [] });
                        ui.render();
                        dom.mainContent.classList.add('hidden');
                        dom.userProfile.classList.add('hidden');
                        dom.loginScreen.classList.remove('hidden');
                    }
                });
            },
            
            setupEventListeners() {
                // Aqui entrariam todos os addEventListener que estavam na função setupEventListeners original
                // Exemplo:
                dom.loginForm.addEventListener('submit', handlers.handleLogin);
                dom.registerForm.addEventListener('submit', handlers.handleRegister);
                dom.logoutBtn.addEventListener('click', handlers.handleLogout);
                // ... e todos os outros
            }
        };

        // ====================================================================================
        // MÓDULO DE MANIPULADORES DE EVENTOS (Handlers)
        // Funções que são chamadas diretamente por eventos (cliques, submissões, etc.).
        // ====================================================================================
        const handlers = {
            handleLogin: async (e) => {
                e.preventDefault();
                const email = dom.loginForm.querySelector('#login-email').value;
                const password = dom.loginForm.querySelector('#login-password').value;
                try {
                    await signInWithEmailAndPassword(state.firebase.auth, email, password);
                } catch (error) {
                    console.error("Erro ao entrar:", error.code);
                    utils.showToast("Email ou senha inválidos.");
                }
            },

            handleRegister: async (e) => {
                // Implementação do handleRegister...
            },

            handleLogout: async () => {
                // Implementação do handleLogout...
            },
            
            handleOccurrenceSubmit: async (e) => {
                // Implementação do handleOccurrenceSubmit...
            },
            
            handleNewAbsenceAction: (student) => {
                // Implementação da função handleNewAbsenceAction...
            }
            // ... e todos os outros handlers de eventos
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
