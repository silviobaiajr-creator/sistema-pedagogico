<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Acompanhamento Pedagógico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .dynamic-field-group {
            border-left: 2px solid #e5e7eb;
            padding-left: 1rem;
            margin-top: 1rem;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .autocomplete-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            width: 100%;
        }
        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #eef2ff;
        }
        .signature-block {
            display: none;
        }
        .process-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        @media print {
            body > div:not(.printable-area) {
                display: none;
            }
            .printable-area, .printable-area .modal-content {
                display: block !important;
                position: static !important;
                width: 100%;
                height: auto;
                max-height: none;
                box-shadow: none;
                border: none;
                transform: none !important;
                background-color: white !important;
            }
            .printable-area .overflow-y-auto {
                overflow: visible !important;
            }
            .no-print {
                display: none !important;
            }
            .signature-block {
                display: block !important;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="login-view">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Entrar</h1>
                    <p class="text-gray-500 mb-8 text-center">Aceda à sua conta para continuar.</p>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Entrar</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        Não tem uma conta? <button id="show-register-view" class="font-semibold text-indigo-600 hover:underline">Registe-se</button>
                    </p>
                </div>

                <div id="register-view" class="hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Criar Conta</h1>
                    <p class="text-gray-500 mb-8 text-center">Crie uma nova conta para usar o sistema.</p>
                    <form id="register-form" class="space-y-4">
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="register-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres)</label>
                            <input type="password" id="register-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Criar Conta</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        Já tem uma conta? <button id="show-login-view" class="font-semibold text-indigo-600 hover:underline">Entrar</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Cabeçalho -->
            <header class="mb-8 p-6 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg flex flex-col sm:flex-row justify-between sm:items-center gap-4 text-center sm:text-left">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold">Sistema de Acompanhamento Pedagógico</h1>
                    <p class="opacity-90 mt-1 text-sm sm:text-base">Base de dados partilhada entre todos os utilizadores.</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="manage-students-btn" class="bg-white/20 text-white font-bold py-2 px-3 rounded-lg shadow-md hover:bg-white/30 text-sm">
                        <i class="fas fa-users-cog mr-2"></i>Gerir Alunos
                    </button>
                    <div id="user-profile" class="flex items-center space-x-4 hidden self-center sm:self-auto">
                        <div class="text-right">
                            <p id="user-email" class="font-semibold text-sm"></p>
                            <button id="logout-btn" class="text-xs sm:text-sm text-indigo-200 hover:text-white transition">Sair</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Abas de Navegação -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-2 sm:space-x-6" aria-label="Tabs">
                    <button id="tab-occurrences" class="text-center flex-1 sm:flex-none whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Ocorrências
                    </button>
                    <button id="tab-absences" class="text-center flex-1 sm:flex-none whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-user-clock mr-2"></i>Busca Ativa
                    </button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div id="tab-content-occurrences">
                <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-center sm:justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">Registros de Ocorrências</h2>
                    <div class="flex gap-2 sm:gap-4 flex-wrap justify-center">
                        <button id="generate-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 text-sm">
                            <i class="fas fa-file-invoice mr-2"></i>Relatório
                        </button>
                    </div>
                </div>
                <main class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-occurrences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar aluno para ver histórico ou registar nova ocorrência...">
                            <div id="occurrence-student-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                    </div>
                    <div id="loading-occurrences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">A carregar registos...</p>
                    </div>
                    <div id="empty-state-occurrences" class="text-center p-8 hidden">
                        <i class="fas fa-file-alt fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ocorrência registada</h3>
                        <p class="text-gray-500 mt-1">Use a busca acima para registar uma nova ocorrência.</p>
                    </div>
                    <div id="occurrences-list" class="overflow-x-auto"></div>
                </main>
            </div>

            <div id="tab-content-absences" class="hidden">
                <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-center sm:justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">Histórico de Ações da Busca Ativa</h2>
                </div>
                <main class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-absences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar aluno para ver histórico ou registar nova ação...">
                            <div id="absence-student-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                    </div>
                    <div id="loading-absences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">A carregar registos...</p>
                    </div>
                    <div id="empty-state-absences" class="text-center p-8 hidden">
                        <i class="fas fa-folder-open fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ação de busca ativa registada</h3>
                        <p class="text-gray-500 mt-1">Use a busca acima para registar uma nova ação.</p>
                    </div>
                    <div id="absences-list" class="space-y-4"></div>
                </main>
            </div>
            
            <footer class="text-center text-sm text-gray-400 mt-8">
                <p>Desenvolvido para Gestão Pedagógica</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="occurrence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold">Registar Nova Ocorrência</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="occurrence-form" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="occurrence-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" required readonly>
                    </div>
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700">Turma</label>
                        <input type="text" id="student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly required>
                    </div>
                </div>
                <div>
                    <label for="occurrence-date" class="block text-sm font-medium text-gray-700">Data da Ocorrência</label>
                    <input type="date" id="occurrence-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição da Ocorrência</label>
                    <textarea id="description" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                </div>
                <div>
                    <label for="involved" class="block text-sm font-medium text-gray-700">Pessoas Envolvidas</label>
                    <input type="text" id="involved" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Outros alunos, professores...">
                </div>
                <div>
                    <label for="actions-taken-school" class="block text-sm font-medium text-gray-700">Providências da Escola</label>
                    <textarea id="actions-taken-school" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Conversa com o aluno, contato com os pais..."></textarea>
                </div>
                <div>
                    <label for="actions-taken-family" class="block text-sm font-medium text-gray-700">Providências da Família</label>
                    <textarea id="actions-taken-family" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Acompanhamento, diálogo..."></textarea>
                </div>
                <div class="pt-4 border-t">
                    <h4 class="text-md font-semibold text-gray-600">Convocação para Reunião (Opcional)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="meeting-date-occurrence" class="block text-sm font-medium text-gray-700">Data do Comparecimento</label>
                            <input type="date" id="meeting-date-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="meeting-time-occurrence" class="block text-sm font-medium text-gray-700">Horário do Comparecimento</label>
                            <input type="time" id="meeting-time-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <div id="absence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0 max-h-[95vh] flex flex-col">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="absence-modal-title" class="text-xl font-semibold">Registar Ação de Busca Ativa</h3>
                <button id="close-absence-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="absence-form" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="absence-id">
                <input type="hidden" id="absence-process-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="absence-student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="absence-student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" required readonly>
                    </div>
                    <div>
                        <label for="absence-student-class" class="block text-sm font-medium text-gray-700">Ano/Ciclo</label>
                        <input type="text" id="absence-student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="absence-student-endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
                        <input type="text" id="absence-student-endereco" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="absence-student-contato" class="block text-sm font-medium text-gray-700">Contato</label>
                        <input type="text" id="absence-student-contato" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                </div>
                <div class="border rounded-md p-3 space-y-2 bg-gray-50">
                    <h5 class="text-sm font-semibold text-gray-600 px-2">Faltas apuradas no período de:</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="absence-start-date" class="block text-sm">Início</label><input type="date" id="absence-start-date" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label for="absence-end-date" class="block text-sm">Fim</label><input type="date" id="absence-end-date" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                    </div>
                    <div class="pt-2"><label for="absence-count" class="block text-sm">Nº de faltas</label><input type="number" id="absence-count" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                </div>
                <div>
                    <label for="action-type-display" class="block text-sm font-medium text-gray-700">Tipo de Ação</label>
                    <input type="text" id="action-type-display" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    <input type="hidden" id="action-type">
                </div>
                <div id="dynamic-fields-container" class="space-y-4">
                    <div id="group-tentativas" class="dynamic-field-group hidden space-y-4">
                        <fieldset class="border rounded-md p-3 space-y-2 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Data e horário para notificação</legend>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="meeting-date" class="block text-sm">Data do Comparecimento</label><input type="date" id="meeting-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label for="meeting-time" class="block text-sm">Horário do Comparecimento</label><input type="time" id="meeting-time" class="mt-1 w-full border-gray-300 rounded-md"></div>
                            </div>
                        </fieldset>

                        <fieldset id="family-contact-section" class="border rounded-md p-3 space-y-4 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Família na escola</legend>
                            <div>
                                <span class="block text-sm">Conseguiu contato?</span>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="contact-succeeded" value="yes"> Sim</label> 
                                    <label><input type="radio" name="contact-succeeded" value="no"> Não</label>
                                </div>
                            </div>
                            <div id="family-contact-fields" class="space-y-4">
                                <div><label class="block text-sm">Dia do contato:</label><input type="date" id="contact-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Com quem falou?</label><input type="text" id="contact-person" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Justificativa:</label><textarea id="contact-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                                <div>
                                    <span class="block text-sm">O aluno retornou?</span>
                                    <div class="mt-2 space-x-4">
                                        <label><input type="radio" name="contact-returned" value="yes"> Sim</label> 
                                        <label><input type="radio" name="contact-returned" value="no"> Não</label>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div id="group-visita" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Nome do agente da visita:</label><input type="text" id="visit-agent" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Dia da visita:</label><input type="date" id="visit-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <fieldset id="visit-contact-section" class="border rounded-md p-3 space-y-4 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Detalhes do Contato</legend>
                            <div>
                                <span class="block text-sm">Conseguiu contato?</span>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="visit-succeeded" value="yes"> Sim</label> 
                                    <label><input type="radio" name="visit-succeeded" value="no"> Não</label>
                                </div>
                            </div>
                            <div id="visit-contact-fields" class="space-y-4">
                                <div><label class="block text-sm">Com quem falou?</label><input type="text" id="visit-contact-person" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Justificativa do responsável:</label><textarea id="visit-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                                <div><label class="block text-sm">Observações:</label><textarea id="visit-obs" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                                <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="visit-returned" value="yes"> Sim</label> <label><input type="radio" name="visit-returned" value="no"> Não</label></div></div>
                            </div>
                        </fieldset>
                    </div>
                    <div id="group-encaminhamento_ct" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Data do envio ao C.T.:</label><input type="date" id="ct-sent-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Devolutiva do C.T.:</label><textarea id="ct-feedback" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                        <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="ct-returned" value="yes"> Sim</label> <label><input type="radio" name="ct-returned" value="no"> Não</label></div></div>
                    </div>
                    <div id="group-analise" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Parecer da Busca Ativa Escolar (BAE):</label><textarea id="ct-parecer" rows="3" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3 bg-white sticky bottom-0 pb-6 -mx-6 px-6 border-t">
                    <button type="button" id="cancel-absence-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition duration-300">Salvar Ação</button>
                </div>
            </form>
        </div>
    </div>
    <div id="students-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-semibold">Gerir Lista de Alunos</h3>
                <button id="close-students-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6">
                <!-- Formulário para Adicionar/Editar Aluno -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h4 id="student-form-title" class="text-lg font-semibold mb-2">Adicionar Novo Aluno</h4>
                    <form id="student-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
                        <input type="hidden" id="student-id-input">
                        <div>
                            <label for="student-matricula-input" class="block text-sm font-medium text-gray-700">Matrícula</label>
                            <input type="text" id="student-matricula-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-name-input" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="student-name-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-class-input" class="block text-sm font-medium text-gray-700">Turma</label>
                            <input type="text" id="student-class-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-contato-input" class="block text-sm font-medium text-gray-700">Contato</label>
                            <input type="text" id="student-contato-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="student-endereco-input" class="block text-sm font-medium text-gray-700">Endereço</label>
                            <input type="text" id="student-endereco-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-resp1-input" class="block text-sm font-medium text-gray-700">Responsável 1</label>
                            <input type="text" id="student-resp1-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-resp2-input" class="block text-sm font-medium text-gray-700">Responsável 2</label>
                            <input type="text" id="student-resp2-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div class="flex space-x-2 sm:col-span-2 self-end">
                            <button type="submit" id="save-student-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Salvar</button>
                            <button type="button" id="cancel-edit-student-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 hidden">Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <!-- Lista de Alunos -->
                <div>
                    <h4 class="text-lg font-semibold mb-2">Alunos Registados</h4>
                    <div id="students-list-container" class="border rounded-lg overflow-hidden">
                        <div class="overflow-y-auto max-h-64">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Turma</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="students-list-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Alunos serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Importação CSV -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-semibold mb-2">Importar em Massa</h4>
                    <p class="text-sm text-gray-600">Carregue um ficheiro CSV com as colunas: `matricula`, `nome`, `turma`, `endereco`, `contato`, `resp1`, `resp2`. Isto **substituirá** a lista de alunos atual.</p>
                    <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <button type="button" id="upload-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 whitespace-nowrap">Carregar CSV</button>
                    </div>
                    <div id="csv-feedback" class="text-sm mt-2"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="notification-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="notification-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="notification-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="notification-title" class="text-xl font-semibold">Notificação de Ocorrência</h3><button id="close-notification-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="notification-content" class="p-8 overflow-y-auto bg-white"></div><div id="notification-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="report-generator-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center"><h3 id="report-generator-title" class="text-xl font-semibold">Gerar Relatório por Aluno</h3><button id="close-report-generator-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div class="p-6 space-y-4"><div><label for="student-select" class="block text-sm font-medium text-gray-700">Selecione o Aluno(a)</label><select id="student-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"><option value="">Carregando...</option></select></div></div><div class="bg-gray-50 p-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" id="cancel-report-generator-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button><button type="button" id="create-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300">Gerar</button></div></div></div>
    <div id="report-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="report-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="report-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="report-view-title" class="text-xl font-semibold">Relatório</h3><button id="close-report-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="report-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="report-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="report-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="report-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="ficha-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="ficha-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="ficha-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="ficha-view-title" class="text-xl font-semibold">Visualizar Documento</h3><button id="close-ficha-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="ficha-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="ficha-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="ficha-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="ficha-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="p-6"><div class="text-center"><i class="fas fa-exclamation-triangle fa-3x text-red-500 mb-4"></i><h3 class="text-lg font-semibold text-gray-800">Confirmar Exclusão</h3><p id="delete-confirm-message" class="mt-2 text-sm text-gray-500">Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.</p></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg"><button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Excluir</button><button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></div></div>
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 z-50"><p id="toast-message"></p></div>

    <!-- Firebase and App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp, query, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ************************************************************************************
        // CONFIGURAÇÃO DO FIREBASE
        // ************************************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyCDWtwnD_3V9En9qEEYtlP_dpOTvt-P9ks",
            authDomain: "acompanhamento-vida-escolar.firebaseapp.com",
            projectId: "acompanhamento-vida-escolar",
            storageBucket: "acompanhamento-vida-escolar.appspot.com",
            messagingSenderId: "315669308837",
            appId: "1:315669308837:web:053497df9ceea4df5c4c9c"
        };
        // ************************************************************************************
        
        const config = {
            schoolName: "EMEF. DILMA DOS SANTOS CARVALHO",
            city: "Cidade (Exemplo)"
        };

        const state = {
            students: [],
            occurrences: [],
            absences: [],
            filterOccurrences: '',
            filterAbsences: '',
            activeTab: 'occurrences',
            recordToDelete: null,
            db: null,
            userId: null,
            unsubscribeOccurrences: null,
            unsubscribeAbsences: null
        };

        const dom = {
            loginScreen: document.getElementById('login-screen'),
            mainContent: document.getElementById('main-content'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
            showRegisterViewBtn: document.getElementById('show-register-view'),
            showLoginViewBtn: document.getElementById('show-login-view'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            logoutBtn: document.getElementById('logout-btn'),
            userProfile: document.getElementById('user-profile'),
            userEmail: document.getElementById('user-email'),
            occurrenceModal: document.getElementById('occurrence-modal'),
            absenceModal: document.getElementById('absence-modal'),
            studentsModal: document.getElementById('students-modal'),
            notificationModalBackdrop: document.getElementById('notification-modal-backdrop'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            reportGeneratorModal: document.getElementById('report-generator-modal'),
            reportViewModalBackdrop: document.getElementById('report-view-modal-backdrop'),
            fichaViewModalBackdrop: document.getElementById('ficha-view-modal-backdrop'),
            occurrencesListDiv: document.getElementById('occurrences-list'),
            absencesListDiv: document.getElementById('absences-list'),
            emptyStateOccurrences: document.getElementById('empty-state-occurrences'),
            emptyStateAbsences: document.getElementById('empty-state-absences'),
            loadingOccurrences: document.getElementById('loading-occurrences'),
            loadingAbsences: document.getElementById('loading-absences'),
            occurrenceForm: document.getElementById('occurrence-form'),
            absenceForm: document.getElementById('absence-form'),
            tabOccurrences: document.getElementById('tab-occurrences'),
            tabAbsences: document.getElementById('tab-absences'),
            tabContentOccurrences: document.getElementById('tab-content-occurrences'),
            tabContentAbsences: document.getElementById('tab-content-absences'),
            searchOccurrences: document.getElementById('search-occurrences'),
            searchAbsences: document.getElementById('search-absences'),
        };

        const actionDisplayTitles = {
            tentativa_1: "1ª Tentativa de Contato",
            tentativa_2: "2ª Tentativa de Contato",
            tentativa_3: "3ª Tentativa de Contato",
            visita: "Visita In Loco",
            encaminhamento_ct: "Encaminhamento ao Conselho Tutelar",
            analise: "Análise"
        };

        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
        const formatTime = (timeString) => timeString || '';
        const formatText = (text) => text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'Não informado';
        const formatPeriodo = (start, end) => {
            if (start && end) return `de ${formatDate(start)} a ${formatDate(end)}`;
            if (start) return `a partir de ${formatDate(start)}`;
            if (end) return `até ${formatDate(end)}`;
            return 'Não informado';
        }
        
        const showToast = (message) => {
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            document.getElementById('toast-notification').classList.add('show');
            setTimeout(() => document.getElementById('toast-notification').classList.remove('show'), 3000);
        };
        
        const openModal = (modalElement) => {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                modalElement.firstElementChild.classList.remove('scale-95', 'opacity-0');
            }, 10);
        };

        const closeModal = (modalElement) => {
            if (!modalElement) return;
            modalElement.classList.add('opacity-0');
            modalElement.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modalElement.classList.add('hidden'), 300);
        };

        const enhanceTextForSharing = (title, text) => {
            let enhancedText = text;

            if (title.toLowerCase().includes('ocorrência')) {
                enhancedText = `*📢 NOTIFICAÇÃO DE OCORRÊNCIA ESCOLAR 📢*\n\n${text}`;
            } else if (title.toLowerCase().includes('relatório')) {
                enhancedText = `*📋 RELATÓRIO DE OCORRÊNCIAS 📋*\n\n${text}`;
            } else if (title.toLowerCase().includes('ficha')) {
                enhancedText = `*📈 FICHA DE ACOMPANHAMENTO 📈*\n\n${text}`;
            }

            enhancedText = enhancedText.replace(/Aos Responsáveis/g, '👥 Aos Responsáveis');
            enhancedText = enhancedText.replace(/Aluno\(a\):/g, '👤 Aluno(a):');
            enhancedText = enhancedText.replace(/Turma:/g, '🏫 Turma:');
            enhancedText = enhancedText.replace(/Data:/g, '🗓️ Data:');
            enhancedText = enhancedText.replace(/Horário:/g, '⏰ Horário:');
            enhancedText = enhancedText.replace(/Descrição:/g, '📝 Descrição:');
            enhancedText = enhancedText.replace(/Providências da Escola:/g, '🏛️ Providências da Escola:');
            enhancedText = enhancedText.replace(/Providências da Família:/g, '👨‍👩‍👧‍👦 Providências da Família:');

            enhancedText += `\n\n-------------\n_Mensagem enviada pelo Sistema de Acompanhamento Pedagógico._`;

            return enhancedText;
        };
        
        const getStudentProcessInfo = (studentId) => {
            const studentActions = state.absences
                .filter(a => a.studentId === studentId)
                .sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

            let lastAnaliseIndex = -1;
            for (let i = studentActions.length - 1; i >= 0; i--) {
                if (studentActions[i].actionType === 'analise') {
                    lastAnaliseIndex = i;
                    break;
                }
            }
            
            const currentCycleActions = studentActions.slice(lastAnaliseIndex + 1);
            
            let processId;
            const existingProcessAction = currentCycleActions.find(a => a.processId);

            if (existingProcessAction) {
                processId = existingProcessAction.processId;
            } else {
                const allProcessIdsForStudent = state.absences.filter(a => a.studentId === studentId)
                    .map(a => a.processId)
                    .filter(Boolean);
                
                const processNumbers = allProcessIdsForStudent
                    .map(pid => parseInt(pid.split('-')[1] || 0, 10))
                    .filter(num => !isNaN(num));
                    
                const maxNumber = processNumbers.length > 0 ? Math.max(...processNumbers) : 0;
                processId = `${studentId}-${maxNumber + 1}`;
            }

            return {
                currentCycleActions,
                processId
            };
        };

        const determineNextActionForStudent = (studentId) => {
            const { currentCycleActions } = getStudentProcessInfo(studentId);
            const sequence = ['tentativa_1', 'tentativa_2', 'tentativa_3', 'visita', 'encaminhamento_ct', 'analise'];
            const existingActionTypes = new Set(currentCycleActions.map(a => a.actionType));

            const hasReturnedInCurrentCycle = currentCycleActions.some(
                a => a.contactReturned === 'yes' || a.visitReturned === 'yes' || a.ctReturned === 'yes'
            );

            if (hasReturnedInCurrentCycle && !existingActionTypes.has('analise')) {
                return 'analise';
            }

            for (const action of sequence) {
                if (!existingActionTypes.has(action)) {
                    return action;
                }
            }
            
            return 'analise'; // Fallback
        };

        const shareContent = async (title, text) => {
            const enhancedText = enhanceTextForSharing(title, text);
            if (navigator.share) {
                try {
                    await navigator.share({ title, text: enhancedText });
                } catch (error) {
                    console.error('Erro ao partilhar:', error);
                    showToast('Erro ao partilhar o conteúdo.');
                }
            } else {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(enhancedText)}`;
                window.open(whatsappUrl, '_blank');
            }
        };

        const renderOccurrences = () => {
            dom.loadingOccurrences.classList.add('hidden');
            const filtered = state.occurrences
                .filter(o => {
                    const student = state.students.find(s => s.matricula === o.studentId);
                    return student && student.name.toLowerCase().startsWith(state.filterOccurrences.toLowerCase());
                })
                .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            if (filtered.length === 0 && state.filterOccurrences === '') {
                dom.emptyStateOccurrences.classList.remove('hidden');
                dom.occurrencesListDiv.innerHTML = '';
            } else {
                dom.emptyStateOccurrences.classList.add('hidden');
                dom.occurrencesListDiv.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno(a)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Turma</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filtered.map(occ => {
                                const student = state.students.find(s => s.matricula === occ.studentId);
                                const studentName = student ? student.name : 'Aluno Removido';
                                const studentClass = student ? student.class : 'N/A';
                                return `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${studentName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${studentClass}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(occ.date)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <button class="view-btn text-indigo-600 hover:text-indigo-900" data-id="${occ.id}" title="Ver Notificação"><i class="fas fa-eye"></i></button>
                                        <button class="edit-btn text-yellow-600 hover:text-yellow-900" data-id="${occ.id}" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-btn text-red-600 hover:text-red-900" data-id="${occ.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>`;
            }
        };

        const renderAbsences = () => {
            dom.loadingAbsences.classList.add('hidden');
            const filtered = state.absences
                .filter(a => {
                    const student = state.students.find(s => s.matricula === a.studentId);
                    return student && student.name.toLowerCase().startsWith(state.filterAbsences.toLowerCase());
                });

            if (filtered.length === 0 && state.filterAbsences === '') {
                dom.emptyStateAbsences.classList.remove('hidden');
                dom.absencesListDiv.innerHTML = '';
            } else {
                dom.emptyStateAbsences.classList.add('hidden');
                
                const groupedByProcess = filtered.reduce((acc, action) => {
                    const key = action.processId || `no-proc-${action.id}`; 
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(action);
                    return acc;
                }, {});

                const sortedGroupKeys = Object.keys(groupedByProcess).sort((a, b) => {
                    const lastActionA = groupedByProcess[a].sort((x, y) => (y.createdAt?.seconds || 0) - (x.createdAt?.seconds || 0))[0];
                    const lastActionB = groupedByProcess[b].sort((x, y) => (y.createdAt?.seconds || 0) - (x.createdAt?.seconds || 0))[0];
                    return (lastActionB.createdAt?.seconds || 0) - (lastActionA.createdAt?.seconds || 0);
                });

                let html = '';
                for (const processId of sortedGroupKeys) {
                    const actions = groupedByProcess[processId].sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    const firstAction = actions[0];
                    const student = state.students.find(s => s.matricula === firstAction.studentId);
                    if (!student) continue;

                    html += `
                        <div class="border rounded-lg overflow-hidden mb-4 bg-white shadow">
                            <div class="process-header bg-gray-50 hover:bg-gray-100 cursor-pointer p-4 flex justify-between items-center" data-process-id="${processId}">
                                <div>
                                    <p class="font-semibold text-gray-800">${student.name}</p>
                                    <p class="text-sm text-gray-500">ID do Processo: ${processId} - Início: ${formatDate(firstAction.createdAt?.toDate())}</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <button class="generate-ficha-btn-row bg-purple-600 text-white font-bold py-1 px-3 rounded-lg shadow-md hover:bg-purple-700 text-xs no-print" data-student-id="${student.matricula}" data-process-id="${processId}">
                                        <i class="fas fa-file-invoice"></i> Ficha
                                    </button>
                                    <i class="fas fa-chevron-down transition-transform duration-300"></i>
                                </div>
                            </div>
                            <div class="process-content" id="content-${processId}">
                                <div class="p-4 border-t border-gray-200">
                                    <div class="space-y-4">
                `;
                
                    actions.forEach(abs => {
                        const actionDate = abs.contactDate || abs.visitDate || abs.ctSentDate || (abs.createdAt?.toDate() ? abs.createdAt.toDate().toISOString().split('T')[0] : '');
                        const returned = abs.contactReturned === 'yes' || abs.visitReturned === 'yes' || abs.ctReturned === 'yes';
                        
                        let actionButtonHtml = '';
                        if (abs.actionType.startsWith('tentativa')) {
                            actionButtonHtml = `<button class="notification-btn text-indigo-600 hover:text-indigo-900 text-xs font-semibold py-1 px-2 rounded-md bg-indigo-50" data-id="${abs.id}" title="Gerar Notificação">Notificação</button>`;
                        } else if (abs.actionType === 'visita') {
                            actionButtonHtml = `<button class="send-ct-btn text-blue-600 hover:text-blue-900 text-xs font-semibold py-1 px-2 rounded-md bg-blue-50" data-id="${abs.id}" title="Enviar ao Conselho Tutelar">Enviar ao C.T.</button>`;
                        } else {
                            actionButtonHtml = `<span class="inline-block w-24"></span>`; // Placeholder for alignment
                        }

                        html += `
                            <div class="flex justify-between items-start border-b last:border-b-0 pb-3">
                                <div>
                                    <p class="font-medium text-gray-700">${actionDisplayTitles[abs.actionType] || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">Data: ${formatDate(actionDate)}</p>
                                    ${returned ? '<p class="text-sm text-green-600 font-semibold mt-1"><i class="fas fa-check-circle"></i> Aluno Retornou</p>' : ''}
                                </div>
                                <div class="whitespace-nowrap text-right text-sm font-medium space-x-2 flex items-center">
                                    ${actionButtonHtml}
                                    <button class="edit-absence-btn text-yellow-600 hover:text-yellow-900" data-id="${abs.id}" title="Editar Ação"><i class="fas fa-pencil-alt fa-lg"></i></button>
                                    <button class="delete-absence-btn text-red-600 hover:text-red-900" data-id="${abs.id}" title="Excluir Ação"><i class="fas fa-trash fa-lg"></i></button>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                dom.absencesListDiv.innerHTML = html;
            }
        };

        const render = () => {
            if (state.activeTab === 'occurrences') renderOccurrences();
            else renderAbsences();
        };

        const getStudentsDocRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return doc(state.db, `/artifacts/${appId}/public/data/school-data`, 'students');
        };

        const getCollectionRef = (type) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionName = type === 'occurrence' ? 'occurrences' : 'absences';
            return collection(state.db, `/artifacts/${appId}/public/data/${collectionName}`);
        };
        const addRecord = (type, data) => addDoc(getCollectionRef(type), { ...data, createdAt: serverTimestamp() });
        const updateRecord = (type, id, data) => setDoc(doc(getCollectionRef(type), id), data, { merge: true });
        const deleteRecord = (type, id) => deleteDoc(doc(getCollectionRef(type), id));

        const setupFirestoreListeners = async () => {
            if (!state.userId) return;

            try {
                const docSnap = await getDoc(getStudentsDocRef());
                if (docSnap.exists() && docSnap.data().list) {
                    state.students = docSnap.data().list;
                    renderStudentsList();
                } else {
                    console.log("Nenhuma lista de alunos encontrada no Firestore.");
                }
            } catch (error) {
                console.error("Erro ao carregar lista de alunos:", error);
                showToast("Erro ao carregar a lista de alunos.");
            }

            if (state.unsubscribeOccurrences) state.unsubscribeOccurrences();
            state.unsubscribeOccurrences = onSnapshot(query(getCollectionRef('occurrence')), (snapshot) => {
                state.occurrences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'occurrences') render();
            }, (error) => console.error("Erro ao buscar ocorrências:", error));

            if (state.unsubscribeAbsences) state.unsubscribeAbsences();
            state.unsubscribeAbsences = onSnapshot(query(getCollectionRef('absence')), (snapshot) => {
                state.absences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'absences') render();
            }, (error) => console.error("Erro ao buscar ações:", error));
        };

        const detachFirestoreListeners = () => {
            if (state.unsubscribeOccurrences) {
                state.unsubscribeOccurrences();
                state.unsubscribeOccurrences = null;
            }
            if (state.unsubscribeAbsences) {
                state.unsubscribeAbsences();
                state.unsubscribeAbsences = null;
            }
        };

        const openNotificationModal = (id) => {
            const data = state.occurrences.find(occ => occ.id === id);
            if (data) {
                const student = state.students.find(s => s.matricula === data.studentId) || {name: 'Aluno Removido', class: 'N/A', resp1: '', resp2: ''};
                document.getElementById('notification-title').innerText = 'Notificação de Ocorrência Escolar';
                const responsaveis = [student.resp1, student.resp2].filter(Boolean).join(' e ');
                document.getElementById('notification-content').innerHTML = `
                    <div class="space-y-6 text-sm"><div class="text-center border-b pb-4"><h2 class="text-xl font-bold uppercase">${config.schoolName}</h2><h3 class="text-lg font-semibold mt-2">NOTIFICAÇÃO DE OCORRÊNCIA ESCOLAR</h3></div>
                    <div class="pt-4"><p class="mb-2"><strong>Aos Responsáveis (${responsaveis}) pelo(a) aluno(a):</strong></p><p class="text-lg font-semibold">${formatText(student.name)}</p><p class="text-gray-600"><strong>Turma:</strong> ${formatText(student.class)}</p></div>
                    <p class="text-justify">Prezados(as), vimos por meio desta notificá-los sobre uma ocorrência disciplinar envolvendo o(a) aluno(a) supracitado(a), registrada em <strong>${formatDate(data.date)}</strong>.</p>
                    <div class="border-t pt-4 space-y-4">
                        <div><h4 class="font-semibold mb-1">Descrição:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.description)}</p></div>
                        <div><h4 class="font-semibold mb-1">Pessoas Envolvidas:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.involved)}</p></div>
                        <div><h4 class="font-semibold mb-1">Providências da Escola:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.actionsTakenSchool)}</p></div>
                        <div><h4 class="font-semibold mb-1">Providências da Família:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.actionsTakenFamily)}</p></div>
                    </div>
                    <p class="mt-4 text-justify">Diante do exposto, solicitamos o comparecimento de um responsável na coordenação pedagógica para uma reunião na seguinte data e horário:</p>
                    <div class="mt-4 p-3 bg-indigo-100 text-indigo-800 rounded-md text-center font-semibold"><p><strong>Data:</strong> ${formatDate(data.meetingDate) || 'A ser agendada'}</p><p><strong>Horário:</strong> ${formatTime(data.meetingTime) || ''}</p></div>
                    <div class="border-t pt-16 mt-16"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="text-center mt-1">Ciente do Responsável</p></div></div></div>`;
                openModal(dom.notificationModalBackdrop);
            }
        };
        
        const openFichaViewModal = (id) => {
            const record = state.absences.find(abs => abs.id === id);
            if (!record) return showToast('Registro não encontrado.');
            const student = state.students.find(s => s.matricula === record.studentId) || {name: 'Aluno Removido', class: 'N/A'};
            
            const attemptLabels = { tentativa_1: "primeira", tentativa_2: "segunda", tentativa_3: "terceira" };
            const title = actionDisplayTitles[record.actionType] || 'Notificação de Busca Ativa';
            
            let body = '';
            switch (record.actionType) {
                case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                    body = `<p class="mt-4 text-justify">Vimos por meio desta notificá-los que o(a) estudante acumulou <strong>${formatText(record.absenceCount)} faltas</strong> no período ${formatPeriodo(record.periodoFaltasStart, record.periodoFaltasEnd)}.</p><p class="mt-4 text-justify">Esta é a <strong>${attemptLabels[record.actionType]} tentativa de contato</strong>. Solicitamos o comparecimento de um responsável na data e horário abaixo:</p><div class="mt-4 p-3 bg-gray-100 rounded-md text-center"><p><strong>Data:</strong> ${formatDate(record.meetingDate)}</p><p><strong>Horário:</strong> ${formatTime(record.meetingTime)}</p></div>`;
                    break;
                case 'visita':
                    body = `<p class="mt-4">Notificamos que na data de <strong>${formatDate(record.visitDate)}</strong>, o agente escolar <strong>${formatText(record.visitAgent)}</strong> realizou uma visita domiciliar.</p><p class="mt-2"><strong>Justificativa do responsável:</strong> ${formatText(record.visitReason)}</p>`;
                    break;
                default: body = `<p class="mt-4">Registro de ação administrativa referente à busca ativa do(a) aluno(a).</p>`; break;
            }

            const contentHTML = `<div class="space-y-6 text-sm text-gray-800"><div class="text-center border-b pb-4"><h2 class="text-lg font-bold uppercase">${config.schoolName}</h2><h3 class="font-semibold mt-1 uppercase">${title}</h3></div><div class="pt-4"><p><strong>Aluno(a):</strong> ${student.name}</p><p><strong>Turma:</strong> ${student.class || ''}</p></div><div class="text-justify">${body}</div><div class="border-t pt-16 mt-16"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="text-center mt-1">Ciente do Responsável</p></div></div></div>`;

            document.getElementById('ficha-view-title').textContent = title;
            document.getElementById('ficha-view-content').innerHTML = contentHTML;
            openModal(dom.fichaViewModalBackdrop);
        };
        
        const openReportGeneratorModal = (reportType) => {
            const records = reportType === 'occurrences' ? state.occurrences : state.absences;
            const studentIds = [...new Set(records.map(item => item.studentId))];
            const studentsInRecords = state.students.filter(s => studentIds.includes(s.matricula)).sort((a,b) => a.name.localeCompare(b.name));

            const select = document.getElementById('student-select');
            
            const title = reportType === 'occurrences' ? 'Gerar Relatório de Ocorrências' : 'Gerar Ficha Consolidada';
            document.getElementById('report-generator-title').textContent = title;
            dom.reportGeneratorModal.dataset.reportType = reportType;
            
            select.innerHTML = studentsInRecords.length > 0
                ? '<option value="">Selecione um aluno...</option>' + studentsInRecords.map(s => `<option value="${s.matricula}">${s.name}</option>`).join('')
                : '<option value="">Nenhum aluno com registros</option>';
            openModal(dom.reportGeneratorModal);
        };
        
        const generateAndShowOficio = (action, oficioNumber) => {
            if (!action) return showToast('Ação de origem não encontrada.');
            
            const student = state.students.find(s => s.matricula === action.studentId);
            if (!student) return showToast('Aluno não encontrado.');

            // Get all actions for this specific process
            const processActions = state.absences
                .filter(a => a.processId === action.processId)
                .sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

            if (processActions.length === 0) return showToast('Nenhuma ação encontrada para este processo.');

            // Extract data from the process actions
            const firstActionWithAbsenceData = processActions.find(a => a.periodoFaltasStart);
            const visitAction = processActions.find(a => a.actionType === 'visita');
            const contactAttempts = processActions.filter(a => a.actionType.startsWith('tentativa'));
            
            const currentDate = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            const responsaveis = [student.resp1, student.resp2].filter(Boolean).join(' e ');

            let attemptsSummary = contactAttempts.map((attempt, index) => {
                return `
                    <p class="ml-4">- <strong>${index + 1}ª Tentativa (${formatDate(attempt.contactDate || attempt.createdAt?.toDate())}):</strong> 
                    ${attempt.contactSucceeded === 'yes' 
                        ? `Contato realizado com ${formatText(attempt.contactPerson)}. Justificativa: ${formatText(attempt.contactReason)}.` 
                        : 'Não foi possível estabelecer contato.'}
                    </p>
                `;
            }).join('');
            if (!attemptsSummary) attemptsSummary = "<p class='ml-4'>Nenhuma tentativa de contato registrada.</p>";

            const oficioHTML = `
                <div class="space-y-6 text-sm text-gray-800" style="font-family: 'Times New Roman', serif; line-height: 1.5;">
                    <div class="text-center">
                        <p class="font-bold uppercase">${config.schoolName}</p>
                        <p>${config.city}, ${currentDate}.</p>
                    </div>

                    <div class="mt-8">
                        <p class="font-bold text-base">OFÍCIO Nº ${String(oficioNumber).padStart(3, '0')}/${new Date().getFullYear()}</p>
                    </div>

                    <div class="mt-8">
                        <p><strong>Ao</strong></p>
                        <p><strong>Conselho Tutelar</strong></p>
                        <p><strong>Nesta</strong></p>
                    </div>

                    <div class="mt-8">
                        <p><strong>Assunto:</strong> Encaminhamento de aluno infrequente.</p>
                    </div>

                    <div class="mt-8 text-justify">
                        <p class="indent-8">Prezados(as) Conselheiros(as),</p>
                        <p class="mt-4 indent-8">
                            Encaminhamos a V. Sa. o caso do(a) aluno(a) <strong>${student.name}</strong>,
                            regularmente matriculado(a) na turma <strong>${student.class}</strong> desta Unidade de Ensino,
                            filho(a) de <strong>${responsaveis}</strong>, residente no endereço: ${formatText(student.endereco)}.
                        </p>
                        <p class="mt-4 indent-8">
                            O(A) referido(a) aluno(a) apresenta um número de <strong>${firstActionWithAbsenceData?.absenceCount || '(não informado)'} faltas</strong>,
                            apuradas no período de ${formatPeriodo(firstActionWithAbsenceData?.periodoFaltasStart, firstActionWithAbsenceData?.periodoFaltasEnd)}.
                        </p>
                        <p class="mt-4 indent-8">
                            Informamos que a escola esgotou as tentativas de contato com a família, conforme descrito abaixo:
                        </p>
                        <div class="mt-2">${attemptsSummary}</div>
                        <p class="mt-4 indent-8">
                            Adicionalmente, foi realizada uma visita in loco em <strong>${formatDate(visitAction?.visitDate)}</strong> pelo agente escolar <strong>${formatText(visitAction?.visitAgent)}</strong>.
                            Durante a visita, ${visitAction?.visitSucceeded === 'yes' 
                                ? `foi possível conversar com ${formatText(visitAction?.visitContactPerson)}, que justificou a ausência devido a: ${formatText(visitAction?.visitReason)}.`
                                : 'não foi possível localizar ou contatar os responsáveis.'}
                        </p>
                        <p class="mt-4 indent-8">
                            Diante do exposto e considerando o que preceitua o Art. 56 do Estatuto da Criança e do Adolescente (ECA), solicitamos as devidas providências deste Conselho para garantir o direito à educação do(a) aluno(a).
                        </p>
                    </div>

                    <div class="mt-12 text-center">
                        <p>Atenciosamente,</p>
                    </div>
                    
                    <div class="signature-block pt-16 mt-8 space-y-12">
                        <div class="text-center w-2/3 mx-auto">
                            <div class="border-t border-gray-400"></div>
                            <p class="mt-1">Diretor(a)</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('report-view-title').textContent = `Ofício Nº ${oficioNumber}`;
            document.getElementById('report-view-content').innerHTML = oficioHTML;
            openModal(dom.reportViewModalBackdrop);
        };

        const generateAndShowReport = (studentId) => {
            const studentOccurrences = state.occurrences.filter(occ => occ.studentId === studentId).sort((a, b) => new Date(a.date) - new Date(b.date));
            if (studentOccurrences.length === 0) return showToast('Nenhuma ocorrência para este aluno.');

            const studentData = state.students.find(s => s.matricula === studentId);
            const currentDate = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

            const reportHTML = `<div class="space-y-6 text-sm"><div class="text-center border-b pb-4"><h2 class="text-xl font-bold uppercase">${config.schoolName}</h2><h3 class="text-lg font-semibold mt-2">RELATÓRIO DE OCORRÊNCIAS</h3></div><div class="pt-4 text-left"><p><strong>ALUNO(A):</strong> ${studentData.name}</p><p><strong>TURMA:</strong> ${studentData.class}</p><p><strong>DATA:</strong> ${currentDate}</p></div>${studentOccurrences.map((occ, index) => `<div class="border-t pt-4 mt-4"><h4 class="font-semibold mb-2 text-base">OCORRÊNCIA ${index + 1} - Data: ${formatDate(occ.date)}</h4><div class="pl-4 border-l-2 border-gray-200 space-y-2"><div><p class="font-medium">Descrição:</p><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(occ.description)}</p></div><div><p class="font-medium">Providências da Escola:</p><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(occ.actionsTakenSchool)}</p></div></div></div>`).join('')}<div class="border-t pt-16 mt-8"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="mt-1">Assinatura da Coordenação</p></div></div></div>`;
            
            document.getElementById('report-view-title').textContent = "Relatório de Ocorrências";
            document.getElementById('report-view-content').innerHTML = reportHTML;
            openModal(dom.reportViewModalBackdrop);
        };
        
        const generateAndShowConsolidatedFicha = (studentId, processId = null) => {
            let studentActions = state.absences.filter(action => action.studentId === studentId);
            
            if (processId) {
                studentActions = studentActions.filter(action => action.processId === processId);
            }

            studentActions.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));

            if (studentActions.length === 0) return showToast('Nenhuma ação para este aluno neste processo.');
            const studentData = state.students.find(s => s.matricula === studentId);

            const findAction = (type) => studentActions.find(a => a.actionType === type) || {};
            const t1 = findAction('tentativa_1'), t2 = findAction('tentativa_2'), t3 = findAction('tentativa_3'), visita = findAction('visita'), ct = findAction('encaminhamento_ct'), analise = findAction('analise');
            
            const faltasData = t1.periodoFaltasStart ? t1 : (t2.periodoFaltasStart ? t2 : (t3.periodoFaltasStart ? t3 : (visita.periodoFaltasStart ? visita : {})));

            const fichaHTML = `
                <div class="space-y-4 text-sm">
                    <div class="text-center border-b pb-4">
                        <h2 class="text-lg font-bold uppercase">${config.schoolName}</h2>
                        <h3 class="font-semibold mt-1">Ficha de Acompanhamento da Busca Ativa</h3>
                    </div>
                    
                    <div class="border rounded-md p-3">
                        <h4 class="font-semibold text-base mb-2">Identificação</h4>
                        <p><strong>Nome do aluno:</strong> ${studentData.name}</p>
                        <p><strong>Ano/Ciclo:</strong> ${studentData.class || ''}</p>
                        <p><strong>Endereço:</strong> ${formatText(studentData.endereco)}</p>
                        <p><strong>Contato:</strong> ${formatText(studentData.contato)}</p>
                    </div>

                    <div class="border rounded-md p-3">
                        <h4 class="font-semibold text-base mb-2">Faltas apuradas no período de:</h4>
                        <p><strong>Data de início:</strong> ${formatDate(faltasData.periodoFaltasStart)}</p>
                        <p><strong>Data de fim:</strong> ${formatDate(faltasData.periodoFaltasEnd)}</p>
                        <p><strong>Nº de faltas:</strong> ${formatText(faltasData.absenceCount)}</p>
                    </div>

                    <div class="border rounded-md p-3 space-y-3">
                        <h4 class="font-semibold text-base">Tentativas de contato com o responsável pelo estudante (ligações, whatsApp ou carta ao responsável)</h4>
                        <div class="pl-4">
                            <p class="font-medium underline">1ª Tentativa:</p>
                            <p><strong>Conseguiu contato?</strong> ${t1.contactSucceeded === 'yes' ? 'Sim' : t1.contactSucceeded === 'no' ? 'Não' : ''}</p>
                            <p><strong>Dia do contato:</strong> ${formatDate(t1.contactDate)}</p>
                            <p><strong>Com quem falou?</strong> ${formatText(t1.contactPerson)}</p>
                            <p><strong>Justificativa:</strong> ${formatText(t1.contactReason)}</p>
                            <p><strong>Aluno retornou?</strong> ${t1.contactReturned === 'yes' ? 'Sim' : t1.contactReturned === 'no' ? 'Não' : ''}</p>
                        </div>
                        <div class="pl-4 border-t pt-2">
                            <p class="font-medium underline">2ª Tentativa:</p>
                            <p><strong>Conseguiu contato?</strong> ${t2.contactSucceeded === 'yes' ? 'Sim' : t2.contactSucceeded === 'no' ? 'Não' : ''}</p>
                            <p><strong>Dia do contato:</strong> ${formatDate(t2.contactDate)}</p>
                            <p><strong>Com quem falou?</strong> ${formatText(t2.contactPerson)}</p>
                            <p><strong>Justificativa:</strong> ${formatText(t2.contactReason)}</p>
                            <p><strong>Aluno retornou?</strong> ${t2.contactReturned === 'yes' ? 'Sim' : t2.contactReturned === 'no' ? 'Não' : ''}</p>
                        </div>
                        <div class="pl-4 border-t pt-2">
                            <p class="font-medium underline">3ª Tentativa:</p>
                            <p><strong>Conseguiu contato?</strong> ${t3.contactSucceeded === 'yes' ? 'Sim' : t3.contactSucceeded === 'no' ? 'Não' : ''}</p>
                            <p><strong>Dia do contato:</strong> ${formatDate(t3.contactDate)}</p>
                            <p><strong>Com quem falou?</strong> ${formatText(t3.contactPerson)}</p>
                            <p><strong>Justificativa:</strong> ${formatText(t3.contactReason)}</p>
                            <p><strong>Aluno retornou?</strong> ${t3.contactReturned === 'yes' ? 'Sim' : t3.contactReturned === 'no' ? 'Não' : ''}</p>
                        </div>
                    </div>

                    <div class="border rounded-md p-3 space-y-2">
                        <h4 class="font-semibold text-base">Contato in loco/Conversa com o responsável</h4>
                        <p><strong>Nome do agente que realizou a visita:</strong> ${formatText(visita.visitAgent)}</p>
                        <p><strong>Dia da visita:</strong> ${formatDate(visita.visitDate)}</p>
                        <p><strong>Conseguiu contato?</strong> ${visita.visitSucceeded === 'yes' ? 'Sim' : visita.visitSucceeded === 'no' ? 'Não' : ''}</p>
                        <p><strong>Com quem falou?</strong> ${formatText(visita.visitContactPerson)}</p>
                        <p><strong>Justificativa:</strong> ${formatText(visita.visitReason)}</p>
                        <p><strong>Aluno retornou?</strong> ${visita.visitReturned === 'yes' ? 'Sim' : visita.visitReturned === 'no' ? 'Não' : ''}</p>
                        <p><strong>Observação:</strong> ${formatText(visita.visitObs)}</p>
                    </div>

                    <div class="border rounded-md p-3 space-y-2">
                        <h4 class="font-semibold text-base">Encaminhamento ao Conselho Tutelar</h4>
                        <p><strong>Data de envio:</strong> ${formatDate(ct.ctSentDate)}</p>
                        <p><strong>Devolutiva:</strong> ${formatText(ct.ctFeedback)}</p>
                        <p><strong>Aluno retornou?</strong> ${ct.ctReturned === 'yes' ? 'Sim' : ct.ctReturned === 'no' ? 'Não' : ''}</p>
                    </div>

                    <div class="border rounded-md p-3 space-y-2">
                        <h4 class="font-semibold text-base">Análise</h4>
                        <p><strong>Parecer da BAE:</strong> ${formatText(analise.ctParecer)}</p>
                    </div>
                    
                    <div class="signature-block pt-16 mt-8 space-y-12">
                        <div class="text-center w-2/3 mx-auto">
                            <div class="border-t border-gray-400"></div>
                            <p class="mt-1">Diretor(a)</p>
                        </div>
                        <div class="text-center w-2/3 mx-auto">
                            <div class="border-t border-gray-400"></div>
                            <p class="mt-1">Coordenador(a) Pedagógico(a)</p>
                        </div>
                    </div>
                </div>`;
            document.getElementById('report-view-title').textContent = "Ficha Consolidada de Busca Ativa";
            document.getElementById('report-view-content').innerHTML = fichaHTML;
            openModal(dom.reportViewModalBackdrop);
        };

        const toggleFamilyContactFields = (enable) => {
            const fieldsContainer = document.getElementById('family-contact-fields');
            const inputs = fieldsContainer.querySelectorAll('input, textarea');
            
            inputs.forEach(input => {
                input.disabled = !enable;
                if (!enable) {
                    input.classList.add('bg-gray-200', 'cursor-not-allowed');
                } else {
                    input.classList.remove('bg-gray-200', 'cursor-not-allowed');
                }
            });
            // Limpar os campos se estiver desabilitado, exceto os botões de rádio
            if (!enable) {
                fieldsContainer.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(el => el.value = '');
                fieldsContainer.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
            }
        };

        const toggleVisitContactFields = (enable) => {
            const fieldsContainer = document.getElementById('visit-contact-fields');
            const inputs = fieldsContainer.querySelectorAll('input, textarea');
            
            inputs.forEach(input => {
                input.disabled = !enable;
                if (!enable) {
                    input.classList.add('bg-gray-200', 'cursor-not-allowed');
                } else {
                    input.classList.remove('bg-gray-200', 'cursor-not-allowed');
                }
            });
            if (!enable) {
                fieldsContainer.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(el => el.value = '');
                fieldsContainer.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
            }
        };

        const openAbsenceModalForStudent = (student, forceActionType = null, data = null) => {
            dom.absenceForm.reset();

            const isEditing = !!data;
            document.getElementById('absence-modal-title').innerText = isEditing ? 'Editar Ação de Busca Ativa' : 'Registar Ação de Busca Ativa';
            document.getElementById('absence-id').value = isEditing ? data.id : '';

            // Preencher dados do aluno
            document.getElementById('absence-student-name').value = student.name || '';
            document.getElementById('absence-student-class').value = student.class || '';
            document.getElementById('absence-student-endereco').value = student.endereco || '';
            document.getElementById('absence-student-contato').value = student.contato || '';
            
            const { processId, currentCycleActions } = getStudentProcessInfo(student.matricula);
            document.getElementById('absence-process-id').value = data?.processId || processId;


            const finalActionType = forceActionType || determineNextActionForStudent(student.matricula);
            document.getElementById('action-type').value = finalActionType;
            document.getElementById('action-type-display').value = actionDisplayTitles[finalActionType] || '';
            document.getElementById('action-type').dispatchEvent(new Event('change'));

            // Lógica para persistir dados de faltas
            const absenceFieldsContainer = dom.absenceForm.querySelector('#absence-form > .bg-gray-50');
            const absenceInputs = absenceFieldsContainer.querySelectorAll('input');
            
            const firstAbsenceRecordInCycle = currentCycleActions.find(a => a.periodoFaltasStart);


            if (finalActionType !== 'tentativa_1' && firstAbsenceRecordInCycle) {
                document.getElementById('absence-start-date').value = firstAbsenceRecordInCycle.periodoFaltasStart || '';
                document.getElementById('absence-end-date').value = firstAbsenceRecordInCycle.periodoFaltasEnd || '';
                document.getElementById('absence-count').value = firstAbsenceRecordInCycle.absenceCount || '';
                absenceInputs.forEach(input => input.readOnly = true);
            } else {
                absenceInputs.forEach(input => input.readOnly = false);
            }
            
            // Preencher dados da ação se estiver editando
            if (isEditing) {
                document.getElementById('absence-start-date').value = data.periodoFaltasStart || firstAbsenceRecordInCycle?.periodoFaltasStart || '';
                document.getElementById('absence-end-date').value = data.periodoFaltasEnd || firstAbsenceRecordInCycle?.periodoFaltasEnd || '';
                document.getElementById('absence-count').value = data.absenceCount || firstAbsenceRecordInCycle?.absenceCount || '';

                switch (data.actionType) {
                    case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                        document.getElementById('meeting-date').value = data.meetingDate || '';
                        document.getElementById('meeting-time').value = data.meetingTime || '';
                        document.getElementById('contact-date').value = data.contactDate || '';
                        document.getElementById('contact-person').value = data.contactPerson || '';
                        document.getElementById('contact-reason').value = data.contactReason || '';
                        if(data.contactSucceeded) document.querySelector(`input[name="contact-succeeded"][value="${data.contactSucceeded}"]`).checked = true;
                        toggleFamilyContactFields(data.contactSucceeded === 'yes');
                        if(data.contactReturned) document.querySelector(`input[name="contact-returned"][value="${data.contactReturned}"]`).checked = true;
                        break;
                    case 'visita':
                        document.getElementById('visit-agent').value = data.visitAgent || '';
                        document.getElementById('visit-date').value = data.visitDate || '';
                        document.getElementById('visit-contact-person').value = data.visitContactPerson || '';
                        document.getElementById('visit-reason').value = data.visitReason || '';
                        document.getElementById('visit-obs').value = data.visitObs || '';
                        if(data.visitSucceeded) document.querySelector(`input[name="visit-succeeded"][value="${data.visitSucceeded}"]`).checked = true;
                        toggleVisitContactFields(data.visitSucceeded === 'yes');
                        if (data.visitReturned) document.querySelector(`input[name="visit-returned"][value="${data.visitReturned}"]`).checked = true;
                        break;
                    case 'encaminhamento_ct':
                        document.getElementById('ct-sent-date').value = data.ctSentDate || '';
                        document.getElementById('ct-feedback').value = data.ctFeedback || '';
                        if (data.ctReturned) document.querySelector(`input[name="ct-returned"][value="${data.ctReturned}"]`).checked = true;
                        break;
                    case 'analise':
                        document.getElementById('ct-parecer').value = data.ctParecer || '';
                        break;
                }
            }
            
            openModal(dom.absenceModal);
        };
        
        const setupEventListeners = () => {
            dom.showRegisterViewBtn.addEventListener('click', showRegisterView);
            dom.showLoginViewBtn.addEventListener('click', showLoginView);

            dom.tabOccurrences.addEventListener('click', () => { state.activeTab = 'occurrences'; dom.tabOccurrences.classList.add('tab-active'); dom.tabAbsences.classList.remove('tab-active'); dom.tabContentOccurrences.classList.remove('hidden'); dom.tabContentAbsences.classList.add('hidden'); render(); });
            dom.tabAbsences.addEventListener('click', () => { state.activeTab = 'absences'; dom.tabAbsences.classList.add('tab-active'); dom.tabOccurrences.classList.remove('tab-active'); dom.tabContentAbsences.classList.remove('hidden'); dom.tabContentOccurrences.classList.add('hidden'); render(); });

            // Listeners dos botões de partilha
            document.getElementById('share-btn').addEventListener('click', () => {
                const title = document.getElementById('notification-title').textContent;
                const content = document.getElementById('notification-content').innerText;
                shareContent(title, content);
            });

            document.getElementById('report-share-btn').addEventListener('click', () => {
                const title = document.getElementById('report-view-title').textContent;
                const content = document.getElementById('report-view-content').innerText;
                shareContent(title, content);
            });

            document.getElementById('ficha-share-btn').addEventListener('click', () => {
                const title = document.getElementById('ficha-view-title').textContent;
                const content = document.getElementById('ficha-view-content').innerText;
                shareContent(title, content);
            });


            ['close-modal-btn', 'cancel-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.occurrenceModal)));
            ['close-absence-modal-btn', 'cancel-absence-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.absenceModal)));
            ['close-report-generator-btn', 'cancel-report-generator-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.reportGeneratorModal)));
            document.getElementById('close-notification-btn').addEventListener('click', () => closeModal(dom.notificationModalBackdrop));
            document.getElementById('close-report-view-btn').addEventListener('click', () => closeModal(dom.reportViewModalBackdrop));
            document.getElementById('close-ficha-view-btn').addEventListener('click', () => closeModal(dom.fichaViewModalBackdrop));
            document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal(dom.deleteConfirmModal));
            document.getElementById('print-btn').addEventListener('click', () => window.print());
            document.getElementById('report-print-btn').addEventListener('click', () => window.print());
            document.getElementById('ficha-print-btn').addEventListener('click', () => window.print());

            dom.occurrenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('occurrence-id').value;
                const studentName = document.getElementById('student-name').value.trim();
                const student = state.students.find(s => s.name === studentName);
                if (!student) {
                    showToast("Aluno inválido. Por favor, selecione um aluno da lista.");
                    return;
                }
                const data = { 
                    studentId: student.matricula,
                    date: document.getElementById('occurrence-date').value, 
                    description: document.getElementById('description').value.trim(), 
                    involved: document.getElementById('involved').value.trim(), 
                    actionsTakenSchool: document.getElementById('actions-taken-school').value.trim(), 
                    actionsTakenFamily: document.getElementById('actions-taken-family').value.trim(), 
                    meetingDate: document.getElementById('meeting-date-occurrence').value, 
                    meetingTime: document.getElementById('meeting-time-occurrence').value 
                };
                try { id ? await updateRecord('occurrence', id, data) : await addRecord('occurrence', data); showToast(`Ocorrência ${id ? 'atualizada' : 'registada'} com sucesso!`); closeModal(dom.occurrenceModal); } catch (error) { console.error("Erro:", error); showToast('Erro ao salvar.'); }
            });

            dom.absenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('absence-id').value;
                const studentName = document.getElementById('absence-student-name').value.trim();
                const student = state.students.find(s => s.name === studentName);
                if (!student) {
                    showToast("Aluno inválido. Por favor, selecione um aluno da lista.");
                    return;
                }
                const actionType = document.getElementById('action-type').value;
                const processId = document.getElementById('absence-process-id').value;
                const data = { 
                    studentId: student.matricula,
                    actionType,
                    processId
                };

                try {
                    data.periodoFaltasStart = document.getElementById('absence-start-date').value || null;
                    data.periodoFaltasEnd = document.getElementById('absence-end-date').value || null;
                    data.absenceCount = document.getElementById('absence-count').value || null;

                    switch (actionType) {
                        case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                            data.meetingDate = document.getElementById('meeting-date').value || null;
                            data.meetingTime = document.getElementById('meeting-time').value || null;
                            data.contactDate = document.getElementById('contact-date').value || null;
                            data.contactPerson = document.getElementById('contact-person').value || null;
                            data.contactReason = document.getElementById('contact-reason').value || null;
                            const contactSucceededRadio = document.querySelector('input[name="contact-succeeded"]:checked');
                            data.contactSucceeded = contactSucceededRadio ? contactSucceededRadio.value : null;
                            const contactReturnedRadio = document.querySelector('input[name="contact-returned"]:checked');
                            data.contactReturned = contactReturnedRadio ? contactReturnedRadio.value : null;
                            break;
                        case 'visita':
                            data.visitAgent = document.getElementById('visit-agent').value || null;
                            data.visitDate = document.getElementById('visit-date').value || null;
                            data.visitContactPerson = document.getElementById('visit-contact-person').value || null;
                            data.visitReason = document.getElementById('visit-reason').value || null;
                            data.visitObs = document.getElementById('visit-obs').value || null;
                            const visitSucceededRadio = document.querySelector('input[name="visit-succeeded"]:checked');
                            data.visitSucceeded = visitSucceededRadio ? visitSucceededRadio.value : null;
                            const visitRadio = document.querySelector('input[name="visit-returned"]:checked');
                            data.visitReturned = visitRadio ? visitRadio.value : null;
                            break;
                        case 'encaminhamento_ct':
                            data.ctSentDate = document.getElementById('ct-sent-date').value || null;
                            data.ctFeedback = document.getElementById('ct-feedback').value || null;
                            const ctRadio = document.querySelector('input[name="ct-returned"]:checked');
                            data.ctReturned = ctRadio ? ctRadio.value : null;
                            break;
                        case 'analise':
                            data.ctParecer = document.getElementById('ct-parecer').value || null;
                            break;
                        default:
                            if (!actionType) {
                                showToast("Por favor, selecione um Tipo de Ação.");
                                return;
                            }
                    }
                } catch (error) {
                    console.error("Erro ao recolher dados do formulário:", error);
                    showToast("Erro interno ao ler os campos do formulário.");
                    return;
                }

                try {
                    const isNewRecord = !id;
                    if (isNewRecord) {
                        const newDocRef = await addRecord('absence', data);
                        data.id = newDocRef.id;
                        state.absences.push(data); // Adicionar localmente para a verificação de retorno funcionar imediatamente
                    } else {
                        await updateRecord('absence', id, data);
                    }
                    
                    showToast(`Ação ${id ? 'atualizada' : 'registada'} com sucesso!`);
                    
                    const studentReturned = (data.actionType.startsWith('tentativa') && data.contactReturned === 'yes') || (data.actionType === 'visita' && data.visitReturned === 'yes');

                    closeModal(dom.absenceModal);

                    if (studentReturned) {
                        setTimeout(() => openAbsenceModalForStudent(student, 'analise'), 350);
                    }

                } catch (error) { 
                    console.error("Erro ao salvar ação:", error); 
                    showToast('Erro ao salvar.'); 
                }
            });

            dom.absencesListDiv.addEventListener('click', (e) => {
                const target = e.target;
                const header = target.closest('.process-header');
                const button = target.closest('button');

                if (header && !button) { 
                    const processId = header.dataset.processId;
                    const content = document.getElementById(`content-${processId}`);
                    const icon = header.querySelector('i.fa-chevron-down');
                    if (content) {
                        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                            content.style.maxHeight = null;
                            icon.classList.remove('rotate-180');
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            icon.classList.add('rotate-180');
                        }
                    }
                }

                if(button) {
                    const studentId = button.dataset.studentId;
                    if (button.classList.contains('generate-ficha-btn-row')) {
                        e.stopPropagation();
                        const processId = button.dataset.processId;
                        generateAndShowConsolidatedFicha(studentId, processId);
                        return; 
                    }

                    const id = button.dataset.id;
                    if (button.classList.contains('edit-absence-btn')) {
                        const data = state.absences.find(a => a.id === id);
                        const student = state.students.find(s => s.matricula === data.studentId);
                        if (data && student) {
                            openAbsenceModalForStudent(student, data.actionType, data);
                        }
                    }
                    else if (button.classList.contains('delete-absence-btn')) { 
                        state.recordToDelete = { id, type: 'absence' }; 
                        openModal(dom.deleteConfirmModal); 
                    }
                    else if (button.classList.contains('notification-btn')) { 
                        openFichaViewModal(id);
                    } else if (button.classList.contains('send-ct-btn')) {
                        const oficioNumber = prompt("Por favor, insira o número do ofício:");
                        if (oficioNumber && oficioNumber.trim() !== '') {
                            const visitAction = state.absences.find(a => a.id === id);
                            if (!visitAction) return;

                            // 1. Gera e mostra o ofício para impressão/envio
                            generateAndShowOficio(visitAction, oficioNumber); 

                            // 2. Cria automaticamente o registro do próximo passo no banco de dados
                            const student = state.students.find(s => s.matricula === visitAction.studentId);
                            if (!student) return;

                            const { processId, currentCycleActions } = getStudentProcessInfo(student.matricula);

                            const alreadyExists = currentCycleActions.some(a => a.actionType === 'encaminhamento_ct');
                            if (alreadyExists) return; // Não faz nada se o passo já foi registrado

                            const firstActionWithAbsenceData = currentCycleActions.find(a => a.periodoFaltasStart);
                            
                            const dataForCtAction = {
                                studentId: student.matricula,
                                actionType: 'encaminhamento_ct',
                                processId: processId,
                                ctSentDate: new Date().toISOString().split('T')[0],
                                periodoFaltasStart: firstActionWithAbsenceData?.periodoFaltasStart || null,
                                periodoFaltasEnd: firstActionWithAbsenceData?.periodoFaltasEnd || null,
                                absenceCount: firstActionWithAbsenceData?.absenceCount || null,
                            };
                            
                            addRecord('absence', dataForCtAction).then(() => {
                                showToast("Registro de 'Encaminhamento ao CT' salvo automaticamente.");
                            }).catch(error => {
                                console.error("Erro ao salvar o encaminhamento ao CT:", error);
                                showToast("Erro ao salvar o encaminhamento automático.");
                            });
                        }
                    }
                }
            });

            dom.occurrencesListDiv.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.dataset.id;
                if (button.classList.contains('edit-btn')) {
                    const data = state.occurrences.find(o => o.id === id);
                    const student = state.students.find(s => s.matricula === data.studentId);
                    if (data && student) {
                        dom.occurrenceForm.reset();
                        document.getElementById('modal-title').innerText = 'Editar Registro de Ocorrência';
                        document.getElementById('occurrence-id').value = data.id || '';
                        document.getElementById('student-name').value = student.name || '';
                        document.getElementById('student-class').value = student.class || '';
                        document.getElementById('occurrence-date').value = data.date || '';
                        document.getElementById('description').value = data.description || '';
                        document.getElementById('involved').value = data.involved || '';
                        document.getElementById('actions-taken-school').value = data.actionsTakenSchool || '';
                        document.getElementById('actions-taken-family').value = data.actionsTakenFamily || '';
                        document.getElementById('meeting-date-occurrence').value = data.meetingDate || '';
                        document.getElementById('meeting-time-occurrence').value = data.meetingTime || '';
                        openModal(dom.occurrenceModal);
                    }
                }
                else if (button.classList.contains('delete-btn')) { state.recordToDelete = { id, type: 'occurrence' }; openModal(dom.deleteConfirmModal); }
                else if (button.classList.contains('view-btn')) { openNotificationModal(id); }
            });

            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                if (state.recordToDelete) {
                    try { await deleteRecord(state.recordToDelete.type, state.recordToDelete.id); showToast('Registro excluído com sucesso.'); } catch (error) { console.error("Erro ao excluir:", error); showToast('Erro ao excluir.'); } finally { state.recordToDelete = null; closeModal(dom.deleteConfirmModal); }
                }
            });
            
            document.getElementById('create-report-btn').addEventListener('click', () => {
                const selectedStudentId = document.getElementById('student-select').value;
                if (!selectedStudentId) return showToast('Por favor, selecione um aluno.');
                const reportType = dom.reportGeneratorModal.dataset.reportType;
                if (reportType === 'occurrences') generateAndShowReport(selectedStudentId);
                else generateAndShowConsolidatedFicha(selectedStudentId);
                closeModal(dom.reportGeneratorModal);
            });
            document.getElementById('action-type').addEventListener('change', (e) => {
                const action = e.target.value;
                document.querySelectorAll('.dynamic-field-group').forEach(group => group.classList.add('hidden'));
                if (action.startsWith('tentativa')) { 
                    document.getElementById('group-tentativas').classList.remove('hidden');
                    toggleFamilyContactFields(false); // Desabilitar por padrão
                    const radioNo = document.querySelector('input[name="contact-succeeded"][value="no"]');
                    if (radioNo) radioNo.checked = true;
                } else if (action === 'visita') {
                    document.getElementById('group-visita').classList.remove('hidden');
                    toggleVisitContactFields(false); // Desabilitar por padrão
                    const radioNo = document.querySelector('input[name="visit-succeeded"][value="no"]');
                    if (radioNo) radioNo.checked = true;
                }
                else if (action) { 
                    const group = document.getElementById(`group-${action}`); 
                    if (group) group.classList.remove('hidden');
                }
            });
            
            document.querySelectorAll('input[name="contact-succeeded"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggleFamilyContactFields(e.target.value === 'yes');
                });
            });
            document.querySelectorAll('input[name="visit-succeeded"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggleVisitContactFields(e.target.value === 'yes');
                });
            });

            document.getElementById('manage-students-btn').addEventListener('click', () => {
                renderStudentsList();
                openModal(dom.studentsModal);
            });
            document.getElementById('close-students-modal-btn').addEventListener('click', () => closeModal(dom.studentsModal));
            document.getElementById('upload-csv-btn').addEventListener('click', async () => {
                const fileInput = document.getElementById('csv-file');
                const feedbackDiv = document.getElementById('csv-feedback');
                if (fileInput.files.length === 0) {
                    showToast("Por favor, selecione um ficheiro CSV.");
                    return;
                }
                
                Papa.parse(fileInput.files[0], {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: header => header.toLowerCase().trim().replace(/\s+/g, ''),
                    complete: async (results) => {
                        const requiredHeaders = ['matricula', 'nome', 'turma', 'endereco', 'contato', 'resp1', 'resp2'];
                        const fileHeaders = results.meta.fields;
                        
                        const hasAllHeaders = requiredHeaders.every(h => fileHeaders.includes(h));

                        if (!hasAllHeaders) {
                            feedbackDiv.innerHTML = `<p class="text-red-500">Erro: Faltam colunas. O ficheiro CSV deve conter: matricula, nome, turma, endereco, contato, resp1, resp2.</p>`;
                            return;
                        }

                        const newStudentList = results.data.map(row => ({
                            matricula: row.matricula || '',
                            name: row.nome || '',
                            class: row.turma || '',
                            endereco: row.endereco || '',
                            contato: row.contato || '',
                            resp1: row.resp1 || '',
                            resp2: row.resp2 || ''
                        })).filter(s => s.name && s.matricula);

                        try {
                            await setDoc(getStudentsDocRef(), { list: newStudentList });
                            state.students = newStudentList;
                            renderStudentsList();
                            showToast(`${newStudentList.length} alunos importados com sucesso!`);
                            fileInput.value = '';
                            feedbackDiv.innerHTML = '';
                        } catch(error) {
                            console.error("Erro ao salvar lista de alunos:", error);
                            showToast("Erro ao salvar a nova lista de alunos.");
                        }
                    }
                });
            });

            document.getElementById('student-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('student-id-input').value; // Usando matricula como ID
                const matricula = document.getElementById('student-matricula-input').value.trim();
                const name = document.getElementById('student-name-input').value.trim();
                const studentClass = document.getElementById('student-class-input').value.trim();
                const endereco = document.getElementById('student-endereco-input').value.trim();
                const contato = document.getElementById('student-contato-input').value.trim();
                const resp1 = document.getElementById('student-resp1-input').value.trim();
                const resp2 = document.getElementById('student-resp2-input').value.trim();

                if (!matricula || !name || !studentClass || !resp1) {
                    showToast("Matrícula, Nome, Turma e Responsável 1 são obrigatórios.");
                    return;
                }
                
                const studentData = { matricula, name, class: studentClass, endereco, contato, resp1, resp2 };
                
                let updatedList = [...state.students];

                if (id) { // Editando
                    const index = updatedList.findIndex(s => s.matricula === id);
                    if (index > -1) {
                        updatedList[index] = studentData;
                    }
                } else { // Adicionando
                    if (updatedList.some(s => s.matricula === matricula)) {
                        showToast("Erro: Matrícula já existe.");
                        return;
                    }
                    updatedList.push(studentData);
                }

                try {
                    await setDoc(getStudentsDocRef(), { list: updatedList });
                    state.students = updatedList;
                    renderStudentsList();
                    resetStudentForm();
                    showToast(`Aluno ${id ? 'atualizado' : 'adicionado'} com sucesso.`);
                } catch(error) {
                    console.error("Erro ao salvar aluno:", error);
                    showToast("Erro ao salvar dados do aluno.");
                }
            });

            document.getElementById('cancel-edit-student-btn').addEventListener('click', resetStudentForm);
        };

        const setupAutocomplete = (inputId, suggestionsId, onSelectCallback) => {
            const input = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(suggestionsId);
            
            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                if (inputId === 'search-occurrences') state.filterOccurrences = value;
                if (inputId === 'search-absences') state.filterAbsences = value;
                render();
                suggestionsContainer.innerHTML = '';
                if (!value) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                
                const filteredStudents = state.students.filter(s => s.name.toLowerCase().startsWith(value)).slice(0, 5);
                
                if (filteredStudents.length > 0) {
                    suggestionsContainer.classList.remove('hidden');
                    filteredStudents.forEach(student => {
                        const item = document.createElement('div');
                        item.classList.add('suggestion-item');
                        item.textContent = student.name;
                        item.addEventListener('click', () => {
                            if (onSelectCallback) {
                                onSelectCallback(student);
                            } 
                            input.value = '';
                            if (inputId === 'search-occurrences') state.filterOccurrences = '';
                            if (inputId === 'search-absences') state.filterAbsences = '';
                            render();
                            suggestionsContainer.classList.add('hidden');
                        });
                        suggestionsContainer.appendChild(item);
                    });
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!suggestionsContainer.contains(e.target) && e.target !== input) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        };

        const renderStudentsList = () => {
            const tableBody = document.getElementById('students-list-table');
            tableBody.innerHTML = '';
            state.students.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900">${student.name}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${student.class}</td>
                    <td class="px-4 py-2 text-right text-sm space-x-2">
                        <button class="edit-student-btn text-yellow-600 hover:text-yellow-900" data-id="${student.matricula}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-student-btn text-red-600 hover:text-red-900" data-id="${student.matricula}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-student-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const student = state.students.find(s => s.matricula === id);
                    if (student) {
                        document.getElementById('student-form-title').textContent = 'Editar Aluno';
                        document.getElementById('student-id-input').value = student.matricula;
                        document.getElementById('student-matricula-input').value = student.matricula;
                        document.getElementById('student-matricula-input').readOnly = true;
                        document.getElementById('student-matricula-input').classList.add('bg-gray-100');
                        document.getElementById('student-name-input').value = student.name;
                        document.getElementById('student-class-input').value = student.class;
                        document.getElementById('student-endereco-input').value = student.endereco || '';
                        document.getElementById('student-contato-input').value = student.contato || '';
                        document.getElementById('student-resp1-input').value = student.resp1;
                        document.getElementById('student-resp2-input').value = student.resp2;
                        document.getElementById('cancel-edit-student-btn').classList.remove('hidden');
                    }
                });
            });

            document.querySelectorAll('.delete-student-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const student = state.students.find(s => s.matricula === id);
                    if (student && confirm(`Tem a certeza que quer remover o aluno "${student.name}"?`)) {
                        const updatedList = state.students.filter(s => s.matricula !== id);
                        try {
                            await setDoc(getStudentsDocRef(), { list: updatedList });
                            state.students = updatedList;
                            renderStudentsList();
                            showToast("Aluno removido com sucesso.");
                        } catch(error) {
                            console.error("Erro ao remover aluno:", error);
                            showToast("Erro ao remover aluno.");
                        }
                    }
                });
            });
        };
        
        const resetStudentForm = () => {
            document.getElementById('student-form-title').textContent = 'Adicionar Novo Aluno';
            document.getElementById('student-form').reset();
            document.getElementById('student-id-input').value = '';
            document.getElementById('student-matricula-input').readOnly = false;
            document.getElementById('student-matricula-input').classList.remove('bg-gray-100');
            document.getElementById('cancel-edit-student-btn').classList.add('hidden');
        };
        
        const showLoginView = () => {
            dom.registerView.classList.add('hidden');
            dom.loginView.classList.remove('hidden');
        };

        const showRegisterView = () => {
            dom.loginView.classList.add('hidden');
            dom.registerView.classList.remove('hidden');
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const finalConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') 
                ? JSON.parse(__firebase_config) 
                : firebaseConfig;

            if (Object.keys(finalConfig).length < 2) {
                document.body.innerHTML = `<div class="p-8 text-center text-red-700 bg-red-100"><h1>Configuração Incompleta do Firebase</h1><p class="mt-2">A configuração do Firebase não foi encontrada no ambiente. A aplicação não pode ser iniciada.</p></div>`;
                return;
            }

            const app = initializeApp(finalConfig);
            const auth = getAuth(app);
            state.db = getFirestore(app);

            onAuthStateChanged(auth, async user => {
                detachFirestoreListeners();
                if (user) {
                    state.userId = user.uid;
                    dom.userEmail.textContent = user.email || `Utilizador: ${user.uid.substring(0, 8)}`;
                    dom.loginScreen.classList.add('hidden');
                    dom.mainContent.classList.remove('hidden');
                    dom.userProfile.classList.remove('hidden');
                    await setupFirestoreListeners();
                } else {
                    state.userId = null;
                    state.students = [];
                    state.occurrences = [];
                    state.absences = [];
                    render();
                    dom.mainContent.classList.add('hidden');
                    dom.userProfile.classList.add('hidden');
                    dom.loginScreen.classList.remove('hidden');
                }
            });

            dom.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Erro ao entrar:", error.code);
                    showToast("Email ou senha inválidos.");
                }
            });

            dom.registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Erro ao registar:", error.code);
                    if (error.code === 'auth/email-already-in-use') {
                        showToast("Este email já está a ser utilizado.");
                    } else if (error.code === 'auth/weak-password') {
                        showToast("A sua senha é muito fraca.");
                    } else {
                        showToast("Erro ao criar a conta.");
                    }
                }
            });

            dom.logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Erro ao sair:", error);
                }
            });

            setupEventListeners();
            
            setupAutocomplete('search-occurrences', 'occurrence-student-suggestions', (student) => {
                dom.occurrenceForm.reset();
                document.getElementById('occurrence-id').value = '';
                document.getElementById('modal-title').innerText = 'Registar Nova Ocorrência';
                document.getElementById('student-name').value = student.name;
                document.getElementById('student-class').value = student.class;
                document.getElementById('occurrence-date').valueAsDate = new Date();
                openModal(dom.occurrenceModal);
            }); 

            setupAutocomplete('search-absences', 'absence-student-suggestions', (student) => {
                openAbsenceModalForStudent(student);
            });
        });
    </script>
</body>
</html>


            padding-left: 1rem;
            margin-top: 1rem;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .autocomplete-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            width: 100%;
        }
        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #eef2ff;
        }
        .signature-block {
            display: none;
        }
        .process-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        @media print {
            body > div:not(.printable-area) {
                display: none;
            }
            .printable-area, .printable-area .modal-content {
                display: block !important;
                position: static !important;
                width: 100%;
                height: auto;
                max-height: none;
                box-shadow: none;
                border: none;
                transform: none !important;
                background-color: white !important;
            }
            .printable-area .overflow-y-auto {
                overflow: visible !important;
            }
            .no-print {
                display: none !important;
            }
            .signature-block {
                display: block !important;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="login-view">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Entrar</h1>
                    <p class="text-gray-500 mb-8 text-center">Aceda à sua conta para continuar.</p>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Entrar</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        Não tem uma conta? <button id="show-register-view" class="font-semibold text-indigo-600 hover:underline">Registe-se</button>
                    </p>
                </div>

                <div id="register-view" class="hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Criar Conta</h1>
                    <p class="text-gray-500 mb-8 text-center">Crie uma nova conta para usar o sistema.</p>
                    <form id="register-form" class="space-y-4">
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="register-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres)</label>
                            <input type="password" id="register-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Criar Conta</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        Já tem uma conta? <button id="show-login-view" class="font-semibold text-indigo-600 hover:underline">Entrar</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Cabeçalho -->
            <header class="mb-8 p-6 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg flex flex-col sm:flex-row justify-between sm:items-center gap-4 text-center sm:text-left">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold">Sistema de Acompanhamento Pedagógico</h1>
                    <p class="opacity-90 mt-1 text-sm sm:text-base">Base de dados partilhada entre todos os utilizadores.</p>
                </div>
                <div class="flex items-center gap-4">
                     <button id="manage-students-btn" class="bg-white/20 text-white font-bold py-2 px-3 rounded-lg shadow-md hover:bg-white/30 text-sm">
                        <i class="fas fa-users-cog mr-2"></i>Gerir Alunos
                    </button>
                    <div id="user-profile" class="flex items-center space-x-4 hidden self-center sm:self-auto">
                        <div class="text-right">
                            <p id="user-email" class="font-semibold text-sm"></p>
                            <button id="logout-btn" class="text-xs sm:text-sm text-indigo-200 hover:text-white transition">Sair</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Abas de Navegação -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-2 sm:space-x-6" aria-label="Tabs">
                    <button id="tab-occurrences" class="text-center flex-1 sm:flex-none whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Ocorrências
                    </button>
                    <button id="tab-absences" class="text-center flex-1 sm:flex-none whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-user-clock mr-2"></i>Busca Ativa
                    </button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div id="tab-content-occurrences">
                 <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-center sm:justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">Registros de Ocorrências</h2>
                    <div class="flex gap-2 sm:gap-4 flex-wrap justify-center">
                        <button id="generate-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 text-sm">
                            <i class="fas fa-file-invoice mr-2"></i>Relatório
                        </button>
                    </div>
                </div>
                <main class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-occurrences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar aluno para ver histórico ou registar nova ocorrência...">
                            <div id="occurrence-student-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                    </div>
                    <div id="loading-occurrences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">A carregar registos...</p>
                    </div>
                    <div id="empty-state-occurrences" class="text-center p-8 hidden">
                        <i class="fas fa-file-alt fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ocorrência registada</h3>
                        <p class="text-gray-500 mt-1">Use a busca acima para registar uma nova ocorrência.</p>
                    </div>
                    <div id="occurrences-list" class="overflow-x-auto"></div>
                </main>
            </div>

            <div id="tab-content-absences" class="hidden">
                <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-center sm:justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">Histórico de Ações da Busca Ativa</h2>
                </div>
                 <main class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-absences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar aluno para ver histórico ou registar nova ação...">
                             <div id="absence-student-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                    </div>
                    <div id="loading-absences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">A carregar registos...</p>
                    </div>
                    <div id="empty-state-absences" class="text-center p-8 hidden">
                        <i class="fas fa-folder-open fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ação de busca ativa registada</h3>
                        <p class="text-gray-500 mt-1">Use a busca acima para registar uma nova ação.</p>
                    </div>
                    <div id="absences-list" class="space-y-4"></div>
                </main>
            </div>
            
            <footer class="text-center text-sm text-gray-400 mt-8">
                <p>Desenvolvido para Gestão Pedagógica</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="occurrence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold">Registar Nova Ocorrência</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="occurrence-form" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="occurrence-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" required readonly>
                    </div>
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700">Turma</label>
                        <input type="text" id="student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly required>
                    </div>
                </div>
                <div>
                    <label for="occurrence-date" class="block text-sm font-medium text-gray-700">Data da Ocorrência</label>
                    <input type="date" id="occurrence-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição da Ocorrência</label>
                    <textarea id="description" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                </div>
                <div>
                    <label for="involved" class="block text-sm font-medium text-gray-700">Pessoas Envolvidas</label>
                    <input type="text" id="involved" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Outros alunos, professores...">
                </div>
                <div>
                    <label for="actions-taken-school" class="block text-sm font-medium text-gray-700">Providências da Escola</label>
                    <textarea id="actions-taken-school" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Conversa com o aluno, contato com os pais..."></textarea>
                </div>
                <div>
                    <label for="actions-taken-family" class="block text-sm font-medium text-gray-700">Providências da Família</label>
                    <textarea id="actions-taken-family" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Acompanhamento, diálogo..."></textarea>
                </div>
                <div class="pt-4 border-t">
                    <h4 class="text-md font-semibold text-gray-600">Convocação para Reunião (Opcional)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="meeting-date-occurrence" class="block text-sm font-medium text-gray-700">Data do Comparecimento</label>
                            <input type="date" id="meeting-date-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="meeting-time-occurrence" class="block text-sm font-medium text-gray-700">Horário do Comparecimento</label>
                            <input type="time" id="meeting-time-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <div id="absence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0 max-h-[95vh] flex flex-col">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="absence-modal-title" class="text-xl font-semibold">Registar Ação de Busca Ativa</h3>
                <button id="close-absence-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="absence-form" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="absence-id">
                <input type="hidden" id="absence-process-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="absence-student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="absence-student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" required readonly>
                    </div>
                     <div>
                        <label for="absence-student-class" class="block text-sm font-medium text-gray-700">Ano/Ciclo</label>
                        <input type="text" id="absence-student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="absence-student-endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
                        <input type="text" id="absence-student-endereco" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="absence-student-contato" class="block text-sm font-medium text-gray-700">Contato</label>
                        <input type="text" id="absence-student-contato" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                </div>
                 <div class="border rounded-md p-3 space-y-2 bg-gray-50">
                    <h5 class="text-sm font-semibold text-gray-600 px-2">Faltas apuradas no período de:</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="absence-start-date" class="block text-sm">Início</label><input type="date" id="absence-start-date" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label for="absence-end-date" class="block text-sm">Fim</label><input type="date" id="absence-end-date" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                    </div>
                    <div class="pt-2"><label for="absence-count" class="block text-sm">Nº de faltas</label><input type="number" id="absence-count" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                </div>
                <div>
                    <label for="action-type-display" class="block text-sm font-medium text-gray-700">Tipo de Ação</label>
                    <input type="text" id="action-type-display" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                    <input type="hidden" id="action-type">
                </div>
                <div id="dynamic-fields-container" class="space-y-4">
                    <div id="group-tentativas" class="dynamic-field-group hidden space-y-4">
                        <fieldset class="border rounded-md p-3 space-y-2 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Data e horário para notificação</legend>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="meeting-date" class="block text-sm">Data do Comparecimento</label><input type="date" id="meeting-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label for="meeting-time" class="block text-sm">Horário do Comparecimento</label><input type="time" id="meeting-time" class="mt-1 w-full border-gray-300 rounded-md"></div>
                            </div>
                        </fieldset>

                        <fieldset id="family-contact-section" class="border rounded-md p-3 space-y-4 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Família na escola</legend>
                            <div>
                                <span class="block text-sm">Conseguiu contato?</span>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="contact-succeeded" value="yes"> Sim</label> 
                                    <label><input type="radio" name="contact-succeeded" value="no"> Não</label>
                                </div>
                            </div>
                            <div id="family-contact-fields" class="space-y-4">
                                <div><label class="block text-sm">Dia do contato:</label><input type="date" id="contact-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Com quem falou?</label><input type="text" id="contact-person" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Justificativa:</label><textarea id="contact-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                                <div>
                                    <span class="block text-sm">O aluno retornou?</span>
                                    <div class="mt-2 space-x-4">
                                        <label><input type="radio" name="contact-returned" value="yes"> Sim</label> 
                                        <label><input type="radio" name="contact-returned" value="no"> Não</label>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div id="group-visita" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Nome do agente da visita:</label><input type="text" id="visit-agent" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Dia da visita:</label><input type="date" id="visit-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                         <fieldset id="visit-contact-section" class="border rounded-md p-3 space-y-4 bg-gray-50">
                            <legend class="text-sm font-semibold text-gray-600 px-2">Detalhes do Contato</legend>
                            <div>
                                <span class="block text-sm">Conseguiu contato?</span>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="visit-succeeded" value="yes"> Sim</label> 
                                    <label><input type="radio" name="visit-succeeded" value="no"> Não</label>
                                </div>
                            </div>
                            <div id="visit-contact-fields" class="space-y-4">
                                <div><label class="block text-sm">Com quem falou?</label><input type="text" id="visit-contact-person" class="mt-1 w-full border-gray-300 rounded-md"></div>
                                <div><label class="block text-sm">Justificativa do responsável:</label><textarea id="visit-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                                <div><label class="block text-sm">Observações:</label><textarea id="visit-obs" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                                <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="visit-returned" value="yes"> Sim</label> <label><input type="radio" name="visit-returned" value="no"> Não</label></div></div>
                            </div>
                        </fieldset>
                    </div>
                    <div id="group-encaminhamento_ct" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Data do envio ao C.T.:</label><input type="date" id="ct-sent-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                         <div><label class="block text-sm">Devolutiva do C.T.:</label><textarea id="ct-feedback" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                        <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="ct-returned" value="yes"> Sim</label> <label><input type="radio" name="ct-returned" value="no"> Não</label></div></div>
                    </div>
                    <div id="group-analise" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Parecer da Busca Ativa Escolar (BAE):</label><textarea id="ct-parecer" rows="3" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3 bg-white sticky bottom-0 pb-6 -mx-6 px-6 border-t">
                    <button type="button" id="cancel-absence-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition duration-300">Salvar Ação</button>
                </div>
            </form>
        </div>
    </div>
    <div id="students-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-semibold">Gerir Lista de Alunos</h3>
                <button id="close-students-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6">
                <!-- Formulário para Adicionar/Editar Aluno -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h4 id="student-form-title" class="text-lg font-semibold mb-2">Adicionar Novo Aluno</h4>
                    <form id="student-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
                        <input type="hidden" id="student-id-input">
                        <div>
                            <label for="student-matricula-input" class="block text-sm font-medium text-gray-700">Matrícula</label>
                            <input type="text" id="student-matricula-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-name-input" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="student-name-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-class-input" class="block text-sm font-medium text-gray-700">Turma</label>
                            <input type="text" id="student-class-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-contato-input" class="block text-sm font-medium text-gray-700">Contato</label>
                            <input type="text" id="student-contato-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="student-endereco-input" class="block text-sm font-medium text-gray-700">Endereço</label>
                            <input type="text" id="student-endereco-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-resp1-input" class="block text-sm font-medium text-gray-700">Responsável 1</label>
                            <input type="text" id="student-resp1-input" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="student-resp2-input" class="block text-sm font-medium text-gray-700">Responsável 2</label>
                            <input type="text" id="student-resp2-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                        </div>
                        <div class="flex space-x-2 sm:col-span-2 self-end">
                             <button type="submit" id="save-student-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Salvar</button>
                             <button type="button" id="cancel-edit-student-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 hidden">Cancelar</button>
                        </div>
                    </form>
                </div>
                
                 <!-- Lista de Alunos -->
                <div>
                    <h4 class="text-lg font-semibold mb-2">Alunos Registados</h4>
                    <div id="students-list-container" class="border rounded-lg overflow-hidden">
                        <div class="overflow-y-auto max-h-64">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Turma</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="students-list-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Alunos serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Importação CSV -->
                <div class="border-t pt-6">
                     <h4 class="text-lg font-semibold mb-2">Importar em Massa</h4>
                    <p class="text-sm text-gray-600">Carregue um ficheiro CSV com as colunas: `matricula`, `nome`, `turma`, `endereco`, `contato`, `resp1`, `resp2`. Isto **substituirá** a lista de alunos atual.</p>
                    <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <button type="button" id="upload-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 whitespace-nowrap">Carregar CSV</button>
                    </div>
                    <div id="csv-feedback" class="text-sm mt-2"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="notification-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="notification-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="notification-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="notification-title" class="text-xl font-semibold">Notificação de Ocorrência</h3><button id="close-notification-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="notification-content" class="p-8 overflow-y-auto bg-white"></div><div id="notification-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="report-generator-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center"><h3 id="report-generator-title" class="text-xl font-semibold">Gerar Relatório por Aluno</h3><button id="close-report-generator-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div class="p-6 space-y-4"><div><label for="student-select" class="block text-sm font-medium text-gray-700">Selecione o Aluno(a)</label><select id="student-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"><option value="">Carregando...</option></select></div></div><div class="bg-gray-50 p-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" id="cancel-report-generator-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button><button type="button" id="create-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300">Gerar</button></div></div></div>
    <div id="report-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="report-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="report-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="report-view-title" class="text-xl font-semibold">Relatório</h3><button id="close-report-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="report-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="report-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="report-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="report-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="ficha-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="ficha-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="ficha-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="ficha-view-title" class="text-xl font-semibold">Visualizar Documento</h3><button id="close-ficha-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="ficha-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="ficha-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="ficha-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fas fa-share-alt mr-2"></i>Enviar</button><button id="ficha-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="p-6"><div class="text-center"><i class="fas fa-exclamation-triangle fa-3x text-red-500 mb-4"></i><h3 class="text-lg font-semibold text-gray-800">Confirmar Exclusão</h3><p id="delete-confirm-message" class="mt-2 text-sm text-gray-500">Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.</p></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg"><button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Excluir</button><button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></div></div>
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 z-50"><p id="toast-message"></p></div>

    <!-- Firebase and App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp, query, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ************************************************************************************
        // CONFIGURAÇÃO DO FIREBASE
        // ************************************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyCDWtwnD_3V9En9qEEYtlP_dpOTvt-P9ks",
            authDomain: "acompanhamento-vida-escolar.firebaseapp.com",
            projectId: "acompanhamento-vida-escolar",
            storageBucket: "acompanhamento-vida-escolar.appspot.com",
            messagingSenderId: "315669308837",
            appId: "1:315669308837:web:053497df9ceea4df5c4c9c"
        };
        // ************************************************************************************
        
        const config = {
            schoolName: "EMEF. DILMA DOS SANTOS CARVALHO",
            city: "Cidade (Exemplo)"
        };

        const state = {
            students: [],
            occurrences: [],
            absences: [],
            filterOccurrences: '',
            filterAbsences: '',
            activeTab: 'occurrences',
            recordToDelete: null,
            db: null,
            userId: null,
            unsubscribeOccurrences: null,
            unsubscribeAbsences: null
        };

        const dom = {
            loginScreen: document.getElementById('login-screen'),
            mainContent: document.getElementById('main-content'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
            showRegisterViewBtn: document.getElementById('show-register-view'),
            showLoginViewBtn: document.getElementById('show-login-view'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            logoutBtn: document.getElementById('logout-btn'),
            userProfile: document.getElementById('user-profile'),
            userEmail: document.getElementById('user-email'),
            occurrenceModal: document.getElementById('occurrence-modal'),
            absenceModal: document.getElementById('absence-modal'),
            studentsModal: document.getElementById('students-modal'),
            notificationModalBackdrop: document.getElementById('notification-modal-backdrop'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            reportGeneratorModal: document.getElementById('report-generator-modal'),
            reportViewModalBackdrop: document.getElementById('report-view-modal-backdrop'),
            fichaViewModalBackdrop: document.getElementById('ficha-view-modal-backdrop'),
            occurrencesListDiv: document.getElementById('occurrences-list'),
            absencesListDiv: document.getElementById('absences-list'),
            emptyStateOccurrences: document.getElementById('empty-state-occurrences'),
            emptyStateAbsences: document.getElementById('empty-state-absences'),
            loadingOccurrences: document.getElementById('loading-occurrences'),
            loadingAbsences: document.getElementById('loading-absences'),
            occurrenceForm: document.getElementById('occurrence-form'),
            absenceForm: document.getElementById('absence-form'),
            tabOccurrences: document.getElementById('tab-occurrences'),
            tabAbsences: document.getElementById('tab-absences'),
            tabContentOccurrences: document.getElementById('tab-content-occurrences'),
            tabContentAbsences: document.getElementById('tab-content-absences'),
            searchOccurrences: document.getElementById('search-occurrences'),
            searchAbsences: document.getElementById('search-absences'),
        };

        const actionDisplayTitles = {
            tentativa_1: "1ª Tentativa de Contato",
            tentativa_2: "2ª Tentativa de Contato",
            tentativa_3: "3ª Tentativa de Contato",
            visita: "Visita In Loco",
            encaminhamento_ct: "Encaminhamento ao Conselho Tutelar",
            analise: "Análise"
        };

        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
        const formatTime = (timeString) => timeString || '';
        const formatText = (text) => text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'Não informado';
        const formatPeriodo = (start, end) => {
            if (start && end) return `de ${formatDate(start)} a ${formatDate(end)}`;
            if (start) return `a partir de ${formatDate(start)}`;
            if (end) return `até ${formatDate(end)}`;
            return 'Não informado';
        }
        
        const showToast = (message) => {
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            document.getElementById('toast-notification').classList.add('show');
            setTimeout(() => document.getElementById('toast-notification').classList.remove('show'), 3000);
        };
        
        const openModal = (modalElement) => {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                modalElement.firstElementChild.classList.remove('scale-95', 'opacity-0');
            }, 10);
        };

        const closeModal = (modalElement) => {
            if (!modalElement) return;
            modalElement.classList.add('opacity-0');
            modalElement.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modalElement.classList.add('hidden'), 300);
        };

        const enhanceTextForSharing = (title, text) => {
            let enhancedText = text;

            if (title.toLowerCase().includes('ocorrência')) {
                enhancedText = `*📢 NOTIFICAÇÃO DE OCORRÊNCIA ESCOLAR 📢*\n\n${text}`;
            } else if (title.toLowerCase().includes('relatório')) {
                enhancedText = `*📋 RELATÓRIO DE OCORRÊNCIAS 📋*\n\n${text}`;
            } else if (title.toLowerCase().includes('ficha')) {
                enhancedText = `*📈 FICHA DE ACOMPANHAMENTO 📈*\n\n${text}`;
            }

            enhancedText = enhancedText.replace(/Aos Responsáveis/g, '👥 Aos Responsáveis');
            enhancedText = enhancedText.replace(/Aluno\(a\):/g, '👤 Aluno(a):');
            enhancedText = enhancedText.replace(/Turma:/g, '🏫 Turma:');
            enhancedText = enhancedText.replace(/Data:/g, '🗓️ Data:');
            enhancedText = enhancedText.replace(/Horário:/g, '⏰ Horário:');
            enhancedText = enhancedText.replace(/Descrição:/g, '📝 Descrição:');
            enhancedText = enhancedText.replace(/Providências da Escola:/g, '🏛️ Providências da Escola:');
            enhancedText = enhancedText.replace(/Providências da Família:/g, '👨‍👩‍👧‍👦 Providências da Família:');

            enhancedText += `\n\n-------------\n_Mensagem enviada pelo Sistema de Acompanhamento Pedagógico._`;

            return enhancedText;
        };
        
        const getStudentProcessInfo = (studentId) => {
            const studentActions = state.absences
                .filter(a => a.studentId === studentId)
                .sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

            let lastAnaliseIndex = -1;
            for (let i = studentActions.length - 1; i >= 0; i--) {
                if (studentActions[i].actionType === 'analise') {
                    lastAnaliseIndex = i;
                    break;
                }
            }
            
            const currentCycleActions = studentActions.slice(lastAnaliseIndex + 1);
            
            let processId;
            const existingProcessAction = currentCycleActions.find(a => a.processId);

            if (existingProcessAction) {
                processId = existingProcessAction.processId;
            } else {
                const allProcessIdsForStudent = state.absences.filter(a => a.studentId === studentId)
                    .map(a => a.processId)
                    .filter(Boolean);
                
                const processNumbers = allProcessIdsForStudent
                    .map(pid => parseInt(pid.split('-')[1] || 0, 10))
                    .filter(num => !isNaN(num));
                    
                const maxNumber = processNumbers.length > 0 ? Math.max(...processNumbers) : 0;
                processId = `${studentId}-${maxNumber + 1}`;
            }

            return {
                currentCycleActions,
                processId
            };
        };

        const determineNextActionForStudent = (studentId) => {
            const { currentCycleActions } = getStudentProcessInfo(studentId);
            const sequence = ['tentativa_1', 'tentativa_2', 'tentativa_3', 'visita', 'encaminhamento_ct', 'analise'];
            const existingActionTypes = new Set(currentCycleActions.map(a => a.actionType));

            const hasReturnedInCurrentCycle = currentCycleActions.some(
                a => a.contactReturned === 'yes' || a.visitReturned === 'yes' || a.ctReturned === 'yes'
            );

            if (hasReturnedInCurrentCycle && !existingActionTypes.has('analise')) {
                return 'analise';
            }

            for (const action of sequence) {
                if (!existingActionTypes.has(action)) {
                    return action;
                }
            }
            
            return 'analise'; // Fallback
        };

        const shareContent = async (title, text) => {
            const enhancedText = enhanceTextForSharing(title, text);
            if (navigator.share) {
                try {
                    await navigator.share({ title, text: enhancedText });
                } catch (error) {
                    console.error('Erro ao partilhar:', error);
                    showToast('Erro ao partilhar o conteúdo.');
                }
            } else {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(enhancedText)}`;
                window.open(whatsappUrl, '_blank');
            }
        };

        const renderOccurrences = () => {
            dom.loadingOccurrences.classList.add('hidden');
            const filtered = state.occurrences
                .filter(o => {
                    const student = state.students.find(s => s.matricula === o.studentId);
                    return student && student.name.toLowerCase().startsWith(state.filterOccurrences.toLowerCase());
                })
                .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            if (filtered.length === 0 && state.filterOccurrences === '') {
                dom.emptyStateOccurrences.classList.remove('hidden');
                dom.occurrencesListDiv.innerHTML = '';
            } else {
                dom.emptyStateOccurrences.classList.add('hidden');
                dom.occurrencesListDiv.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno(a)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Turma</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filtered.map(occ => {
                                const student = state.students.find(s => s.matricula === occ.studentId);
                                const studentName = student ? student.name : 'Aluno Removido';
                                const studentClass = student ? student.class : 'N/A';
                                return `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${studentName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${studentClass}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(occ.date)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <button class="view-btn text-indigo-600 hover:text-indigo-900" data-id="${occ.id}" title="Ver Notificação"><i class="fas fa-eye"></i></button>
                                        <button class="edit-btn text-yellow-600 hover:text-yellow-900" data-id="${occ.id}" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-btn text-red-600 hover:text-red-900" data-id="${occ.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>`;
            }
        };

        const renderAbsences = () => {
            dom.loadingAbsences.classList.add('hidden');
            const filtered = state.absences
                .filter(a => {
                    const student = state.students.find(s => s.matricula === a.studentId);
                    return student && student.name.toLowerCase().startsWith(state.filterAbsences.toLowerCase());
                });

            if (filtered.length === 0 && state.filterAbsences === '') {
                dom.emptyStateAbsences.classList.remove('hidden');
                dom.absencesListDiv.innerHTML = '';
            } else {
                dom.emptyStateAbsences.classList.add('hidden');
                
                const groupedByProcess = filtered.reduce((acc, action) => {
                    const key = action.processId || `no-proc-${action.id}`; 
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(action);
                    return acc;
                }, {});

                const sortedGroupKeys = Object.keys(groupedByProcess).sort((a, b) => {
                    const lastActionA = groupedByProcess[a].sort((x, y) => (y.createdAt?.seconds || 0) - (x.createdAt?.seconds || 0))[0];
                    const lastActionB = groupedByProcess[b].sort((x, y) => (y.createdAt?.seconds || 0) - (x.createdAt?.seconds || 0))[0];
                    return (lastActionB.createdAt?.seconds || 0) - (lastActionA.createdAt?.seconds || 0);
                });

                let html = '';
                for (const processId of sortedGroupKeys) {
                    const actions = groupedByProcess[processId].sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    const firstAction = actions[0];
                    const student = state.students.find(s => s.matricula === firstAction.studentId);
                    if (!student) continue;

                     html += `
                        <div class="border rounded-lg overflow-hidden mb-4 bg-white shadow">
                            <div class="process-header bg-gray-50 hover:bg-gray-100 cursor-pointer p-4 flex justify-between items-center" data-process-id="${processId}">
                                <div>
                                    <p class="font-semibold text-gray-800">${student.name}</p>
                                    <p class="text-sm text-gray-500">ID do Processo: ${processId} - Início: ${formatDate(firstAction.createdAt?.toDate())}</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                     <button class="generate-ficha-btn-row bg-purple-600 text-white font-bold py-1 px-3 rounded-lg shadow-md hover:bg-purple-700 text-xs no-print" data-student-id="${student.matricula}" data-process-id="${processId}">
                                        <i class="fas fa-file-invoice"></i> Ficha
                                    </button>
                                    <i class="fas fa-chevron-down transition-transform duration-300"></i>
                                </div>
                            </div>
                            <div class="process-content" id="content-${processId}">
                                <div class="p-4 border-t border-gray-200">
                                    <div class="space-y-4">
                    `;
                    
                    actions.forEach(abs => {
                        const actionDate = abs.contactDate || abs.visitDate || abs.ctSentDate || (abs.createdAt?.toDate() ? abs.createdAt.toDate().toISOString().split('T')[0] : '');
                        const returned = abs.contactReturned === 'yes' || abs.visitReturned === 'yes' || abs.ctReturned === 'yes';
                        
                        let actionButtonHtml = '';
                        if (abs.actionType.startsWith('tentativa')) {
                            actionButtonHtml = `<button class="notification-btn text-indigo-600 hover:text-indigo-900 text-xs font-semibold py-1 px-2 rounded-md bg-indigo-50" data-id="${abs.id}" title="Gerar Notificação">Notificação</button>`;
                        } else if (abs.actionType === 'visita') {
                             actionButtonHtml = `<button class="send-ct-btn text-blue-600 hover:text-blue-900 text-xs font-semibold py-1 px-2 rounded-md bg-blue-50" data-id="${abs.id}" title="Enviar ao Conselho Tutelar">Enviar ao C.T.</button>`;
                        } else {
                            actionButtonHtml = `<span class="inline-block w-24"></span>`; // Placeholder for alignment
                        }

                        html += `
                            <div class="flex justify-between items-start border-b last:border-b-0 pb-3">
                                <div>
                                    <p class="font-medium text-gray-700">${actionDisplayTitles[abs.actionType] || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">Data: ${formatDate(actionDate)}</p>
                                    ${returned ? '<p class="text-sm text-green-600 font-semibold mt-1"><i class="fas fa-check-circle"></i> Aluno Retornou</p>' : ''}
                                </div>
                                <div class="whitespace-nowrap text-right text-sm font-medium space-x-2 flex items-center">
                                    ${actionButtonHtml}
                                    <button class="edit-absence-btn text-yellow-600 hover:text-yellow-900" data-id="${abs.id}" title="Editar Ação"><i class="fas fa-pencil-alt fa-lg"></i></button>
                                    <button class="delete-absence-btn text-red-600 hover:text-red-900" data-id="${abs.id}" title="Excluir Ação"><i class="fas fa-trash fa-lg"></i></button>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                dom.absencesListDiv.innerHTML = html;
            }
        };

        const render = () => {
            if (state.activeTab === 'occurrences') renderOccurrences();
            else renderAbsences();
        };

        const getStudentsDocRef = () => {
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
             return doc(state.db, `/artifacts/${appId}/public/data/school-data`, 'students');
        };

        const getCollectionRef = (type) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionName = type === 'occurrence' ? 'occurrences' : 'absences';
            return collection(state.db, `/artifacts/${appId}/public/data/${collectionName}`);
        };
        const addRecord = (type, data) => addDoc(getCollectionRef(type), { ...data, createdAt: serverTimestamp() });
        const updateRecord = (type, id, data) => setDoc(doc(getCollectionRef(type), id), data, { merge: true });
        const deleteRecord = (type, id) => deleteDoc(doc(getCollectionRef(type), id));

        const setupFirestoreListeners = async () => {
            if (!state.userId) return;

            try {
                const docSnap = await getDoc(getStudentsDocRef());
                if (docSnap.exists() && docSnap.data().list) {
                    state.students = docSnap.data().list;
                    renderStudentsList();
                } else {
                    console.log("Nenhuma lista de alunos encontrada no Firestore.");
                }
            } catch (error) {
                console.error("Erro ao carregar lista de alunos:", error);
                showToast("Erro ao carregar a lista de alunos.");
            }

            if (state.unsubscribeOccurrences) state.unsubscribeOccurrences();
            state.unsubscribeOccurrences = onSnapshot(query(getCollectionRef('occurrence')), (snapshot) => {
                state.occurrences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'occurrences') render();
            }, (error) => console.error("Erro ao buscar ocorrências:", error));

            if (state.unsubscribeAbsences) state.unsubscribeAbsences();
            state.unsubscribeAbsences = onSnapshot(query(getCollectionRef('absence')), (snapshot) => {
                state.absences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'absences') render();
            }, (error) => console.error("Erro ao buscar ações:", error));
        };

        const detachFirestoreListeners = () => {
            if (state.unsubscribeOccurrences) {
                state.unsubscribeOccurrences();
                state.unsubscribeOccurrences = null;
            }
            if (state.unsubscribeAbsences) {
                state.unsubscribeAbsences();
                state.unsubscribeAbsences = null;
            }
        };

        const openNotificationModal = (id) => {
            const data = state.occurrences.find(occ => occ.id === id);
            if (data) {
                const student = state.students.find(s => s.matricula === data.studentId) || {name: 'Aluno Removido', class: 'N/A', resp1: '', resp2: ''};
                document.getElementById('notification-title').innerText = 'Notificação de Ocorrência Escolar';
                 const responsaveis = [student.resp1, student.resp2].filter(Boolean).join(' e ');
                document.getElementById('notification-content').innerHTML = `
                    <div class="space-y-6 text-sm"><div class="text-center border-b pb-4"><h2 class="text-xl font-bold uppercase">${config.schoolName}</h2><h3 class="text-lg font-semibold mt-2">NOTIFICAÇÃO DE OCORRÊNCIA ESCOLAR</h3></div>
                    <div class="pt-4"><p class="mb-2"><strong>Aos Responsáveis (${responsaveis}) pelo(a) aluno(a):</strong></p><p class="text-lg font-semibold">${formatText(student.name)}</p><p class="text-gray-600"><strong>Turma:</strong> ${formatText(student.class)}</p></div>
                    <p class="text-justify">Prezados(as), vimos por meio desta notificá-los sobre uma ocorrência disciplinar envolvendo o(a) aluno(a) supracitado(a), registrada em <strong>${formatDate(data.date)}</strong>.</p>
                    <div class="border-t pt-4 space-y-4">
                        <div><h4 class="font-semibold mb-1">Descrição:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.description)}</p></div>
                        <div><h4 class="font-semibold mb-1">Pessoas Envolvidas:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.involved)}</p></div>
                        <div><h4 class="font-semibold mb-1">Providências da Escola:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.actionsTakenSchool)}</p></div>
                        <div><h4 class="font-semibold mb-1">Providências da Família:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.actionsTakenFamily)}</p></div>
                    </div>
                    <p class="mt-4 text-justify">Diante do exposto, solicitamos o comparecimento de um responsável na coordenação pedagógica para uma reunião na seguinte data e horário:</p>
                    <div class="mt-4 p-3 bg-indigo-100 text-indigo-800 rounded-md text-center font-semibold"><p><strong>Data:</strong> ${formatDate(data.meetingDate) || 'A ser agendada'}</p><p><strong>Horário:</strong> ${formatTime(data.meetingTime) || ''}</p></div>
                    <div class="border-t pt-16 mt-16"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="text-center mt-1">Ciente do Responsável</p></div></div></div>`;
                openModal(dom.notificationModalBackdrop);
            }
        };
        
        const openFichaViewModal = (id) => {
            const record = state.absences.find(abs => abs.id === id);
            if (!record) return showToast('Registro não encontrado.');
            const student = state.students.find(s => s.matricula === record.studentId) || {name: 'Aluno Removido', class: 'N/A'};
            
            const attemptLabels = { tentativa_1: "primeira", tentativa_2: "segunda", tentativa_3: "terceira" };
            const title = actionDisplayTitles[record.actionType] || 'Notificação de Busca Ativa';
            
            let body = '';
            switch (record.actionType) {
                case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                    body = `<p class="mt-4 text-justify">Vimos por meio desta notificá-los que o(a) estudante acumulou <strong>${formatText(record.absenceCount)} faltas</strong> no período ${formatPeriodo(record.periodoFaltasStart, record.periodoFaltasEnd)}.</p><p class="mt-4 text-justify">Esta é a <strong>${attemptLabels[record.actionType]} tentativa de contato</strong>. Solicitamos o comparecimento de um responsável na data e horário abaixo:</p><div class="mt-4 p-3 bg-gray-100 rounded-md text-center"><p><strong>Data:</strong> ${formatDate(record.meetingDate)}</p><p><strong>Horário:</strong> ${formatTime(record.meetingTime)}</p></div>`;
                    break;
                case 'visita':
                    body = `<p class="mt-4">Notificamos que na data de <strong>${formatDate(record.visitDate)}</strong>, o agente escolar <strong>${formatText(record.visitAgent)}</strong> realizou uma visita domiciliar.</p><p class="mt-2"><strong>Justificativa do responsável:</strong> ${formatText(record.visitReason)}</p>`;
                    break;
                default: body = `<p class="mt-4">Registro de ação administrativa referente à busca ativa do(a) aluno(a).</p>`; break;
            }

            const contentHTML = `<div class="space-y-6 text-sm text-gray-800"><div class="text-center border-b pb-4"><h2 class="text-lg font-bold uppercase">${config.schoolName}</h2><h3 class="font-semibold mt-1 uppercase">${title}</h3></div><div class="pt-4"><p><strong>Aluno(a):</strong> ${student.name}</p><p><strong>Turma:</strong> ${student.class || ''}</p></div><div class="text-justify">${body}</div><div class="border-t pt-16 mt-16"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="text-center mt-1">Ciente do Responsável</p></div></div></div>`;

            document.getElementById('ficha-view-title').textContent = title;
            document.getElementById('ficha-view-content').innerHTML = contentHTML;
            openModal(dom.fichaViewModalBackdrop);
        };
        
        const openReportGeneratorModal = (reportType) => {
            const records = reportType === 'occurrences' ? state.occurrences : state.absences;
            const studentIds = [...new Set(records.map(item => item.studentId))];
            const studentsInRecords = state.students.filter(s => studentIds.includes(s.matricula)).sort((a,b) => a.name.localeCompare(b.name));

            const select = document.getElementById('student-select');
            
            const title = reportType === 'occurrences' ? 'Gerar Relatório de Ocorrências' : 'Gerar Ficha Consolidada';
            document.getElementById('report-generator-title').textContent = title;
            dom.reportGeneratorModal.dataset.reportType = reportType;
            
            select.innerHTML = studentsInRecords.length > 0
                ? '<option value="">Selecione um aluno...</option>' + studentsInRecords.map(s => `<option value="${s.matricula}">${s.name}</option>`).join('')
                : '<option value="">Nenhum aluno com registros</option>';
            openModal(dom.reportGeneratorModal);
        };
        
        const generateAndShowReport = (studentId) => {
            const studentOccurrences = state.occurrences.filter(occ => occ.studentId === studentId).sort((a, b) => new Date(a.date) - new Date(b.date));
            if (studentOccurrences.length === 0) return showToast('Nenhuma ocorrência para este aluno.');

            const studentData = state.students.find(s => s.matricula === studentId);
            const currentDate = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

            const reportHTML = `<div class="space-y-6 text-sm"><div class="text-center border-b pb-4"><h2 class="text-xl font-bold uppercase">${config.schoolName}</h2><h3 class="text-lg font-semibold mt-2">RELATÓRIO DE OCORRÊNCIAS</h3></div><div class="pt-4 text-left"><p><strong>ALUNO(A):</strong> ${studentData.name}</p><p><strong>TURMA:</strong> ${studentData.class}</p><p><strong>DATA:</strong> ${currentDate}</p></div>${studentOccurrences.map((occ, index) => `<div class="border-t pt-4 mt-4"><h4 class="font-semibold mb-2 text-base">OCORRÊNCIA ${index + 1} - Data: ${formatDate(occ.date)}</h4><div class="pl-4 border-l-2 border-gray-200 space-y-2"><div><p class="font-medium">Descrição:</p><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(occ.description)}</p></div><div><p class="font-medium">Providências da Escola:</p><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(occ.actionsTakenSchool)}</p></div></div></div>`).join('')}<div class="border-t pt-16 mt-8"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="mt-1">Assinatura da Coordenação</p></div></div></div>`;
            
            document.getElementById('report-view-title').textContent = "Relatório de Ocorrências";
            document.getElementById('report-view-content').innerHTML = reportHTML;
            openModal(dom.reportViewModalBackdrop);
        };
        
        const generateAndShowConsolidatedFicha = (studentId, processId = null) => {
            let studentActions = state.absences.filter(action => action.studentId === studentId);
            
            if (processId) {
                studentActions = studentActions.filter(action => action.processId === processId);
            }

            studentActions.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));

            if (studentActions.length === 0) return showToast('Nenhuma ação para este aluno neste processo.');
            const studentData = state.students.find(s => s.matricula === studentId);

            const findAction = (type) => studentActions.find(a => a.actionType === type) || {};
            const t1 = findAction('tentativa_1'), t2 = findAction('tentativa_2'), t3 = findAction('tentativa_3'), visita = findAction('visita'), ct = findAction('encaminhamento_ct'), analise = findAction('analise');
            
            const faltasData = t1.periodoFaltasStart ? t1 : (t2.periodoFaltasStart ? t2 : (t3.periodoFaltasStart ? t3 : (visita.periodoFaltasStart ? visita : {})));

            const fichaHTML = `
                <div class="space-y-4 text-sm">
                    <div class="text-center border-b pb-4">
                        <h2 class="text-lg font-bold uppercase">${config.schoolName}</h2>
                        <h3 class="font-semibold mt-1">Ficha de Acompanhamento da Busca Ativa</h3>
                    </div>
                    
                    <div class="border rounded-md p-3">
                        <h4 class="font-semibold text-base mb-2">Identificação</h4>
                        <p><strong>Nome do aluno:</strong> ${studentData.name}</p>
                        <p><strong>Ano/Ciclo:</strong> ${studentData.class || ''}</p>
                        <p><strong>Endereço:</strong> ${formatText(studentData.endereco)}</p>
                        <p><strong>Contato:</strong> ${formatText(studentData.contato)}</p>
                    </div>

                    <div class="border rounded-md p-3">
                         <h4 class="font-semibold text-base mb-2">Faltas apuradas no período de:</h4>
                         <p><strong>Data de início:</strong> ${formatDate(faltasData.periodoFaltasStart)}</p>
                         <p><strong>Data de fim:</strong> ${formatDate(faltasData.periodoFaltasEnd)}</p>
                         <p><strong>Nº de faltas:</strong> ${formatText(faltasData.absenceCount)}</p>
                    </div>

                    <div class="border rounded-md p-3 space-y-3">
                        <h4 class="font-semibold text-base">Tentativas de contato com o responsável pelo estudante (ligações, whatsApp ou carta ao responsável)</h4>
                        <div class="pl-4">
                            <p class="font-medium underline">1ª Tentativa:</p>
                            <p><strong>Conseguiu contato?</strong> ${t1.contactSucceeded === 'yes' ? 'Sim' : t1.contactSucceeded === 'no' ? 'Não' : ''}</p>
                            <p><strong>Dia do contato:</strong> ${formatDate(t1.contactDate)}</p>
                            <p><strong>Com quem falou?</strong> ${formatText(t1.contactPerson)}</p>
                            <p><strong>Justificativa:</strong> ${formatText(t1.contactReason)}</p>
                            <p><strong>Aluno retornou?</strong> ${t1.contactReturned === 'yes' ? 'Sim' : t1.contactReturned === 'no' ? 'Não' : ''}</p>
                        </div>
                        <div class="pl-4 border-t pt-2">
                            <p class="font-medium underline">2ª Tentativa:</p>
                            <p><strong>Conseguiu contato?</strong> ${t2.contactSucceeded === 'yes' ? 'Sim' : t2.contactSucceeded === 'no' ? 'Não' : ''}</p>
                            <p><strong>Dia do contato:</strong> ${formatDate(t2.contactDate)}</p>
                            <p><strong>Com quem falou?</strong> ${formatText(t2.contactPerson)}</p>
                            <p><strong>Justificativa:</strong> ${formatText(t2.contactReason)}</p>
                            <p><strong>Aluno retornou?</strong> ${t2.contactReturned === 'yes' ? 'Sim' : t2.contactReturned === 'no' ? 'Não' : ''}</p>
                        </div>
                        <div class="pl-4 border-t pt-2">
                            <p class="font-medium underline">3ª Tentativa:</p>
                            <p><strong>Conseguiu contato?</strong> ${t3.contactSucceeded === 'yes' ? 'Sim' : t3.contactSucceeded === 'no' ? 'Não' : ''}</p>
                            <p><strong>Dia do contato:</strong> ${formatDate(t3.contactDate)}</p>
                            <p><strong>Com quem falou?</strong> ${formatText(t3.contactPerson)}</p>
                            <p><strong>Justificativa:</strong> ${formatText(t3.contactReason)}</p>
                            <p><strong>Aluno retornou?</strong> ${t3.contactReturned === 'yes' ? 'Sim' : t3.contactReturned === 'no' ? 'Não' : ''}</p>
                        </div>
                    </div>

                    <div class="border rounded-md p-3 space-y-2">
                        <h4 class="font-semibold text-base">Contato in loco/Conversa com o responsável</h4>
                        <p><strong>Nome do agente que realizou a visita:</strong> ${formatText(visita.visitAgent)}</p>
                        <p><strong>Dia da visita:</strong> ${formatDate(visita.visitDate)}</p>
                        <p><strong>Conseguiu contato?</strong> ${visita.visitSucceeded === 'yes' ? 'Sim' : visita.visitSucceeded === 'no' ? 'Não' : ''}</p>
                        <p><strong>Com quem falou?</strong> ${formatText(visita.visitContactPerson)}</p>
                        <p><strong>Justificativa:</strong> ${formatText(visita.visitReason)}</p>
                        <p><strong>Aluno retornou?</strong> ${visita.visitReturned === 'yes' ? 'Sim' : visita.visitReturned === 'no' ? 'Não' : ''}</p>
                        <p><strong>Observação:</strong> ${formatText(visita.visitObs)}</p>
                    </div>

                    <div class="border rounded-md p-3 space-y-2">
                        <h4 class="font-semibold text-base">Encaminhamento ao Conselho Tutelar</h4>
                        <p><strong>Data de envio:</strong> ${formatDate(ct.ctSentDate)}</p>
                        <p><strong>Devolutiva:</strong> ${formatText(ct.ctFeedback)}</p>
                        <p><strong>Aluno retornou?</strong> ${ct.ctReturned === 'yes' ? 'Sim' : ct.ctReturned === 'no' ? 'Não' : ''}</p>
                    </div>

                     <div class="border rounded-md p-3 space-y-2">
                        <h4 class="font-semibold text-base">Análise</h4>
                        <p><strong>Parecer da BAE:</strong> ${formatText(analise.ctParecer)}</p>
                    </div>
                    
                    <div class="signature-block pt-16 mt-8 space-y-12">
                        <div class="text-center w-2/3 mx-auto">
                            <div class="border-t border-gray-400"></div>
                            <p class="mt-1">Diretor(a)</p>
                        </div>
                         <div class="text-center w-2/3 mx-auto">
                            <div class="border-t border-gray-400"></div>
                            <p class="mt-1">Coordenador(a) Pedagógico(a)</p>
                        </div>
                    </div>
                </div>`;
            document.getElementById('report-view-title').textContent = "Ficha Consolidada de Busca Ativa";
            document.getElementById('report-view-content').innerHTML = fichaHTML;
            openModal(dom.reportViewModalBackdrop);
        };

        const toggleFamilyContactFields = (enable) => {
            const fieldsContainer = document.getElementById('family-contact-fields');
            const inputs = fieldsContainer.querySelectorAll('input, textarea');
            
            inputs.forEach(input => {
                input.disabled = !enable;
                if (!enable) {
                    input.classList.add('bg-gray-200', 'cursor-not-allowed');
                } else {
                    input.classList.remove('bg-gray-200', 'cursor-not-allowed');
                }
            });
             // Limpar os campos se estiver desabilitado, exceto os botões de rádio
            if (!enable) {
                fieldsContainer.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(el => el.value = '');
                fieldsContainer.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
            }
        };

        const toggleVisitContactFields = (enable) => {
            const fieldsContainer = document.getElementById('visit-contact-fields');
            const inputs = fieldsContainer.querySelectorAll('input, textarea');
            
            inputs.forEach(input => {
                input.disabled = !enable;
                if (!enable) {
                    input.classList.add('bg-gray-200', 'cursor-not-allowed');
                } else {
                    input.classList.remove('bg-gray-200', 'cursor-not-allowed');
                }
            });
             if (!enable) {
                fieldsContainer.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(el => el.value = '');
                fieldsContainer.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
            }
        };

        const openAbsenceModalForStudent = (student, forceActionType = null, data = null) => {
            dom.absenceForm.reset();

            const isEditing = !!data;
            document.getElementById('absence-modal-title').innerText = isEditing ? 'Editar Ação de Busca Ativa' : 'Registar Ação de Busca Ativa';
            document.getElementById('absence-id').value = isEditing ? data.id : '';

            // Preencher dados do aluno
            document.getElementById('absence-student-name').value = student.name || '';
            document.getElementById('absence-student-class').value = student.class || '';
            document.getElementById('absence-student-endereco').value = student.endereco || '';
            document.getElementById('absence-student-contato').value = student.contato || '';
            
            const { processId, currentCycleActions } = getStudentProcessInfo(student.matricula);
            document.getElementById('absence-process-id').value = data?.processId || processId;


            const finalActionType = forceActionType || determineNextActionForStudent(student.matricula);
            document.getElementById('action-type').value = finalActionType;
            document.getElementById('action-type-display').value = actionDisplayTitles[finalActionType] || '';
            document.getElementById('action-type').dispatchEvent(new Event('change'));

            // Lógica para persistir dados de faltas
            const absenceFieldsContainer = dom.absenceForm.querySelector('#absence-form > .bg-gray-50');
            const absenceInputs = absenceFieldsContainer.querySelectorAll('input');
            
            const firstAbsenceRecordInCycle = currentCycleActions.find(a => a.periodoFaltasStart);


            if (finalActionType !== 'tentativa_1' && firstAbsenceRecordInCycle) {
                document.getElementById('absence-start-date').value = firstAbsenceRecordInCycle.periodoFaltasStart || '';
                document.getElementById('absence-end-date').value = firstAbsenceRecordInCycle.periodoFaltasEnd || '';
                document.getElementById('absence-count').value = firstAbsenceRecordInCycle.absenceCount || '';
                absenceInputs.forEach(input => input.readOnly = true);
            } else {
                absenceInputs.forEach(input => input.readOnly = false);
            }
            
            // Preencher dados da ação se estiver editando
            if (isEditing) {
                document.getElementById('absence-start-date').value = data.periodoFaltasStart || firstAbsenceRecordInCycle?.periodoFaltasStart || '';
                document.getElementById('absence-end-date').value = data.periodoFaltasEnd || firstAbsenceRecordInCycle?.periodoFaltasEnd || '';
                document.getElementById('absence-count').value = data.absenceCount || firstAbsenceRecordInCycle?.absenceCount || '';

                switch (data.actionType) {
                    case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                        document.getElementById('meeting-date').value = data.meetingDate || '';
                        document.getElementById('meeting-time').value = data.meetingTime || '';
                        document.getElementById('contact-date').value = data.contactDate || '';
                        document.getElementById('contact-person').value = data.contactPerson || '';
                        document.getElementById('contact-reason').value = data.contactReason || '';
                        if(data.contactSucceeded) document.querySelector(`input[name="contact-succeeded"][value="${data.contactSucceeded}"]`).checked = true;
                        toggleFamilyContactFields(data.contactSucceeded === 'yes');
                        if(data.contactReturned) document.querySelector(`input[name="contact-returned"][value="${data.contactReturned}"]`).checked = true;
                        break;
                    case 'visita':
                        document.getElementById('visit-agent').value = data.visitAgent || '';
                        document.getElementById('visit-date').value = data.visitDate || '';
                        document.getElementById('visit-contact-person').value = data.visitContactPerson || '';
                        document.getElementById('visit-reason').value = data.visitReason || '';
                        document.getElementById('visit-obs').value = data.visitObs || '';
                        if(data.visitSucceeded) document.querySelector(`input[name="visit-succeeded"][value="${data.visitSucceeded}"]`).checked = true;
                        toggleVisitContactFields(data.visitSucceeded === 'yes');
                        if (data.visitReturned) document.querySelector(`input[name="visit-returned"][value="${data.visitReturned}"]`).checked = true;
                        break;
                    case 'encaminhamento_ct':
                        document.getElementById('ct-sent-date').value = data.ctSentDate || '';
                        document.getElementById('ct-feedback').value = data.ctFeedback || '';
                        if (data.ctReturned) document.querySelector(`input[name="ct-returned"][value="${data.ctReturned}"]`).checked = true;
                        break;
                    case 'analise':
                        document.getElementById('ct-parecer').value = data.ctParecer || '';
                        break;
                }
            }
            
            openModal(dom.absenceModal);
        };
        
        const setupEventListeners = () => {
            dom.showRegisterViewBtn.addEventListener('click', showRegisterView);
            dom.showLoginViewBtn.addEventListener('click', showLoginView);

            dom.tabOccurrences.addEventListener('click', () => { state.activeTab = 'occurrences'; dom.tabOccurrences.classList.add('tab-active'); dom.tabAbsences.classList.remove('tab-active'); dom.tabContentOccurrences.classList.remove('hidden'); dom.tabContentAbsences.classList.add('hidden'); render(); });
            dom.tabAbsences.addEventListener('click', () => { state.activeTab = 'absences'; dom.tabAbsences.classList.add('tab-active'); dom.tabOccurrences.classList.remove('tab-active'); dom.tabContentAbsences.classList.remove('hidden'); dom.tabContentOccurrences.classList.add('hidden'); render(); });

            // Listeners dos botões de partilha
            document.getElementById('share-btn').addEventListener('click', () => {
                const title = document.getElementById('notification-title').textContent;
                const content = document.getElementById('notification-content').innerText;
                shareContent(title, content);
            });

            document.getElementById('report-share-btn').addEventListener('click', () => {
                const title = document.getElementById('report-view-title').textContent;
                const content = document.getElementById('report-view-content').innerText;
                shareContent(title, content);
            });

            document.getElementById('ficha-share-btn').addEventListener('click', () => {
                const title = document.getElementById('ficha-view-title').textContent;
                const content = document.getElementById('ficha-view-content').innerText;
                shareContent(title, content);
            });


            ['close-modal-btn', 'cancel-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.occurrenceModal)));
            ['close-absence-modal-btn', 'cancel-absence-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.absenceModal)));
            ['close-report-generator-btn', 'cancel-report-generator-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.reportGeneratorModal)));
            document.getElementById('close-notification-btn').addEventListener('click', () => closeModal(dom.notificationModalBackdrop));
            document.getElementById('close-report-view-btn').addEventListener('click', () => closeModal(dom.reportViewModalBackdrop));
            document.getElementById('close-ficha-view-btn').addEventListener('click', () => closeModal(dom.fichaViewModalBackdrop));
            document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal(dom.deleteConfirmModal));
            document.getElementById('print-btn').addEventListener('click', () => window.print());
            document.getElementById('report-print-btn').addEventListener('click', () => window.print());
            document.getElementById('ficha-print-btn').addEventListener('click', () => window.print());

            dom.occurrenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('occurrence-id').value;
                const studentName = document.getElementById('student-name').value.trim();
                const student = state.students.find(s => s.name === studentName);
                if (!student) {
                    showToast("Aluno inválido. Por favor, selecione um aluno da lista.");
                    return;
                }
                const data = { 
                    studentId: student.matricula,
                    date: document.getElementById('occurrence-date').value, 
                    description: document.getElementById('description').value.trim(), 
                    involved: document.getElementById('involved').value.trim(), 
                    actionsTakenSchool: document.getElementById('actions-taken-school').value.trim(), 
                    actionsTakenFamily: document.getElementById('actions-taken-family').value.trim(), 
                    meetingDate: document.getElementById('meeting-date-occurrence').value, 
                    meetingTime: document.getElementById('meeting-time-occurrence').value 
                };
                try { id ? await updateRecord('occurrence', id, data) : await addRecord('occurrence', data); showToast(`Ocorrência ${id ? 'atualizada' : 'registada'} com sucesso!`); closeModal(dom.occurrenceModal); } catch (error) { console.error("Erro:", error); showToast('Erro ao salvar.'); }
            });

            dom.absenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('absence-id').value;
                const studentName = document.getElementById('absence-student-name').value.trim();
                const student = state.students.find(s => s.name === studentName);
                if (!student) {
                    showToast("Aluno inválido. Por favor, selecione um aluno da lista.");
                    return;
                }
                const actionType = document.getElementById('action-type').value;
                const processId = document.getElementById('absence-process-id').value;
                const data = { 
                    studentId: student.matricula,
                    actionType,
                    processId
                };

                try {
                     data.periodoFaltasStart = document.getElementById('absence-start-date').value || null;
                     data.periodoFaltasEnd = document.getElementById('absence-end-date').value || null;
                     data.absenceCount = document.getElementById('absence-count').value || null;

                    switch (actionType) {
                        case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                            data.meetingDate = document.getElementById('meeting-date').value || null;
                            data.meetingTime = document.getElementById('meeting-time').value || null;
                            data.contactDate = document.getElementById('contact-date').value || null;
                            data.contactPerson = document.getElementById('contact-person').value || null;
                            data.contactReason = document.getElementById('contact-reason').value || null;
                            const contactSucceededRadio = document.querySelector('input[name="contact-succeeded"]:checked');
                            data.contactSucceeded = contactSucceededRadio ? contactSucceededRadio.value : null;
                            const contactReturnedRadio = document.querySelector('input[name="contact-returned"]:checked');
                            data.contactReturned = contactReturnedRadio ? contactReturnedRadio.value : null;
                            break;
                        case 'visita':
                            data.visitAgent = document.getElementById('visit-agent').value || null;
                            data.visitDate = document.getElementById('visit-date').value || null;
                            data.visitContactPerson = document.getElementById('visit-contact-person').value || null;
                            data.visitReason = document.getElementById('visit-reason').value || null;
                            data.visitObs = document.getElementById('visit-obs').value || null;
                             const visitSucceededRadio = document.querySelector('input[name="visit-succeeded"]:checked');
                            data.visitSucceeded = visitSucceededRadio ? visitSucceededRadio.value : null;
                            const visitRadio = document.querySelector('input[name="visit-returned"]:checked');
                            data.visitReturned = visitRadio ? visitRadio.value : null;
                            break;
                        case 'encaminhamento_ct':
                            data.ctSentDate = document.getElementById('ct-sent-date').value || null;
                            data.ctFeedback = document.getElementById('ct-feedback').value || null;
                             const ctRadio = document.querySelector('input[name="ct-returned"]:checked');
                            data.ctReturned = ctRadio ? ctRadio.value : null;
                            break;
                        case 'analise':
                            data.ctParecer = document.getElementById('ct-parecer').value || null;
                            break;
                        default:
                             if (!actionType) {
                                showToast("Por favor, selecione um Tipo de Ação.");
                                return;
                             }
                    }
                } catch (error) {
                    console.error("Erro ao recolher dados do formulário:", error);
                    showToast("Erro interno ao ler os campos do formulário.");
                    return;
                }

                try {
                    const isNewRecord = !id;
                    if (isNewRecord) {
                        const newDocRef = await addRecord('absence', data);
                        data.id = newDocRef.id;
                        state.absences.push(data); // Adicionar localmente para a verificação de retorno funcionar imediatamente
                    } else {
                        await updateRecord('absence', id, data);
                    }
                   
                    showToast(`Ação ${id ? 'atualizada' : 'registada'} com sucesso!`);
                    
                    const studentReturned = (data.actionType.startsWith('tentativa') && data.contactReturned === 'yes') || (data.actionType === 'visita' && data.visitReturned === 'yes');

                    closeModal(dom.absenceModal);

                    if (studentReturned) {
                        setTimeout(() => openAbsenceModalForStudent(student, 'analise'), 350);
                    }

                } catch (error) { 
                    console.error("Erro ao salvar ação:", error); 
                    showToast('Erro ao salvar.'); 
                }
            });

            dom.absencesListDiv.addEventListener('click', (e) => {
                const target = e.target;
                const header = target.closest('.process-header');
                const button = target.closest('button');

                if (header && !button) { 
                     const processId = header.dataset.processId;
                    const content = document.getElementById(`content-${processId}`);
                    const icon = header.querySelector('i.fa-chevron-down');
                    if (content) {
                        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                            content.style.maxHeight = null;
                            icon.classList.remove('rotate-180');
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                             icon.classList.add('rotate-180');
                        }
                    }
                }

                if(button) {
                    const studentId = button.dataset.studentId;
                    if (button.classList.contains('generate-ficha-btn-row')) {
                        e.stopPropagation();
                        const processId = button.dataset.processId;
                        generateAndShowConsolidatedFicha(studentId, processId);
                        return; 
                    }

                    const id = button.dataset.id;
                    if (button.classList.contains('edit-absence-btn')) {
                        const data = state.absences.find(a => a.id === id);
                        const student = state.students.find(s => s.matricula === data.studentId);
                        if (data && student) {
                            openAbsenceModalForStudent(student, data.actionType, data);
                        }
                    }
                    else if (button.classList.contains('delete-absence-btn')) { 
                        state.recordToDelete = { id, type: 'absence' }; 
                        openModal(dom.deleteConfirmModal); 
                    }
                    else if (button.classList.contains('notification-btn')) { 
                        openFichaViewModal(id);
                    } else if (button.classList.contains('send-ct-btn')) {
                        const oficioNumber = prompt("Por favor, insira o número do ofício:");
                        if (oficioNumber) {
                            const action = state.absences.find(a => a.id === id);
                            generateAndShowOficio(action, oficioNumber);
                        }
                    }
                }
            });

            dom.occurrencesListDiv.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.dataset.id;
                if (button.classList.contains('edit-btn')) {
                    const data = state.occurrences.find(o => o.id === id);
                    const student = state.students.find(s => s.matricula === data.studentId);
                    if (data && student) {
                        dom.occurrenceForm.reset();
                        document.getElementById('modal-title').innerText = 'Editar Registro de Ocorrência';
                        document.getElementById('occurrence-id').value = data.id || '';
                        document.getElementById('student-name').value = student.name || '';
                        document.getElementById('student-class').value = student.class || '';
                        document.getElementById('occurrence-date').value = data.date || '';
                        document.getElementById('description').value = data.description || '';
                        document.getElementById('involved').value = data.involved || '';
                        document.getElementById('actions-taken-school').value = data.actionsTakenSchool || '';
                        document.getElementById('actions-taken-family').value = data.actionsTakenFamily || '';
                        document.getElementById('meeting-date-occurrence').value = data.meetingDate || '';
                        document.getElementById('meeting-time-occurrence').value = data.meetingTime || '';
                        openModal(dom.occurrenceModal);
                    }
                }
                else if (button.classList.contains('delete-btn')) { state.recordToDelete = { id, type: 'occurrence' }; openModal(dom.deleteConfirmModal); }
                else if (button.classList.contains('view-btn')) { openNotificationModal(id); }
            });

            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                if (state.recordToDelete) {
                    try { await deleteRecord(state.recordToDelete.type, state.recordToDelete.id); showToast('Registro excluído com sucesso.'); } catch (error) { console.error("Erro ao excluir:", error); showToast('Erro ao excluir.'); } finally { state.recordToDelete = null; closeModal(dom.deleteConfirmModal); }
                }
            });
            
            document.getElementById('create-report-btn').addEventListener('click', () => {
                const selectedStudentId = document.getElementById('student-select').value;
                if (!selectedStudentId) return showToast('Por favor, selecione um aluno.');
                const reportType = dom.reportGeneratorModal.dataset.reportType;
                if (reportType === 'occurrences') generateAndShowReport(selectedStudentId);
                else generateAndShowConsolidatedFicha(selectedStudentId);
                closeModal(dom.reportGeneratorModal);
            });
             document.getElementById('action-type').addEventListener('change', (e) => {
                 const action = e.target.value;
                 document.querySelectorAll('.dynamic-field-group').forEach(group => group.classList.add('hidden'));
                 if (action.startsWith('tentativa')) { 
                     document.getElementById('group-tentativas').classList.remove('hidden');
                     toggleFamilyContactFields(false); // Desabilitar por padrão
                     const radioNo = document.querySelector('input[name="contact-succeeded"][value="no"]');
                     if (radioNo) radioNo.checked = true;
                 } else if (action === 'visita') {
                    document.getElementById('group-visita').classList.remove('hidden');
                    toggleVisitContactFields(false); // Desabilitar por padrão
                    const radioNo = document.querySelector('input[name="visit-succeeded"][value="no"]');
                    if (radioNo) radioNo.checked = true;
                 }
                 else if (action) { 
                     const group = document.getElementById(`group-${action}`); 
                     if (group) group.classList.remove('hidden');
                 }
             });
             
             document.querySelectorAll('input[name="contact-succeeded"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggleFamilyContactFields(e.target.value === 'yes');
                });
            });
            document.querySelectorAll('input[name="visit-succeeded"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggleVisitContactFields(e.target.value === 'yes');
                });
            });

            document.getElementById('manage-students-btn').addEventListener('click', () => {
                renderStudentsList();
                openModal(dom.studentsModal);
            });
            document.getElementById('close-students-modal-btn').addEventListener('click', () => closeModal(dom.studentsModal));
            document.getElementById('upload-csv-btn').addEventListener('click', async () => {
                const fileInput = document.getElementById('csv-file');
                const feedbackDiv = document.getElementById('csv-feedback');
                if (fileInput.files.length === 0) {
                    showToast("Por favor, selecione um ficheiro CSV.");
                    return;
                }
                
                Papa.parse(fileInput.files[0], {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: header => header.toLowerCase().trim().replace(/\s+/g, ''),
                    complete: async (results) => {
                        const requiredHeaders = ['matricula', 'nome', 'turma', 'endereco', 'contato', 'resp1', 'resp2'];
                        const fileHeaders = results.meta.fields;
                        
                        const hasAllHeaders = requiredHeaders.every(h => fileHeaders.includes(h));

                        if (!hasAllHeaders) {
                            feedbackDiv.innerHTML = `<p class="text-red-500">Erro: Faltam colunas. O ficheiro CSV deve conter: matricula, nome, turma, endereco, contato, resp1, resp2.</p>`;
                            return;
                        }

                        const newStudentList = results.data.map(row => ({
                            matricula: row.matricula || '',
                            name: row.nome || '',
                            class: row.turma || '',
                            endereco: row.endereco || '',
                            contato: row.contato || '',
                            resp1: row.resp1 || '',
                            resp2: row.resp2 || ''
                        })).filter(s => s.name && s.matricula);

                        try {
                            await setDoc(getStudentsDocRef(), { list: newStudentList });
                            state.students = newStudentList;
                            renderStudentsList();
                            showToast(`${newStudentList.length} alunos importados com sucesso!`);
                            fileInput.value = '';
                            feedbackDiv.innerHTML = '';
                        } catch(error) {
                            console.error("Erro ao salvar lista de alunos:", error);
                            showToast("Erro ao salvar a nova lista de alunos.");
                        }
                    }
                });
            });

            document.getElementById('student-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('student-id-input').value; // Usando matricula como ID
                const matricula = document.getElementById('student-matricula-input').value.trim();
                const name = document.getElementById('student-name-input').value.trim();
                const studentClass = document.getElementById('student-class-input').value.trim();
                const endereco = document.getElementById('student-endereco-input').value.trim();
                const contato = document.getElementById('student-contato-input').value.trim();
                const resp1 = document.getElementById('student-resp1-input').value.trim();
                const resp2 = document.getElementById('student-resp2-input').value.trim();

                if (!matricula || !name || !studentClass || !resp1) {
                    showToast("Matrícula, Nome, Turma e Responsável 1 são obrigatórios.");
                    return;
                }
                
                const studentData = { matricula, name, class: studentClass, endereco, contato, resp1, resp2 };
                
                let updatedList = [...state.students];

                if (id) { // Editando
                    const index = updatedList.findIndex(s => s.matricula === id);
                    if (index > -1) {
                        updatedList[index] = studentData;
                    }
                } else { // Adicionando
                     if (updatedList.some(s => s.matricula === matricula)) {
                        showToast("Erro: Matrícula já existe.");
                        return;
                    }
                    updatedList.push(studentData);
                }

                try {
                    await setDoc(getStudentsDocRef(), { list: updatedList });
                    state.students = updatedList;
                    renderStudentsList();
                    resetStudentForm();
                    showToast(`Aluno ${id ? 'atualizado' : 'adicionado'} com sucesso.`);
                } catch(error) {
                    console.error("Erro ao salvar aluno:", error);
                    showToast("Erro ao salvar dados do aluno.");
                }
            });

            document.getElementById('cancel-edit-student-btn').addEventListener('click', resetStudentForm);
        };

        const setupAutocomplete = (inputId, suggestionsId, onSelectCallback) => {
            const input = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(suggestionsId);
            
            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                 if (inputId === 'search-occurrences') state.filterOccurrences = value;
                 if (inputId === 'search-absences') state.filterAbsences = value;
                render();
                suggestionsContainer.innerHTML = '';
                if (!value) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                
                const filteredStudents = state.students.filter(s => s.name.toLowerCase().startsWith(value)).slice(0, 5);
                
                if (filteredStudents.length > 0) {
                    suggestionsContainer.classList.remove('hidden');
                    filteredStudents.forEach(student => {
                        const item = document.createElement('div');
                        item.classList.add('suggestion-item');
                        item.textContent = student.name;
                        item.addEventListener('click', () => {
                            if (onSelectCallback) {
                                onSelectCallback(student);
                            } 
                            input.value = '';
                            if (inputId === 'search-occurrences') state.filterOccurrences = '';
                            if (inputId === 'search-absences') state.filterAbsences = '';
                            render();
                            suggestionsContainer.classList.add('hidden');
                        });
                        suggestionsContainer.appendChild(item);
                    });
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });

             document.addEventListener('click', (e) => {
                if (!suggestionsContainer.contains(e.target) && e.target !== input) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        };

        const renderStudentsList = () => {
            const tableBody = document.getElementById('students-list-table');
            tableBody.innerHTML = '';
            state.students.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900">${student.name}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${student.class}</td>
                    <td class="px-4 py-2 text-right text-sm space-x-2">
                        <button class="edit-student-btn text-yellow-600 hover:text-yellow-900" data-id="${student.matricula}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-student-btn text-red-600 hover:text-red-900" data-id="${student.matricula}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-student-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const student = state.students.find(s => s.matricula === id);
                    if (student) {
                        document.getElementById('student-form-title').textContent = 'Editar Aluno';
                        document.getElementById('student-id-input').value = student.matricula;
                        document.getElementById('student-matricula-input').value = student.matricula;
                        document.getElementById('student-matricula-input').readOnly = true;
                        document.getElementById('student-matricula-input').classList.add('bg-gray-100');
                        document.getElementById('student-name-input').value = student.name;
                        document.getElementById('student-class-input').value = student.class;
                        document.getElementById('student-endereco-input').value = student.endereco || '';
                        document.getElementById('student-contato-input').value = student.contato || '';
                        document.getElementById('student-resp1-input').value = student.resp1;
                        document.getElementById('student-resp2-input').value = student.resp2;
                        document.getElementById('cancel-edit-student-btn').classList.remove('hidden');
                    }
                });
            });

             document.querySelectorAll('.delete-student-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const student = state.students.find(s => s.matricula === id);
                    if (student && confirm(`Tem a certeza que quer remover o aluno "${student.name}"?`)) {
                        const updatedList = state.students.filter(s => s.matricula !== id);
                        try {
                            await setDoc(getStudentsDocRef(), { list: updatedList });
                            state.students = updatedList;
                            renderStudentsList();
                            showToast("Aluno removido com sucesso.");
                        } catch(error) {
                            console.error("Erro ao remover aluno:", error);
                            showToast("Erro ao remover aluno.");
                        }
                    }
                });
            });
        };
        
        const resetStudentForm = () => {
            document.getElementById('student-form-title').textContent = 'Adicionar Novo Aluno';
            document.getElementById('student-form').reset();
            document.getElementById('student-id-input').value = '';
            document.getElementById('student-matricula-input').readOnly = false;
            document.getElementById('student-matricula-input').classList.remove('bg-gray-100');
            document.getElementById('cancel-edit-student-btn').classList.add('hidden');
        };
        
        const showLoginView = () => {
            dom.registerView.classList.add('hidden');
            dom.loginView.classList.remove('hidden');
        };

        const showRegisterView = () => {
            dom.loginView.classList.add('hidden');
            dom.registerView.classList.remove('hidden');
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const finalConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') 
                ? JSON.parse(__firebase_config) 
                : firebaseConfig;

            if (Object.keys(finalConfig).length < 2) {
                 document.body.innerHTML = `<div class="p-8 text-center text-red-700 bg-red-100"><h1>Configuração Incompleta do Firebase</h1><p class="mt-2">A configuração do Firebase não foi encontrada no ambiente. A aplicação não pode ser iniciada.</p></div>`;
                return;
            }

            const app = initializeApp(finalConfig);
            const auth = getAuth(app);
            state.db = getFirestore(app);

            onAuthStateChanged(auth, async user => {
                detachFirestoreListeners();
                if (user) {
                    state.userId = user.uid;
                    dom.userEmail.textContent = user.email || `Utilizador: ${user.uid.substring(0, 8)}`;
                    dom.loginScreen.classList.add('hidden');
                    dom.mainContent.classList.remove('hidden');
                    dom.userProfile.classList.remove('hidden');
                    await setupFirestoreListeners();
                } else {
                    state.userId = null;
                    state.students = [];
                    state.occurrences = [];
                    state.absences = [];
                    render();
                    dom.mainContent.classList.add('hidden');
                    dom.userProfile.classList.add('hidden');
                    dom.loginScreen.classList.remove('hidden');
                }
            });

            dom.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Erro ao entrar:", error.code);
                    showToast("Email ou senha inválidos.");
                }
            });

            dom.registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Erro ao registar:", error.code);
                     if (error.code === 'auth/email-already-in-use') {
                        showToast("Este email já está a ser utilizado.");
                    } else if (error.code === 'auth/weak-password') {
                        showToast("A sua senha é muito fraca.");
                    } else {
                        showToast("Erro ao criar a conta.");
                    }
                }
            });

            dom.logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Erro ao sair:", error);
                }
            });

            setupEventListeners();
            
            setupAutocomplete('search-occurrences', 'occurrence-student-suggestions', (student) => {
                dom.occurrenceForm.reset();
                document.getElementById('occurrence-id').value = '';
                document.getElementById('modal-title').innerText = 'Registar Nova Ocorrência';
                document.getElementById('student-name').value = student.name;
                document.getElementById('student-class').value = student.class;
                document.getElementById('occurrence-date').valueAsDate = new Date();
                openModal(dom.occurrenceModal);
            }); 

            setupAutocomplete('search-absences', 'absence-student-suggestions', (student) => {
                openAbsenceModalForStudent(student);
            });
        });
    </script>
</body>
</html>

