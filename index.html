<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Acompanhamento Pedagógico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .dynamic-field-group {
            border-left: 2px solid #e5e7eb;
            padding-left: 1rem;
            margin-top: 1rem;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        @media print {
            body > div:not(.printable-area) {
                display: none;
            }
            .printable-area, .printable-area .modal-content {
                display: block !important;
                position: static !important;
                width: 100%;
                height: auto;
                max-height: none;
                box-shadow: none;
                border: none;
                transform: none !important;
                background-color: white !important;
            }
            .printable-area .overflow-y-auto {
                overflow: visible !important;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md text-center">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Sistema Pedagógico</h1>
                <p class="text-gray-500 mb-8">Faça login para aceder aos seus registos.</p>
                <button id="google-login-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 transition duration-300 flex items-center justify-center">
                    <img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png" alt="Google logo" class="h-6 mr-3">
                    Entrar com o Google
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-6">A autenticação garante que os seus dados fiquem guardados e sincronizados de forma segura.</p>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Cabeçalho -->
            <header class="mb-8 p-6 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Sistema de Acompanhamento Pedagógico</h1>
                    <p class="opacity-90 mt-1">Gerencie ocorrências e registros de busca ativa de forma centralizada e segura.</p>
                </div>
                <div id="user-profile" class="flex items-center space-x-4 hidden">
                    <img id="user-photo" class="h-12 w-12 rounded-full border-2 border-white/50" src="" alt="User photo">
                    <div class="text-right">
                        <p id="user-name" class="font-semibold"></p>
                        <button id="logout-btn" class="text-sm text-indigo-200 hover:text-white transition">Sair</button>
                    </div>
                </div>
            </header>

            <!-- Abas de Navegação -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="tab-occurrences" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Ocorrências Disciplinares
                    </button>
                    <button id="tab-absences" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-user-clock mr-2"></i>Busca Ativa (Faltas)
                    </button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div id="tab-content-occurrences">
                 <div class="mb-6 flex flex-wrap gap-4 justify-between items-center">
                    <h2 class="text-2xl font-semibold text-gray-700">Registros de Ocorrências</h2>
                    <div class="flex gap-4 flex-wrap">
                        <button id="generate-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300">
                            <i class="fas fa-file-invoice mr-2"></i>Gerar Relatório
                        </button>
                        <button id="add-occurrence-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300">
                            <i class="fas fa-plus mr-2"></i>Nova Ocorrência
                        </button>
                    </div>
                </div>
                <main class="bg-white rounded-lg shadow-md p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-occurrences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar por nome do aluno...">
                        </div>
                    </div>
                    <div id="loading-occurrences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">Carregando registros...</p>
                    </div>
                    <div id="empty-state-occurrences" class="text-center p-8 hidden">
                        <i class="fas fa-file-alt fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ocorrência registrada</h3>
                        <p class="text-gray-500 mt-1">Clique em "Nova Ocorrência" para começar.</p>
                    </div>
                    <div id="occurrences-list" class="overflow-x-auto"></div>
                </main>
            </div>

            <div id="tab-content-absences" class="hidden">
                <div class="mb-6 flex flex-wrap gap-4 justify-between items-center">
                    <h2 class="text-2xl font-semibold text-gray-700">Histórico de Ações da Busca Ativa</h2>
                    <div class="flex gap-4 flex-wrap">
                        <button id="generate-ficha-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300">
                            <i class="fas fa-file-invoice mr-2"></i>Gerar Ficha Consolidada
                        </button>
                         <button id="add-absence-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-300">
                            <i class="fas fa-plus mr-2"></i>Registrar Ação
                        </button>
                    </div>
                </div>
                 <main class="bg-white rounded-lg shadow-md p-6">
                    <div class="mb-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            <input type="text" id="search-absences" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar por nome do aluno...">
                        </div>
                    </div>
                    <div id="loading-absences" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i>
                        <p class="mt-2 text-gray-500">Carregando registros...</p>
                    </div>
                    <div id="empty-state-absences" class="text-center p-8 hidden">
                        <i class="fas fa-folder-open fa-3x text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600">Nenhuma ação de busca ativa registrada</h3>
                        <p class="text-gray-500 mt-1">Clique em "Registrar Ação" para começar.</p>
                    </div>
                    <div id="absences-list" class="overflow-x-auto"></div>
                </main>
            </div>
            
            <footer class="text-center text-sm text-gray-400 mt-8">
                <p>Desenvolvido para Gestão Pedagógica</p>
            </footer>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Ocorrência -->
    <div id="occurrence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold">Registrar Nova Ocorrência</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="occurrence-form" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="occurrence-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700">Turma</label>
                        <input type="text" id="student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
                <div>
                    <label for="occurrence-date" class="block text-sm font-medium text-gray-700">Data da Ocorrência</label>
                    <input type="date" id="occurrence-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição da Ocorrência</label>
                    <textarea id="description" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                </div>
                <div>
                    <label for="involved" class="block text-sm font-medium text-gray-700">Pessoas Envolvidas</label>
                    <input type="text" id="involved" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Outros alunos, professores...">
                </div>
                <div>
                    <label for="actions-taken-school" class="block text-sm font-medium text-gray-700">Providências da Escola</label>
                    <textarea id="actions-taken-school" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Conversa com o aluno, contato com os pais..."></textarea>
                </div>
                <div>
                    <label for="actions-taken-family" class="block text-sm font-medium text-gray-700">Providências da Família</label>
                    <textarea id="actions-taken-family" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Acompanhamento, diálogo..."></textarea>
                </div>
                <div class="pt-4 border-t">
                    <h4 class="text-md font-semibold text-gray-600">Convocação para Reunião (Opcional)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="meeting-date-occurrence" class="block text-sm font-medium text-gray-700">Data do Comparecimento</label>
                            <input type="date" id="meeting-date-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="meeting-time-occurrence" class="block text-sm font-medium text-gray-700">Horário do Comparecimento</label>
                            <input type="time" id="meeting-time-occurrence" class="mt-1 w-full border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>
    <div id="absence-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95 opacity-0 max-h-[95vh] flex flex-col">
            <div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="absence-modal-title" class="text-xl font-semibold">Registrar Ação de Busca Ativa</h3>
                <button id="close-absence-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="absence-form" class="p-6 space-y-6 overflow-y-auto">
                <input type="hidden" id="absence-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="absence-student-name" class="block text-sm font-medium text-gray-700">Nome do Aluno(a)</label>
                        <input type="text" id="absence-student-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required list="student-names-datalist">
                        <datalist id="student-names-datalist"></datalist>
                    </div>
                     <div>
                        <label for="absence-student-class" class="block text-sm font-medium text-gray-700">Ano/Ciclo</label>
                        <input type="text" id="absence-student-class" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div>
                    <label for="action-type" class="block text-sm font-medium text-gray-700">Tipo de Ação</label>
                    <select id="action-type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                        <option value="">Selecione...</option>
                        <option value="tentativa_1">1ª Tentativa de Contato</option>
                        <option value="tentativa_2">2ª Tentativa de Contato</option>
                        <option value="tentativa_3">3ª Tentativa de Contato</option>
                        <option value="visita">Visita In Loco</option>
                        <option value="encaminhamento_ct">Encaminhamento ao Conselho Tutelar</option>
                        <option value="devolutiva_ct">Devolutiva do C.T. / Parecer Final</option>
                    </select>
                </div>
                <div id="dynamic-fields-container" class="space-y-4">
                    <div id="group-tentativas" class="dynamic-field-group hidden space-y-4">
                         <div><label for="contact-absence-period" class="block text-sm">Período das Faltas</label><input type="text" id="contact-absence-period" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label for="absence-count" class="block text-sm">Nº de Faltas no Período</label><input type="number" id="absence-count" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label for="meeting-date" class="block text-sm">Data do Comparecimento</label><input type="date" id="meeting-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                            <div><label for="meeting-time" class="block text-sm">Horário do Comparecimento</label><input type="time" id="meeting-time" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        </div>
                        <div><label class="block text-sm">Dia do Contato:</label><input type="date" id="contact-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Com quem falou?</label><input type="text" id="contact-person" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Justificativa:</label><textarea id="contact-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                    </div>
                    <div id="group-visita" class="dynamic-field-group hidden space-y-4">
                        <div><label for="visit-absence-period" class="block text-sm">Período das Faltas</label><input type="text" id="visit-absence-period" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label for="visit-absence-count" class="block text-sm">Nº de Faltas no Período</label><input type="number" id="visit-absence-count" class="mt-1 block w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Nome do agente da visita:</label><input type="text" id="visit-agent" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Dia da visita:</label><input type="date" id="visit-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm">Nome e justificativa do responsável:</label><textarea id="visit-reason" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                        <div><label class="block text-sm">Observações:</label><textarea id="visit-obs" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                        <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="visit-returned" value="yes"> Sim</label> <label><input type="radio" name="visit-returned" value="no"> Não</label></div></div>
                    </div>
                    <div id="group-encaminhamento_ct" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Data do envio ao C.T.:</label><input type="date" id="ct-sent-date" class="mt-1 w-full border-gray-300 rounded-md"></div>
                    </div>
                    <div id="group-devolutiva_ct" class="dynamic-field-group hidden space-y-4">
                        <div><label class="block text-sm">Devolutiva do C.T.:</label><textarea id="ct-feedback" rows="2" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                        <div><span class="block text-sm">Estudante retornou?</span><div class="mt-2 space-x-4"><label><input type="radio" name="ct-returned" value="yes"> Sim</label> <label><input type="radio" name="ct-returned" value="no"> Não</label></div></div>
                        <div><label class="block text-sm">Parecer da Busca Ativa Escolar (BAE):</label><textarea id="ct-parecer" rows="3" class="mt-1 w-full border-gray-300 rounded-md"></textarea></div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3 bg-white sticky bottom-0 pb-6 -mx-6 px-6 border-t">
                    <button type="button" id="cancel-absence-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition duration-300">Salvar Ação</button>
                </div>
            </form>
        </div>
    </div>
    <div id="notification-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="notification-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="notification-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="notification-title" class="text-xl font-semibold">Notificação de Ocorrência</h3><button id="close-notification-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="notification-content" class="p-8 overflow-y-auto bg-white"></div><div id="notification-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="whatsapp-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fab fa-whatsapp mr-2"></i>Enviar</button><button id="print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="report-generator-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center"><h3 id="report-generator-title" class="text-xl font-semibold">Gerar Relatório por Aluno</h3><button id="close-report-generator-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div class="p-6 space-y-4"><div><label for="student-select" class="block text-sm font-medium text-gray-700">Selecione o Aluno(a)</label><select id="student-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"><option value="">Carregando...</option></select></div></div><div class="bg-gray-50 p-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" id="cancel-report-generator-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button><button type="button" id="create-report-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300">Gerar</button></div></div></div>
    <div id="report-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="report-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="report-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="report-view-title" class="text-xl font-semibold">Relatório</h3><button id="close-report-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="report-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="report-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="report-whatsapp-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fab fa-whatsapp mr-2"></i>Enviar</button><button id="report-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="ficha-view-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0 printable-area"><div id="ficha-view-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 opacity-0 flex flex-col max-h-[90vh]"><div id="ficha-view-header" class="bg-gray-100 p-4 rounded-t-lg flex justify-between items-center flex-shrink-0 no-print"><h3 id="ficha-view-title" class="text-xl font-semibold">Visualizar Documento</h3><button id="close-ficha-view-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="ficha-view-content" class="p-8 overflow-y-auto bg-white"></div><div id="ficha-view-actions" class="p-4 bg-gray-50 rounded-b-lg flex justify-end space-x-3 flex-shrink-0 no-print"><button id="ficha-whatsapp-share-btn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition duration-300"><i class="fab fa-whatsapp mr-2"></i>Enviar</button><button id="ficha-print-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 opacity-0"><div class="p-6"><div class="text-center"><i class="fas fa-exclamation-triangle fa-3x text-red-500 mb-4"></i><h3 class="text-lg font-semibold text-gray-800">Confirmar Exclusão</h3><p class="mt-2 text-sm text-gray-500">Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.</p></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg"><button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Excluir</button><button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></div></div>
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 z-50"><p id="toast-message"></p></div>

    <!-- Firebase and App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ************************************************************************************
        // CONFIGURAÇÃO DO FIREBASE
        // ************************************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyCDWtwnD_3V9En9qEEYtlP_dpOTvt-P9ks",
            authDomain: "acompanhamento-vida-escolar.firebaseapp.com",
            projectId: "acompanhamento-vida-escolar",
            storageBucket: "acompanhamento-vida-escolar.appspot.com",
            messagingSenderId: "315669308837",
            appId: "1:315669308837:web:053497df9ceea4df5c4c9c"
        };
        // ************************************************************************************

        const config = {
            schoolName: "Nome da Escola (Exemplo)",
            city: "Cidade (Exemplo)"
        };

        const state = {
            occurrences: [],
            absences: [],
            filterOccurrences: '',
            filterAbsences: '',
            activeTab: 'occurrences',
            recordToDelete: null,
            db: null,
            userId: null,
            unsubscribeOccurrences: null,
            unsubscribeAbsences: null
        };

        const dom = {
            loginScreen: document.getElementById('login-screen'),
            mainContent: document.getElementById('main-content'),
            googleLoginBtn: document.getElementById('google-login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userProfile: document.getElementById('user-profile'),
            userName: document.getElementById('user-name'),
            userPhoto: document.getElementById('user-photo'),
            occurrenceModal: document.getElementById('occurrence-modal'),
            absenceModal: document.getElementById('absence-modal'),
            notificationModalBackdrop: document.getElementById('notification-modal-backdrop'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            reportGeneratorModal: document.getElementById('report-generator-modal'),
            reportViewModalBackdrop: document.getElementById('report-view-modal-backdrop'),
            fichaViewModalBackdrop: document.getElementById('ficha-view-modal-backdrop'),
            occurrencesListDiv: document.getElementById('occurrences-list'),
            absencesListDiv: document.getElementById('absences-list'),
            emptyStateOccurrences: document.getElementById('empty-state-occurrences'),
            emptyStateAbsences: document.getElementById('empty-state-absences'),
            loadingOccurrences: document.getElementById('loading-occurrences'),
            loadingAbsences: document.getElementById('loading-absences'),
            occurrenceForm: document.getElementById('occurrence-form'),
            absenceForm: document.getElementById('absence-form'),
            tabOccurrences: document.getElementById('tab-occurrences'),
            tabAbsences: document.getElementById('tab-absences'),
            tabContentOccurrences: document.getElementById('tab-content-occurrences'),
            tabContentAbsences: document.getElementById('tab-content-absences'),
            searchOccurrences: document.getElementById('search-occurrences'),
            searchAbsences: document.getElementById('search-absences'),
        };

        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
        const formatTime = (timeString) => timeString || '';
        const formatText = (text) => text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'Não informado';
        
        const showToast = (message) => {
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            document.getElementById('toast-notification').classList.add('show');
            setTimeout(() => document.getElementById('toast-notification').classList.remove('show'), 3000);
        };
        
        const openModal = (modalElement) => {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                modalElement.firstElementChild.classList.remove('scale-95', 'opacity-0');
            }, 10);
        };

        const closeModal = (modalElement) => {
            if (!modalElement) return;
            modalElement.classList.add('opacity-0');
            modalElement.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modalElement.classList.add('hidden'), 300);
        };

        const renderOccurrences = () => {
            dom.loadingOccurrences.classList.add('hidden');
            const filtered = state.occurrences
                .filter(o => o.studentName.toLowerCase().includes(state.filterOccurrences.toLowerCase()))
                .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            if (filtered.length === 0) {
                dom.emptyStateOccurrences.classList.remove('hidden');
                dom.occurrencesListDiv.innerHTML = '';
            } else {
                dom.emptyStateOccurrences.classList.add('hidden');
                dom.occurrencesListDiv.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno(a)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Turma</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filtered.map(occ => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${occ.studentName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${occ.studentClass}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(occ.date)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <button class="view-btn text-indigo-600 hover:text-indigo-900" data-id="${occ.id}" title="Ver Notificação"><i class="fas fa-eye"></i></button>
                                        <button class="edit-btn text-yellow-600 hover:text-yellow-900" data-id="${occ.id}" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-btn text-red-600 hover:text-red-900" data-id="${occ.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            }
        };

        const renderAbsences = () => {
            dom.loadingAbsences.classList.add('hidden');
            const actionTitles = {
                tentativa_1: "1ª Tentativa", tentativa_2: "2ª Tentativa", tentativa_3: "3ª Tentativa",
                visita: "Visita In Loco", encaminhamento_ct: "Encaminhamento C.T.", devolutiva_ct: "Devolutiva C.T."
            };
            const filtered = state.absences
                .filter(a => a.studentName.toLowerCase().includes(state.filterAbsences.toLowerCase()))
                .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            if (filtered.length === 0) {
                dom.emptyStateAbsences.classList.remove('hidden');
                dom.absencesListDiv.innerHTML = '';
            } else {
                dom.emptyStateAbsences.classList.add('hidden');
                dom.absencesListDiv.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno(a)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo de Ação</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data da Ação</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filtered.map(abs => {
                                const actionDate = abs.contactDate || abs.visitDate || abs.ctSentDate || (abs.createdAt && abs.createdAt.toDate().toISOString().split('T')[0]);
                                return `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${abs.studentName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${actionTitles[abs.actionType] || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(actionDate)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button class="view-absence-btn text-indigo-600 hover:text-indigo-900" data-id="${abs.id}" title="Ver Ação"><i class="fas fa-eye"></i></button>
                                            <button class="edit-absence-btn text-yellow-600 hover:text-yellow-900" data-id="${abs.id}" title="Editar Ação"><i class="fas fa-pencil-alt"></i></button>
                                            <button class="delete-absence-btn text-red-600 hover:text-red-900" data-id="${abs.id}" title="Excluir Ação"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>`;
                            }).join('')}
                        </tbody>
                    </table>`;
            }
        };

        const render = () => {
            if (state.activeTab === 'occurrences') renderOccurrences();
            else renderAbsences();
        };

        const getCollectionRef = (type) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionName = type === 'occurrence' ? 'occurrences' : 'absences';
            if (!state.userId) throw new Error("Usuário não autenticado.");
            return collection(state.db, `/artifacts/${appId}/users/${state.userId}/${collectionName}`);
        };
        const addRecord = (type, data) => addDoc(getCollectionRef(type), { ...data, createdAt: serverTimestamp() });
        const updateRecord = (type, id, data) => setDoc(doc(getCollectionRef(type), id), data, { merge: true });
        const deleteRecord = (type, id) => deleteDoc(doc(getCollectionRef(type), id));

        const setupFirestoreListeners = () => {
            if (state.unsubscribeOccurrences) state.unsubscribeOccurrences();
            state.unsubscribeOccurrences = onSnapshot(query(getCollectionRef('occurrence')), (snapshot) => {
                state.occurrences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'occurrences') render();
            }, (error) => console.error("Erro ao buscar ocorrências:", error));

            if (state.unsubscribeAbsences) state.unsubscribeAbsences();
            state.unsubscribeAbsences = onSnapshot(query(getCollectionRef('absence')), (snapshot) => {
                state.absences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'absences') render();
            }, (error) => console.error("Erro ao buscar ações:", error));
        };

        const detachFirestoreListeners = () => {
            if (state.unsubscribeOccurrences) {
                state.unsubscribeOccurrences();
                state.unsubscribeOccurrences = null;
            }
            if (state.unsubscribeAbsences) {
                state.unsubscribeAbsences();
                state.unsubscribeAbsences = null;
            }
        };

        const openNotificationModal = (id) => {
            const data = state.occurrences.find(occ => occ.id === id);
            if (data) {
                document.getElementById('notification-title').innerText = 'Notificação de Ocorrência Escolar';
                document.getElementById('notification-content').innerHTML = `
                    <div class="space-y-6 text-sm"><div class="text-center border-b pb-4"><h2 class="text-xl font-bold uppercase">${config.schoolName}</h2><h3 class="text-lg font-semibold mt-2">NOTIFICAÇÃO DE OCORRÊNCIA ESCOLAR</h3></div>
                    <div class="pt-4"><p class="mb-2"><strong>Aos Pais e/ou Responsáveis pelo(a) aluno(a):</strong></p><p class="text-lg font-semibold">${formatText(data.studentName)}</p><p class="text-gray-600"><strong>Turma:</strong> ${formatText(data.studentClass)}</p></div>
                    <p class="text-justify">Prezados(as), vimos por meio desta notificá-los sobre uma ocorrência disciplinar envolvendo o(a) aluno(a) supracitado(a), registrada em <strong>${formatDate(data.date)}</strong>.</p>
                    <div class="border-t pt-4 space-y-4">
                        <div><h4 class="font-semibold mb-1">Descrição:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.description)}</p></div>
                        <div><h4 class="font-semibold mb-1">Pessoas Envolvidas:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.involved)}</p></div>
                        <div><h4 class="font-semibold mb-1">Providências da Escola:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.actionsTakenSchool)}</p></div>
                        <div><h4 class="font-semibold mb-1">Providências da Família:</h4><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(data.actionsTakenFamily)}</p></div>
                    </div>
                    <p class="mt-4 text-justify">Diante do exposto, solicitamos o comparecimento de um responsável na coordenação pedagógica para uma reunião na seguinte data e horário:</p>
                    <div class="mt-4 p-3 bg-indigo-100 text-indigo-800 rounded-md text-center font-semibold"><p><strong>Data:</strong> ${formatDate(data.meetingDate) || 'A ser agendada'}</p><p><strong>Horário:</strong> ${formatTime(data.meetingTime) || ''}</p></div>
                    <div class="border-t pt-16 mt-16"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="text-center mt-1">Ciente do Responsável</p></div></div></div>`;
                openModal(dom.notificationModalBackdrop);
            }
        };
        
        const openFichaViewModal = (id) => {
            const record = state.absences.find(abs => abs.id === id);
            if (!record) return showToast('Registro não encontrado.');
            
            const attemptLabels = { tentativa_1: "primeira", tentativa_2: "segunda", tentativa_3: "terceira" };
            const actionTitles = { tentativa_1: "Notificação de Frequência Escolar", tentativa_2: "Notificação de Frequência Escolar", tentativa_3: "Notificação de Frequência Escolar", visita: "Notificação de Visita Domiciliar", encaminhamento_ct: "Comprovante de Encaminhamento ao C.T.", devolutiva_ct: "Registro de Devolutiva do C.T." };
            const title = actionTitles[record.actionType] || 'Notificação de Busca Ativa';
            
            let body = '';
            switch (record.actionType) {
                case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                    body = `<p class="mt-4 text-justify">Vimos por meio desta notificá-los que o(a) estudante acumulou <strong>${formatText(record.absenceCount)} faltas</strong> no período de <strong>${formatText(record.periodoFaltas)}</strong>.</p><p class="mt-4 text-justify">Esta é a <strong>${attemptLabels[record.actionType]} tentativa de contato</strong>. Solicitamos o comparecimento de um responsável na data e horário abaixo:</p><div class="mt-4 p-3 bg-gray-100 rounded-md text-center"><p><strong>Data:</strong> ${formatDate(record.meetingDate)}</p><p><strong>Horário:</strong> ${formatTime(record.meetingTime)}</p></div>`;
                    break;
                case 'visita':
                    body = `<p class="mt-4">Notificamos que na data de <strong>${formatDate(record.visitDate)}</strong>, o agente escolar <strong>${formatText(record.visitAgent)}</strong> realizou uma visita domiciliar.</p><p class="mt-2"><strong>Justificativa do responsável:</strong> ${formatText(record.visitReason)}</p>`;
                    break;
                default: body = `<p class="mt-4">Registro de ação administrativa referente à busca ativa do(a) aluno(a).</p>`; break;
            }

            const contentHTML = `<div class="space-y-6 text-sm text-gray-800"><div class="text-center border-b pb-4"><h2 class="text-lg font-bold uppercase">${config.schoolName}</h2><h3 class="font-semibold mt-1 uppercase">${title}</h3></div><div class="pt-4"><p><strong>Aluno(a):</strong> ${record.studentName}</p><p><strong>Turma:</strong> ${record.studentClass || ''}</p></div><div class="text-justify">${body}</div><div class="border-t pt-16 mt-16"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="text-center mt-1">Ciente do Responsável</p></div></div></div>`;

            document.getElementById('ficha-view-title').textContent = title;
            document.getElementById('ficha-view-content').innerHTML = contentHTML;
            openModal(dom.fichaViewModalBackdrop);
        };
        
        const openReportGeneratorModal = (reportType) => {
            const records = reportType === 'occurrences' ? state.occurrences : state.absences;
            const students = [...new Set(records.map(item => item.studentName))].sort();
            const select = document.getElementById('student-select');
            
            const title = reportType === 'occurrences' ? 'Gerar Relatório de Ocorrências' : 'Gerar Ficha Consolidada';
            document.getElementById('report-generator-title').textContent = title;
            dom.reportGeneratorModal.dataset.reportType = reportType;
            
            select.innerHTML = students.length > 0
                ? '<option value="">Selecione um aluno...</option>' + students.map(s => `<option value="${s}">${s}</option>`).join('')
                : '<option value="">Nenhum aluno com registros</option>';
            openModal(dom.reportGeneratorModal);
        };
        
        const generateAndShowReport = (studentName) => {
            const studentOccurrences = state.occurrences.filter(occ => occ.studentName === studentName).sort((a, b) => new Date(a.date) - new Date(b.date));
            if (studentOccurrences.length === 0) return showToast('Nenhuma ocorrência para este aluno.');

            const studentData = studentOccurrences[0];
            const currentDate = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

            const reportHTML = `<div class="space-y-6 text-sm"><div class="text-center border-b pb-4"><h2 class="text-xl font-bold uppercase">${config.schoolName}</h2><h3 class="text-lg font-semibold mt-2">RELATÓRIO DE OCORRÊNCIAS</h3></div><div class="pt-4 text-left"><p><strong>ALUNO(A):</strong> ${studentName}</p><p><strong>TURMA:</strong> ${studentData.studentClass}</p><p><strong>DATA:</strong> ${currentDate}</p></div>${studentOccurrences.map((occ, index) => `<div class="border-t pt-4 mt-4"><h4 class="font-semibold mb-2 text-base">OCORRÊNCIA ${index + 1} - Data: ${formatDate(occ.date)}</h4><div class="pl-4 border-l-2 border-gray-200 space-y-2"><div><p class="font-medium">Descrição:</p><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(occ.description)}</p></div><div><p class="font-medium">Providências da Escola:</p><p class="text-gray-700 bg-gray-50 p-2 rounded-md whitespace-pre-wrap">${formatText(occ.actionsTakenSchool)}</p></div></div></div>`).join('')}<div class="border-t pt-16 mt-8"><div class="text-center w-2/3 mx-auto"><div class="border-t border-gray-400"></div><p class="mt-1">Assinatura da Coordenação</p></div></div></div>`;
            
            document.getElementById('report-view-title').textContent = "Relatório de Ocorrências";
            document.getElementById('report-view-content').innerHTML = reportHTML;
            openModal(dom.reportViewModalBackdrop);
        };
        
        const generateAndShowConsolidatedFicha = (studentName) => {
            const studentActions = state.absences.filter(action => action.studentName === studentName).sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());
            if (studentActions.length === 0) return showToast('Nenhuma ação para este aluno.');

            const findAction = (type) => studentActions.find(a => a.actionType === type) || {};
            const t1 = findAction('tentativa_1'), t2 = findAction('tentativa_2'), t3 = findAction('tentativa_3'), visita = findAction('visita'), ct = findAction('encaminhamento_ct'), dev = findAction('devolutiva_ct');

            const fichaHTML = `<div class="space-y-4 text-sm"><div class="text-center border-b pb-4"><h2 class="text-lg font-bold uppercase">${config.schoolName}</h2><h3 class="font-semibold mt-1">Ficha de Acompanhamento da Busca Ativa</h3></div><div class="border rounded-md p-3"><p><strong>Nome:</strong> ${studentName}</p><p><strong>Ano/Ciclo:</strong> ${studentActions[0]?.studentClass || ''}</p></div><div class="border rounded-md p-3 space-y-3"><h4 class="font-semibold text-base">1) Contato com Responsável</h4><div class="pl-4"><p><strong>1º Contato:</strong> Dia ${formatDate(t1.contactDate)}</p><p><strong>Justificativa:</strong> ${formatText(t1.contactReason)}</p></div><div class="pl-4 border-t pt-2"><p><strong>2º Contato:</strong> Dia ${formatDate(t2.contactDate)}</p><p><strong>Justificativa:</strong> ${formatText(t2.contactReason)}</p></div><div class="pl-4 border-t pt-2"><p><strong>3º Contato:</strong> Dia ${formatDate(t3.contactDate)}</p><p><strong>Justificativa:</strong> ${formatText(t3.contactReason)}</p></div></div><div class="border rounded-md p-3 space-y-2"><h4 class="font-semibold text-base">2) Visita / Contato In Loco</h4><p><strong>Dia:</strong> ${formatDate(visita.visitDate)}</p><p><strong>Justificativa:</strong> ${formatText(visita.visitReason)}</p><p><strong>Retornou?</strong> ${visita.visitReturned === 'yes' ? 'Sim' : visita.visitReturned === 'no' ? 'Não' : ''}</p></div><div class="border rounded-md p-3 space-y-2"><h4 class="font-semibold text-base">3) Encaminhamento ao Conselho Tutelar</h4><p><strong>Data do envio:</strong> ${formatDate(ct.ctSentDate)}</p><p><strong>Devolutiva:</strong> ${formatText(dev.ctFeedback)}</p><p><strong>Retornou?</strong> ${dev.ctReturned === 'yes' ? 'Sim' : dev.ctReturned === 'no' ? 'Não' : ''}</p><p><strong>Parecer BAE:</strong> ${formatText(dev.ctParecer)}</p></div></div>`;
            document.getElementById('report-view-title').textContent = "Ficha Consolidada de Busca Ativa";
            document.getElementById('report-view-content').innerHTML = fichaHTML;
            openModal(dom.reportViewModalBackdrop);
        };
        
        const setupEventListeners = () => {
            dom.tabOccurrences.addEventListener('click', () => { state.activeTab = 'occurrences'; dom.tabOccurrences.classList.add('tab-active'); dom.tabAbsences.classList.remove('tab-active'); dom.tabContentOccurrences.classList.remove('hidden'); dom.tabContentAbsences.classList.add('hidden'); render(); });
            dom.tabAbsences.addEventListener('click', () => { state.activeTab = 'absences'; dom.tabAbsences.classList.add('tab-active'); dom.tabOccurrences.classList.remove('tab-active'); dom.tabContentAbsences.classList.remove('hidden'); dom.tabContentOccurrences.classList.add('hidden'); render(); });
            dom.searchOccurrences.addEventListener('input', (e) => { state.filterOccurrences = e.target.value; render(); });
            dom.searchAbsences.addEventListener('input', (e) => { state.filterAbsences = e.target.value; render(); });
            document.getElementById('add-occurrence-btn').addEventListener('click', () => { dom.occurrenceForm.reset(); document.getElementById('occurrence-id').value = ''; document.getElementById('modal-title').innerText = 'Registrar Nova Ocorrência'; document.getElementById('occurrence-date').valueAsDate = new Date(); openModal(dom.occurrenceModal); });
            document.getElementById('add-absence-btn').addEventListener('click', () => { dom.absenceForm.reset(); document.getElementById('absence-id').value = ''; document.getElementById('absence-modal-title').innerText = 'Registrar Ação de Busca Ativa'; const studentNames = [...new Set([...state.occurrences, ...state.absences].map(item => item.studentName))].sort(); document.getElementById('student-names-datalist').innerHTML = studentNames.map(name => `<option value="${name}"></option>`).join(''); document.getElementById('action-type').dispatchEvent(new Event('change')); openModal(dom.absenceModal); });
            ['close-modal-btn', 'cancel-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.occurrenceModal)));
            ['close-absence-modal-btn', 'cancel-absence-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.absenceModal)));
            ['close-report-generator-btn', 'cancel-report-generator-btn'].forEach(id => document.getElementById(id).addEventListener('click', () => closeModal(dom.reportGeneratorModal)));
            document.getElementById('close-notification-btn').addEventListener('click', () => closeModal(dom.notificationModalBackdrop));
            document.getElementById('close-report-view-btn').addEventListener('click', () => closeModal(dom.reportViewModalBackdrop));
            document.getElementById('close-ficha-view-btn').addEventListener('click', () => closeModal(dom.fichaViewModalBackdrop));
            document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal(dom.deleteConfirmModal));
            document.getElementById('print-btn').addEventListener('click', () => window.print());
            document.getElementById('report-print-btn').addEventListener('click', () => window.print());
            document.getElementById('ficha-print-btn').addEventListener('click', () => window.print());

            dom.occurrenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('occurrence-id').value;
                const data = { studentName: document.getElementById('student-name').value.trim(), studentClass: document.getElementById('student-class').value.trim(), date: document.getElementById('occurrence-date').value, description: document.getElementById('description').value.trim(), involved: document.getElementById('involved').value.trim(), actionsTakenSchool: document.getElementById('actions-taken-school').value.trim(), actionsTakenFamily: document.getElementById('actions-taken-family').value.trim(), meetingDate: document.getElementById('meeting-date-occurrence').value, meetingTime: document.getElementById('meeting-time-occurrence').value };
                try { id ? await updateRecord('occurrence', id, data) : await addRecord('occurrence', data); showToast(`Ocorrência ${id ? 'atualizada' : 'registrada'} com sucesso!`); closeModal(dom.occurrenceModal); } catch (error) { console.error("Erro:", error); showToast('Erro ao salvar.'); }
            });

            dom.absenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('absence-id').value;
                const actionType = document.getElementById('action-type').value;
                const data = { studentName: document.getElementById('absence-student-name').value.trim(), studentClass: document.getElementById('absence-student-class').value.trim(), actionType };
                switch (actionType) {
                    case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                        Object.assign(data, { periodoFaltas: document.getElementById('contact-absence-period').value, absenceCount: document.getElementById('absence-count').value, meetingDate: document.getElementById('meeting-date').value, meetingTime: document.getElementById('meeting-time').value, contactDate: document.getElementById('contact-date').value, contactPerson: document.getElementById('contact-person').value, contactReason: document.getElementById('contact-reason').value });
                        break;
                    case 'visita':
                        Object.assign(data, { periodoFaltas: document.getElementById('visit-absence-period').value, absenceCount: document.getElementById('visit-absence-count').value, visitAgent: document.getElementById('visit-agent').value, visitDate: document.getElementById('visit-date').value, visitReason: document.getElementById('visit-reason').value, visitObs: document.getElementById('visit-obs').value, visitReturned: document.querySelector('input[name="visit-returned"]:checked')?.value || null });
                        break;
                    case 'encaminhamento_ct':
                        data.ctSentDate = document.getElementById('ct-sent-date').value;
                        break;
                    case 'devolutiva_ct':
                        Object.assign(data, { ctFeedback: document.getElementById('ct-feedback').value, ctReturned: document.querySelector('input[name="ct-returned"]:checked')?.value || null, ctParecer: document.getElementById('ct-parecer').value });
                        break;
                }
                try { id ? await updateRecord('absence', id, data) : await addRecord('absence', data); showToast(`Ação ${id ? 'atualizada' : 'registrada'} com sucesso!`); closeModal(dom.absenceModal); } catch (error) { console.error("Erro ao salvar ação:", error); showToast('Erro ao salvar.'); }
            });

            dom.occurrencesListDiv.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.dataset.id;
                if (button.classList.contains('edit-btn')) {
                    const data = state.occurrences.find(o => o.id === id);
                    if (data) {
                        dom.occurrenceForm.reset();
                        document.getElementById('modal-title').innerText = 'Editar Registro de Ocorrência';
                        document.getElementById('occurrence-id').value = data.id || '';
                        document.getElementById('student-name').value = data.studentName || '';
                        document.getElementById('student-class').value = data.studentClass || '';
                        document.getElementById('occurrence-date').value = data.date || '';
                        document.getElementById('description').value = data.description || '';
                        document.getElementById('involved').value = data.involved || '';
                        document.getElementById('actions-taken-school').value = data.actionsTakenSchool || '';
                        document.getElementById('actions-taken-family').value = data.actionsTakenFamily || '';
                        document.getElementById('meeting-date-occurrence').value = data.meetingDate || '';
                        document.getElementById('meeting-time-occurrence').value = data.meetingTime || '';
                        openModal(dom.occurrenceModal);
                    }
                }
                else if (button.classList.contains('delete-btn')) { state.recordToDelete = { id, type: 'occurrence' }; openModal(dom.deleteConfirmModal); }
                else if (button.classList.contains('view-btn')) { openNotificationModal(id); }
            });

            dom.absencesListDiv.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.dataset.id;
                if (button.classList.contains('edit-absence-btn')) {
                    const data = state.absences.find(a => a.id === id);
                    if (data) {
                        dom.absenceForm.reset();
                        document.getElementById('absence-modal-title').innerText = 'Editar Ação de Busca Ativa';
                        const studentNames = [...new Set([...state.occurrences, ...state.absences].map(item => item.studentName))].sort();
                        document.getElementById('student-names-datalist').innerHTML = studentNames.map(name => `<option value="${name}"></option>`).join('');
                        document.getElementById('action-type').value = data.actionType || '';
                        document.getElementById('action-type').dispatchEvent(new Event('change'));
                        document.getElementById('absence-id').value = data.id || '';
                        document.getElementById('absence-student-name').value = data.studentName || '';
                        document.getElementById('absence-student-class').value = data.studentClass || '';
                        switch (data.actionType) {
                            case 'tentativa_1': case 'tentativa_2': case 'tentativa_3':
                                document.getElementById('contact-absence-period').value = data.periodoFaltas || '';
                                document.getElementById('absence-count').value = data.absenceCount || '';
                                document.getElementById('meeting-date').value = data.meetingDate || '';
                                document.getElementById('meeting-time').value = data.meetingTime || '';
                                document.getElementById('contact-date').value = data.contactDate || '';
                                document.getElementById('contact-person').value = data.contactPerson || '';
                                document.getElementById('contact-reason').value = data.contactReason || '';
                                break;
                            case 'visita':
                                document.getElementById('visit-absence-period').value = data.periodoFaltas || '';
                                document.getElementById('visit-absence-count').value = data.absenceCount || '';
                                document.getElementById('visit-agent').value = data.visitAgent || '';
                                document.getElementById('visit-date').value = data.visitDate || '';
                                document.getElementById('visit-reason').value = data.visitReason || '';
                                document.getElementById('visit-obs').value = data.visitObs || '';
                                if (data.visitReturned) document.querySelector(`input[name="visit-returned"][value="${data.visitReturned}"]`).checked = true;
                                break;
                            case 'encaminhamento_ct':
                                document.getElementById('ct-sent-date').value = data.ctSentDate || '';
                                break;
                            case 'devolutiva_ct':
                                document.getElementById('ct-feedback').value = data.ctFeedback || '';
                                if (data.ctReturned) document.querySelector(`input[name="ct-returned"][value="${data.ctReturned}"]`).checked = true;
                                document.getElementById('ct-parecer').value = data.ctParecer || '';
                                break;
                        }
                        openModal(dom.absenceModal);
                    }
                }
                else if (button.classList.contains('delete-absence-btn')) { state.recordToDelete = { id, type: 'absence' }; openModal(dom.deleteConfirmModal); }
                else if (button.classList.contains('view-absence-btn')) { openFichaViewModal(id); }
            });

            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                if (state.recordToDelete) {
                    try { await deleteRecord(state.recordToDelete.type, state.recordToDelete.id); showToast('Registro excluído com sucesso.'); } catch (error) { console.error("Erro ao excluir:", error); showToast('Erro ao excluir.'); } finally { state.recordToDelete = null; closeModal(dom.deleteConfirmModal); }
                }
            });

            document.getElementById('generate-report-btn').addEventListener('click', () => openReportGeneratorModal('occurrences'));
            document.getElementById('generate-ficha-btn').addEventListener('click', () => openReportGeneratorModal('absences'));
            document.getElementById('create-report-btn').addEventListener('click', () => {
                const selectedStudent = document.getElementById('student-select').value;
                if (!selectedStudent) return showToast('Por favor, selecione um aluno.');
                const reportType = dom.reportGeneratorModal.dataset.reportType;
                if (reportType === 'occurrences') generateAndShowReport(selectedStudent);
                else generateAndShowConsolidatedFicha(selectedStudent);
                closeModal(dom.reportGeneratorModal);
            });
             document.getElementById('action-type').addEventListener('change', (e) => {
                 const action = e.target.value;
                 document.querySelectorAll('.dynamic-field-group').forEach(group => group.classList.add('hidden'));
                 if (action.startsWith('tentativa')) { document.getElementById('group-tentativas').classList.remove('hidden'); } 
                 else if (action) { const group = document.getElementById(`group-${action}`); if (group) group.classList.remove('hidden'); }
             });
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const finalConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') 
                ? JSON.parse(__firebase_config) 
                : firebaseConfig;

            if (Object.keys(finalConfig).length < 2) {
                 document.getElementById('app').innerHTML = `<div class="text-center p-8 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg"><h2 class="font-bold text-lg">Configuração Incompleta do Firebase</h2><p class="mt-2">A configuração do Firebase não foi encontrada. Por favor, siga o guia de configuração para obter e colar as chaves do seu projeto Firebase no código.</p></div>`;
                return;
            }

            const app = initializeApp(finalConfig);
            const auth = getAuth(app);
            state.db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                detachFirestoreListeners();
                if (user && !user.isAnonymous) {
                    state.userId = user.uid;
                    dom.userName.textContent = user.displayName;
                    dom.userPhoto.src = user.photoURL;
                    dom.loginScreen.classList.add('hidden');
                    dom.mainContent.classList.remove('hidden');
                    dom.userProfile.classList.remove('hidden');
                    setupFirestoreListeners();
                } else {
                    state.userId = null;
                    state.occurrences = [];
                    state.absences = [];
                    render();
                    dom.mainContent.classList.add('hidden');
                    dom.userProfile.classList.add('hidden');
                    dom.loginScreen.classList.remove('hidden');
                }
            });

            dom.googleLoginBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                await signInWithRedirect(auth, provider);
            });

            getRedirectResult(auth)
                .catch(error => {
                    console.error("Erro durante o redirecionamento do login:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        showToast("Erro: Domínio não autorizado. Verifique a configuração no Firebase.");
                    } else {
                        showToast("Falha no login. Tente novamente.");
                    }
                });


            dom.logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Erro ao sair:", error);
                }
            });

            setupEventListeners();
        });
    </script>
</body>
</html>

